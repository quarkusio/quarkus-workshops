<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Emmanuel Bernard, Clement Escoffier, Antonio Goncalves, Aurea Munoz Hernandez, Georgios Andrianakis, Holly Cummins">
<title>Quarkus Super-Heroes Workshop: 2024-07-17 Quarkus 3.6.0</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<head>

    <meta name="keywords" content="Quarkus, Workshop, Microservice, Kafka">
    <meta name="description" content="A hands on lab about Quarkus">

    <link href="../../assets/css/bootstrap.css" media="screen" rel="stylesheet">
    <link href="../../assets/css/font-awesome.min.css" media="screen" rel="stylesheet">
    <link href="../../assets/css/hol.css" media="screen" rel="stylesheet">
    <link href="../../assets/css/github.css" media="screen" rel="stylesheet">
    <script src="../../assets/js/jquery-3.1.1.js"></script>
    <script src="../../assets/js/bootstrap.js"></script>
    <!-- be aware that only a few languages have been included-->
    <script src="../../assets/js/highlight.pack.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>


    <script>
        $(document).ready(function () {
            hljs.initHighlightingOnLoad();
            $('pre.highlight code').each(function (i, block) {
                hljs.highlightBlock(block);
            });

            var pre = document.getElementsByTagName('pre');
            for (var i = 0; i < pre.length; i++) {
                var b = document.createElement('button');
                b.className = 'clipboard';
                b.textContent = 'Copy';
                if (pre[i].childNodes.length === 1 && pre[i].childNodes[0].nodeType === 3) {
                    var div = document.createElement('div');
                    div.textContent = pre[i].textContent;
                    pre[i].textContent = '';
                    pre[i].appendChild(div);
                }
                pre[i].appendChild(b);
            }
            var clipboard = new ClipboardJS('.clipboard', {
                target: function (b) {
                    var p = b.parentNode;
                    return p.getElementsByClassName("code")[0]
                        ? p.getElementsByClassName("code")[0]
                        : p.childNodes[0];
                }
            });
            clipboard.on('success', function (e) {
                e.clearSelection();
                e.trigger.textContent = 'Copied';
                setTimeout(function () {
                    e.trigger.textContent = 'Copy';
                }, 2000);
            });
        });
    </script>
</head>
<header>
    <img src="../../images/quarkus-logo.png" alt="Quarkus Logo"/>
</header>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Quarkus Super-Heroes Workshop: 2024-07-17 Quarkus 3.6.0</h1>
<div class="details">
<span id="author" class="author">Emmanuel Bernard</span><br>
<span id="author2" class="author">Clement Escoffier</span><br>
<span id="author3" class="author">Antonio Goncalves</span><br>
<span id="author4" class="author">Aurea Munoz Hernandez</span><br>
<span id="author5" class="author">Georgios Andrianakis</span><br>
<span id="author6" class="author">Holly Cummins</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Welcome</a>
<ul class="sectlevel2">
<li><a href="#introduction-presentation">Presenting the Workshop</a>
<ul class="sectlevel3">
<li><a href="#_what_will_you_be_developing">What Will You Be Developing?</a></li>
<li><a href="#_how_does_this_workshop_work">How Does This Workshop Work?</a></li>
<li><a href="#_what_do_you_have_to_do">What Do You Have to Do?</a></li>
<li><a href="#_software_requirements">Software Requirements</a></li>
</ul>
</li>
<li><a href="#introduction-installing">Installing Software</a>
<ul class="sectlevel3">
<li><a href="#introduction-installing-jdk">JDK 17</a></li>
<li><a href="#introduction-installing-docker">Docker or Podman</a></li>
<li><a href="#appendix-installing-jq">jq</a></li>
<li><a href="#introduction-installing-graalvm">GraalVM 22.3</a></li>
<li><a href="#introduction-installing-ai">OpenAI or Azure OpenAI Subscriptions</a></li>
<li><a href="#azure-intro-installing-wsl">WSL</a></li>
<li><a href="#_recap">Recap</a></li>
</ul>
</li>
<li><a href="#introduction-preparing">Preparing for the Workshop</a>
<ul class="sectlevel3">
<li><a href="#_download_the_workshop_scaffolding">Download the workshop scaffolding</a></li>
<li><a href="#introduction-preparing-checking-ports">Checking Ports</a></li>
<li><a href="#_ready">Ready?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#rest">Creating a <em>classical</em> REST/HTTP Microservice</a>
<ul class="sectlevel2">
<li><a href="#rest-bootstrapping">Villain Microservice</a>
<ul class="sectlevel3">
<li><a href="#_bootstrapping_the_villain_rest_endpoint">Bootstrapping the Villain REST Endpoint</a></li>
<li><a href="#_directory_structure">Directory Structure</a></li>
<li><a href="#_the_villain_resource">The Villain Resource</a></li>
<li><a href="#_running_the_application">Running the Application</a></li>
<li><a href="#_development_mode">Development Mode</a></li>
<li><a href="#_testing_the_application">Testing the Application</a></li>
<li><a href="#_packaging_and_running_the_application">Packaging and Running the Application</a></li>
</ul>
</li>
<li><a href="#rest-transaction-orm">Transactions and ORM</a>
<ul class="sectlevel3">
<li><a href="#_directory_structure_2">Directory Structure</a></li>
<li><a href="#_installing_the_postgresql_dependency_hibernate_with_panache_and_hibernate_validator">Installing the PostgreSQL Dependency, Hibernate with Panache and Hibernate Validator</a></li>
<li><a href="#_villain_entity">Villain Entity</a></li>
<li><a href="#_configuring_hibernate">Configuring Hibernate</a></li>
<li><a href="#_villain_service">Villain Service</a></li>
<li><a href="#_accessing_a_database_in_dev_mode">Accessing a database in dev mode</a></li>
<li><a href="#_villainresource_endpoint">VillainResource Endpoint</a></li>
<li><a href="#_dependency_injection">Dependency Injection</a></li>
<li><a href="#_adding_data">Adding Data</a></li>
<li><a href="#_crud_tests_in_villainresourcetest">CRUD Tests in VillainResourceTest</a></li>
<li><a href="#_building_production_package">Building production package</a></li>
</ul>
</li>
<li><a href="#rest-configuration">Configuring the Villain Microservice</a>
<ul class="sectlevel3">
<li><a href="#_configuring_logging">Configuring Logging</a></li>
<li><a href="#_configuring_quarkus_listening_port">Configuring Quarkus Listening Port</a></li>
<li><a href="#_injecting_configuration_value">Injecting Configuration Value</a></li>
<li><a href="#_create_the_configuration">Create the Configuration</a></li>
<li><a href="#_running_and_testing_the_application">Running and Testing the Application</a></li>
</ul>
</li>
<li><a href="#rest-openapi">Open API</a>
<ul class="sectlevel3">
<li><a href="#_directory_structure_3">Directory Structure</a></li>
<li><a href="#_installing_the_openapi_extension">Installing the OpenAPI extension</a></li>
<li><a href="#_open_api">Open API</a></li>
<li><a href="#_openapi_tests_in_villainresourcetest">OpenAPI Tests in VillainResourceTest</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#quarkus">Quarkus</a>
<ul class="sectlevel2">
<li><a href="#quarkus-definition">What&#8217;s Quarkus?</a></li>
<li><a href="#quarkus-augmentation">Quarkus Augmentation</a></li>
<li><a href="#quarkus-lifecycle">Application Lifecycle</a>
<ul class="sectlevel3">
<li><a href="#_directory_structure_4">Directory Structure</a></li>
<li><a href="#_displaying_a_banner">Displaying a Banner</a></li>
</ul>
</li>
<li><a href="#quarkus-profile">Configuration Profiles</a></li>
</ul>
</li>
<li><a href="#reactive">Reactive</a>
<ul class="sectlevel2">
<li><a href="#_why_reactive">Why reactive?</a></li>
<li><a href="#_hero_microservice">Hero Microservice</a>
<ul class="sectlevel3">
<li><a href="#_directory_structure_5">Directory Structure</a></li>
<li><a href="#_the_hero_entity">The Hero entity</a></li>
<li><a href="#_uni_api_in_2_minutes">Uni API in 2 minutes</a></li>
<li><a href="#_the_hero_resource">The Hero Resource</a></li>
<li><a href="#_configuring_the_reactive_access_to_the_database">Configuring the reactive access to the database</a></li>
<li><a href="#_importing_heroes">Importing heroes</a></li>
<li><a href="#_testing_the_heroes">Testing the heroes</a></li>
</ul>
</li>
<li><a href="#_running_testing_and_packaging_the_application">Running, Testing and Packaging the Application</a></li>
</ul>
</li>
<li><a href="#microservices">From Microservice to Microservices</a>
<ul class="sectlevel2">
<li><a href="#microservices-fight">Fight Microservice</a>
<ul class="sectlevel3">
<li><a href="#_bootstrapping_the_fight_rest_endpoint">Bootstrapping the Fight REST Endpoint</a></li>
<li><a href="#_directory_structure_6">Directory Structure</a></li>
<li><a href="#_fight_entity">Fight Entity</a></li>
<li><a href="#_fighters_bean">Fighters Bean</a></li>
<li><a href="#_fightservice_transactional_service">FightService Transactional Service</a></li>
<li><a href="#_fightresource_endpoint">FightResource Endpoint</a></li>
<li><a href="#_adding_data_2">Adding Data</a></li>
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_fightresourcetest_test_class">FightResourceTest Test Class</a></li>
<li><a href="#_running_testing_and_packaging_the_application_2">Running, Testing and Packaging the Application</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ui">User Interface</a>
<ul class="sectlevel2">
<li><a href="#_quinoa">Quinoa?</a></li>
<li><a href="#_the_web_application">The Web Application</a>
<ul class="sectlevel3">
<li><a href="#_running_the_web_application">Running the Web Application</a></li>
<li><a href="#_live_coding_the_ui">Live coding the UI</a></li>
</ul>
</li>
<li><a href="#microservices-cors">CORS</a></li>
</ul>
</li>
<li><a href="#rest-client">HTTP communication &amp; Fault Tolerance</a>
<ul class="sectlevel2">
<li><a href="#rest-clients">REST Client</a>
<ul class="sectlevel3">
<li><a href="#_directory_structure_7">Directory Structure</a></li>
<li><a href="#_installing_the_reactive_rest_client_dependency">Installing the Reactive REST Client Dependency</a></li>
<li><a href="#_fightservice_invoking_external_microservices">FightService Invoking External Microservices</a></li>
<li><a href="#_creating_the_interfaces">Creating the Interfaces</a></li>
<li><a href="#_configuring_rest_client_invocation">Configuring REST Client Invocation</a></li>
<li><a href="#_updating_the_test_with_mock_support">Updating the Test with Mock Support</a></li>
</ul>
</li>
<li><a href="#rest-client-fallbacks">Fallbacks</a>
<ul class="sectlevel3">
<li><a href="#_installing_the_fault_tolerance_dependency">Installing the Fault Tolerance Dependency</a></li>
<li><a href="#_adding_fallbacks">Adding Fallbacks</a></li>
<li><a href="#_running_the_application_2">Running the Application</a></li>
</ul>
</li>
<li><a href="#rest-client-timeout">Timeout</a>
<ul class="sectlevel3">
<li><a href="#_adding_timeouts">Adding Timeouts</a></li>
<li><a href="#_running_the_application_3">Running the Application</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ai">Artificial Intelligence</a>
<ul class="sectlevel2">
<li><a href="#_whats_semantic_kernel">What&#8217;s Semantic Kernel?</a></li>
<li><a href="#_narration_microservice">Narration Microservice</a>
<ul class="sectlevel3">
<li><a href="#_directory_structure_8">Directory Structure</a></li>
<li><a href="#_add_the_semantic_kernel_dependencies">Add the Semantic Kernel dependencies</a></li>
<li><a href="#_the_fight_bean">The Fight bean</a></li>
<li><a href="#_the_narration_rest_resource">The Narration REST Resource</a></li>
<li><a href="#_the_semantic_kernel_narration_service">The Semantic Kernel Narration service</a></li>
<li><a href="#_the_narration_skill">The Narration skill</a></li>
<li><a href="#_configuring_openaiazure_openai_access">Configuring OpenAI/Azure OpenAI access</a></li>
<li><a href="#_testing_the_narration_microservice">Testing the Narration Microservice</a></li>
<li><a href="#_running_the_narration_microservice">Running the Narration Microservice</a></li>
</ul>
</li>
<li><a href="#_invoking_the_narration_microservice_from_the_fight_microservice">Invoking the Narration Microservice from the Fight Microservice</a>
<ul class="sectlevel3">
<li><a href="#_adding_narration_to_the_fight_microservice">Adding narration to the Fight Microservice</a></li>
<li><a href="#_test_and_mock_the_narration_microservice_invocation">Test and mock the Narration microservice invocation</a></li>
</ul>
</li>
<li><a href="#_running_testing_and_packaging_the_application_3">Running, Testing and Packaging the Application</a></li>
</ul>
</li>
<li><a href="#native">Building Native Executables</a>
<ul class="sectlevel2">
<li><a href="#_building_native_executables_with_quarkus">Building Native Executables with Quarkus</a></li>
<li><a href="#_building_native_executables_for_our_microservices">Building Native Executables for our Microservices</a></li>
<li><a href="#_running_the_application_in_native_mode">Running the Application in Native mode</a></li>
</ul>
</li>
<li><a href="#container">Building Containers</a>
<ul class="sectlevel2">
<li><a href="#_building_containers_with_quarkus">Building Containers with Quarkus</a></li>
<li><a href="#_building_containers_for_our_microservices_in_jvm_mode">Building Containers for our Microservices in JVM Mode</a></li>
<li><a href="#_running_jvm_mode_containers_locally">Running JVM Mode Containers Locally</a></li>
<li><a href="#_building_containers_for_our_microservices_in_native_mode">Building Containers for our Microservices in Native Mode</a></li>
<li><a href="#_building_native_containers">Building native containers</a></li>
<li><a href="#_running_native_mode_containers_locally">Running Native Mode Containers Locally</a></li>
<li><a href="#_building_a_container_running_a_native_executable">Building a container running a native executable</a></li>
</ul>
</li>
<li><a href="#kubernetes">Deploying with Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_deploying_on_kubernetes">Deploying on Kubernetes</a>
<ul class="sectlevel3">
<li><a href="#_deploying_the_infrastructure">Deploying the infrastructure</a></li>
<li><a href="#_deploying_the_hero_villain_microservices">Deploying the Hero &amp; Villain microservices</a></li>
<li><a href="#_deploying_the_fight_microservice">Deploying the Fight microservice</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_from_container_to_kubernetes">From Container to Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_deploying_to_kubernetes">Deploying to Kubernetes</a></li>
<li><a href="#cloud-open-shift">Deploying to Open Shift</a></li>
</ul>
</li>
<li><a href="#extension">Writing a Quarkus Extension</a>
<ul class="sectlevel2">
<li><a href="#_the_extension_framework">The extension framework</a></li>
<li><a href="#_structure_of_an_extension">Structure of an extension</a></li>
<li><a href="#_the_version_extension">The version extension</a></li>
<li><a href="#_the_runtime_module">The runtime module</a></li>
<li><a href="#_the_deployment_module">The deployment module</a></li>
<li><a href="#_packaging_the_extension">Packaging the extension</a></li>
<li><a href="#_using_the_extension">Using the extension</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a>
<ul class="sectlevel2">
<li><a href="#conclusion-references">References</a></li>
</ul>
</li>
<li><a href="#_installing_extra_software">Appendix A: Installing extra software</a>
<ul class="sectlevel2">
<li><a href="#appendix-installing-maven">Apache Maven 3.8.x</a>
<ul class="sectlevel3">
<li><a href="#_installing_maven">Installing Maven</a></li>
<li><a href="#_checking_for_maven_installation">Checking for Maven Installation</a></li>
<li><a href="#_some_maven_commands">Some Maven Commands</a></li>
</ul>
</li>
<li><a href="#appendix-installing-curl">cURL</a>
<ul class="sectlevel3">
<li><a href="#_installing_curl">Installing cURL</a></li>
<li><a href="#_checking_for_curl_installation">Checking for cURL Installation</a></li>
<li><a href="#_some_curl_commands">Some cURL Commands</a></li>
</ul>
</li>
<li><a href="#appendix-preparing-warming-caches">Warming the caches</a>
<ul class="sectlevel3">
<li><a href="#_warming_up_maven">Warming up Maven</a></li>
<li><a href="#appendix-preparing-warming-docker">Warming up Docker images</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction">Welcome</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>Let&#8217;s start from the beginning.
Quarkus.
What&#8217;s Quarkus?
That&#8217;s a pretty good question and probably a good start.
If you go to the <a href="https://quarkus.io">Quarkus web site</a>, you&#8217;ll read that Quarkus is "<em>A Kubernetes Native Java stack tailored for OpenJDK HotSpot &amp; GraalVM, crafted from the best of breed Java libraries and standards</em>."
This description is somewhat unclear but does an outstanding job at using bankable keywords.
It&#8217;s also written: "<em>Supersonic Subatomic Java</em>."
This is a way of saying that Quarkus is really fast, and its really light.
But what does Quarkus <em>do</em>?</p>
</div>
<div class="paragraph">
<p>In practice, Quarkus is a stack to develop distributed systems and modern applications in Java, Kotlin, or Scala.
Quarkus applications are tailored for the Cloud, containers, and Kubernetes.
That does not mean you can&#8217;t use Quarkus in other environments, there are no limits, but the principles infused in Quarkus have made containerization of applications more efficient.
In this workshop, we will explain what Quarkus is and because the best way to understand Quarkus is to use it, build a set of microservices with it.
Again, Quarkus is not limited to microservices, but it&#8217;s a generally well-understood type of architecture.</p>
</div>
<div class="paragraph">
<p>This workshop offers attendees an intro-level, hands-on session with Quarkus, from the first line of code to making services, to consuming them, and finally to assembling everything in a consistent system.
But, what are we going to build?
Well, it&#8217;s going to be a set of microservices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using Quarkus</p>
</li>
<li>
<p>Using blocking and non-blocking HTTP invocations</p>
</li>
<li>
<p>With some parts of the dark side of microservices (resilience, health, etc)</p>
</li>
<li>
<p>Use OpenAI to introduce some artificial intelligence</p>
</li>
<li>
<p>Answer the ultimate question: are super-heroes stronger than super-villains?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This workshop is a BYOL (<em>Bring Your Own Laptop</em>) session, so bring your Windows, OSX, or Linux laptop.
You just need JDK 17 on your machine and Docker (having Apache Maven 3.8.x installed is optional as you will rely on the Apache Maven Wrapper).
On Mac and Windows, Docker for <em>x</em> is recommended instead of the Docker toolbox setup.
On Windows it is also recommended to have WSL (<a href="https://docs.microsoft.com/windows/wsl">Windows Subsystem for Linux</a>) installed.</p>
</div>
<div class="paragraph">
<p>What you are going to learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What is Quarkus, and how you can use it</p>
</li>
<li>
<p>How to build an HTTP endpoint (REST API) with Quarkus</p>
</li>
<li>
<p>How to access a relational database</p>
</li>
<li>
<p>How you can use Swagger and OpenAPI</p>
</li>
<li>
<p>How you test your microservice</p>
</li>
<li>
<p>How to build a reactive microservice, including reactive data access</p>
</li>
<li>
<p>How you improve the resilience of your service</p>
</li>
<li>
<p>How to invoke OpenAI/Azure OpenAI APIs using Semantic Kernel</p>
</li>
<li>
<p>How to build native executable</p>
</li>
<li>
<p>How to containerize our microservices</p>
</li>
<li>
<p>How to deploy the microservices to Kubernetes</p>
</li>
<li>
<p>How to extend Quarkus with extensions</p>
</li>
<li>
<p>And much more!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ready? Here we go!
Check the workshop at <a href="https://quarkus.io/quarkus-workshops/super-heroes/" class="bare">https://quarkus.io/quarkus-workshops/super-heroes/</a> or flash the QR Code if you dont want to type.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/qrcode.png" alt="QR code" width="400" height="400">
</div>
</div>
<div class="sect2">
<h3 id="introduction-presentation">Presenting the Workshop</h3>
<div class="paragraph">
<p>This workshop should give you a practical introduction to Quarkus.
You will practice all the needed tools to develop an entire microservice architecture, mixing classical HTTP, reactive and event-based microservices.
You will finish by extending the capabilities of Quarkus and learn more about the ability to create native executables.</p>
</div>
<div class="paragraph">
<p>The idea is that you leave this workshop with a good understanding of what Quarkus is, what it is not, and how it can help you in your projects.
Then, you&#8217;ll be prepared to investigate a bit more and, hopefully, contribute.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Get this workshop from <a href="https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes" class="bare">https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_what_will_you_be_developing">What Will You Be Developing?</h4>
<div class="paragraph">
<p>In this workshop, you will develop an application that allows superheroes to fight against supervillains.
You will be developing several microservices communicating with each other:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Super Hero UI</em>: a React application to pick up a random superhero, a random supervillain, and makes them fight.
The Super Hero UI is exposed via Quarkus and invokes the Fight REST API</p>
</li>
<li>
<p><em>Villain REST API</em>: A classical HTTP microservice exposing CRUD operations on Villains, stored in a PostgreSQL database</p>
</li>
<li>
<p><em>Hero REST API</em>: A reactive HTTP microservice exposing CRUD operations on Heroes, stored in a Postgres database</p>
</li>
<li>
<p><em>Narration REST API</em>: This microservice talks to OpenAI/Azure OpenAI to generate a random narration of the fight.</p>
</li>
<li>
<p><em>Fight REST API</em>: This REST API invokes the Hero and Villain APIs to get a random superhero and supervillain.
It also invokes the Narration API to get a random narration of the fight.
Each fight is, then, stored in a PostgreSQL database.
This microservice can be developed using both the classical (<em>imperative</em>) or reactive approach.
Invocations to the other microservices are protected using resilience patterns (retry, timeout, circuit-breakers)</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-c0de534704725416649644985d95733a.png" alt="Diagram" width="3565" height="3493">
</div>
</div>
<div class="paragraph">
<p>The main UI allows you to pick up one random Hero and Villain by clicking on "New Fighters."
Then it&#8217;s just a matter of clicking on "Fight!" to get them to fight.
If you click on "Narrate the Fight", you will have some AI-generated text describing the fight.
The table at the bottom shows the list of the previous fights.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/react-ui-ai.png" alt="react ui ai">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_does_this_workshop_work">How Does This Workshop Work?</h4>
<div class="paragraph">
<p>You have this material in your hands (either electronically or printed), and you can now follow it step by step.
The structure of this workshop is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Installing all the needed tools</em>:
in this section, you will install all the tools and code to be able to develop, compile and execute our application</p>
</li>
<li>
<p><em>Developing microservices with Quarkus</em>:
in this section, you will develop a microservice architecture by creating several Maven projects, write some Java code, add JPA entities, JAX-RS REST endpoints, write some tests, use a React web application, and all that on Quarkus</p>
</li>
<li>
<p><em>Artificial Intelligence</em>:
in this section, you will use OpenAI or Azure OpenAI to invoke an AI so you can generate a random narration of the fight</p>
</li>
<li>
<p><em>Build native executables</em>:
in this section, you will build native executables of all the microservices thanks to GraalVM</p>
</li>
<li>
<p><em>Containers</em>:
in this section, you will create Docker images of all the microservices</p>
</li>
<li>
<p><em>Cloud</em>:
once the microservices are all containerize, you can deploy them to Kubernetes</p>
</li>
<li>
<p><em>Extending Quarkus</em>:
in this section, you will create a Quarkus extension</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you already have the tools installed, skip the <em>Installing all the needed tools</em> section and jump to the section <em>Developing with Quarkus</em>, and start hacking some code and add-ons.
This " la carte" mode lets you make the most of this 6-hour long hands-on lab.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_do_you_have_to_do">What Do You Have to Do?</h4>
<div class="paragraph">
<p>This workshop should be as self-explanatory as possible.
So your job is to follow the instructions by yourself, do what you are supposed to do, and do not hesitate to ask for any clarification or assistance; that&#8217;s why the team is here.</p>
</div>
<div class="paragraph">
<p>You will download a zip file (<a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip"><code>quarkus-super-heroes-workshop.zip</code></a>) containing <em>some</em> of the code and you will need to complete it.</p>
</div>
<div class="paragraph">
<p>Oh, and be ready to have some fun!</p>
</div>
</div>
<div class="sect3">
<h4 id="_software_requirements">Software Requirements</h4>
<div class="paragraph">
<p>First of all, make sure you have a 64-bit computer with admin rights (so you can install all the needed tools) and at least 8Gb of RAM (as some tools need a few resources).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using Mac OS X, make sure the version is greater than 10.11.x (El Capitan).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This workshop will make use of the following software, tools, frameworks that you will need to install and know (more or less) how it works:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any IDE you feel comfortable with (eg. Intellij IDEA, Eclipse IDE, VS Code..)</p>
</li>
<li>
<p>JDK 17</p>
</li>
<li>
<p>GraalVM 22.3</p>
</li>
<li>
<p>Docker or Podman</p>
</li>
<li>
<p>cURL (should already be installed in your OS, if not, check <a href="#appendix-installing-curl">the appendix for installation instructions</a>) and <code>jq</code></p>
</li>
<li>
<p>OpenAI or Azure OpenAI keys</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will also be using Maven 3.8.x, but there is no need to install it.
Instead, the workshop scaffolding includes a maven wrapper, <code>mvnw</code>.
If you&#8217;d prefer to install your own Maven and don&#8217;t already have it, <a href="#appendix-installing-maven">see the instructions at the end of the workshop</a>.</p>
</div>
<div class="paragraph">
<p>The following section focuses on how to install and set up the needed software.
You can skip the next section if you have already installed all the prerequisites.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This workshop assumes a bash shell.
If you run on Windows, in particular, adjust the commands accordingly or install WSL.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="introduction-installing">Installing Software</h3>
<div class="sect3">
<h4 id="introduction-installing-jdk">JDK 17</h4>
<div class="paragraph">
<p>Essential for the development and execution of this workshop is the <em>Java Development Kit</em> (JDK).<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
The JDK includes several tools such as a compiler (<code>javac</code>), a virtual machine, a documentation generator (`JavaDoc), monitoring tools (Visual VM) and so on<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.
The code in this workshop uses JDK 17.</p>
</div>
<div class="sect4">
<h5 id="_installing_the_jdk">Installing the JDK</h5>
<div class="paragraph">
<p>To install the JDK 17, follows the instructions from <a href="https://adoptium.net/installation.html" class="bare">https://adoptium.net/installation.html</a> to download and install the JDK for your platform.</p>
</div>
<div class="paragraph">
<p>There is also an easier way to download and install Java if you are on Mac OS X: using SDKMAN!.
<em>SDKMAN!</em>&#8288;<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> is a tool for managing parallel versions of multiple Software Development Kits (SDK) on most Unix based systems.
It provides a convenient Command Line Interface (CLI) and API for installing, switching, removing and listing <em>Candidates</em>.
Developers often need to manage parallel versions of different builds of SDKs in their environment and switch from one to another.
Manually setting the <code>PATH</code> variable can become quickly painful.
That&#8217;s when SDKMAN! can help you.</p>
</div>
<div class="sect5">
<h6 id="_installing_sdkman">Installing SDKMAN!</h6>
<div class="paragraph">
<p>Installing SDKMAN! is easy.
On Bash and ZSH shells simply open a new terminal and enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="term">$ curl -s &quot;https://get.sdkman.io&quot; | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the instructions on-screen to complete installation.</p>
</div>
</div>
<div class="sect5">
<h6 id="_listing_java_versions">Listing Java Versions</h6>
<div class="paragraph">
<p>To install Java, we need to list the available versions on SDKMAN! using the <code>list</code> command.
The result is a table of entries grouped by the vendor and sorted by version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="term">$ sdk list java

==========================================================================
Available Java Versions for macOS ARM 64bit
==========================================================================
Vendor        | Use | Version      | Dist    | Status     | Identifier
--------------------------------------------------------------------------
Corretto      |     | 19.0.1       | amzn    |            | 19.0.1-amzn
....
Microsoft     |     | 17.0.5       | ms      |            | 17.0.5-ms
...
Oracle        |     | 19.0.1       | oracle  |            | 19.0.1-oracle
...
Temurin       |     | 19.0.1       | tem     |            | 19.0.1-tem
              | &gt;&gt;&gt; | 17.0.5       | tem     | installed  | 17.0.5-tem
              |     | 11.0.17      | tem     | installed  | 11.0.17-tem
==========================================================================</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have any Java candidate installed, you should see <code>installed</code> in the <code>Status</code> column.
If you don&#8217;t have any Java candidate installed, use SDKMAN! to install one or several.</p>
</div>
</div>
<div class="sect5">
<h6 id="_installing_java_17">Installing Java 17</h6>
<div class="paragraph">
<p>There are several different vendors of Java, and each vendor has its own distribution.
Most of these distributions are available on SDKMAN! and can easily be installed.
Let&#8217;s install Temurin.</p>
</div>
<div class="paragraph">
<p>To install Temurin 17, we copy its identifier (<code>17-tem</code>), which is the version from the table, and we add it as an argument in the install command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="term">$ sdk install java 17-tem

Downloading: java 17-tem
Repackaging Java 17-tem...
Installing: java 17-tem
Done installing!

Do you want java 17-tem to be set as default? (Y/n):</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Linux distributions, there are also packaged java installations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"># dnf (rpm-based)
dnf install java-17-openjdk
# Debian-based distributions:
$ apt-get install openjdk-17-jdk</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_java_installation">Checking for Java Installation</h5>
<div class="paragraph">
<p>Once the installation is complete, it is necessary to set the <code>JAVA_HOME</code> variable and the <code>$JAVA_HOME/bin</code> directory to the <code>PATH</code> variable.
Check that your system recognizes Java by entering <code>java -version</code> and the Java compiler with <code>javac -version</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ java -version
openjdk version &quot;17.0.5&quot; 2022-10-18
OpenJDK Runtime Environment GraalVM CE 22.3.0 (build 17.0.5+8-jvmci-22.3-b08)
OpenJDK 64-Bit Server VM GraalVM CE 22.3.0 (build 17.0.5+8-jvmci-22.3-b08, mixed mode, sharing)

$ javac -version
javac 17.0.5</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-installing-docker">Docker or Podman</h4>
<div class="paragraph">
<p>Docker is a set of utilities that use OS-level virtualization to deliver software in packages called containers.
Containers are isolated from one another and bundle their software, libraries, and configuration files;
they can communicate with each other through well-defined channels.</p>
</div>
<div class="sect4">
<h5 id="_installing_docker">Installing Docker</h5>
<div class="paragraph">
<p>Quarkus use Testcontainers, and therefore also Docker, to ease the management of different technical services (database, monitoring&#8230;&#8203;) during development.
Our workshop also uses Docker to manage these services in a production-style deployment.
So for this, we need to install <code>docker</code> and <code>docker compose</code>
Installation instructions are available on the following page:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mac OS X - <a href="https://docs.docker.com/docker-for-mac/install/" class="bare">https://docs.docker.com/docker-for-mac/install/</a> (version 20+)</p>
</li>
<li>
<p>Windows - <a href="https://docs.docker.com/docker-for-windows/install/" class="bare">https://docs.docker.com/docker-for-windows/install/</a> (version 20+)</p>
</li>
<li>
<p>CentOS - <a href="https://docs.docker.com/install/linux/docker-ce/centos/" class="bare">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>
</li>
<li>
<p>Debian - <a href="https://docs.docker.com/install/linux/docker-ce/debian/" class="bare">https://docs.docker.com/install/linux/docker-ce/debian/</a></p>
</li>
<li>
<p>Fedora - <a href="https://docs.docker.com/install/linux/docker-ce/fedora/" class="bare">https://docs.docker.com/install/linux/docker-ce/fedora/</a></p>
</li>
<li>
<p>Ubuntu - <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" class="bare">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On Linux, don&#8217;t forget the post-execution steps described on <a href="https://docs.docker.com/install/linux/linux-postinstall/" class="bare">https://docs.docker.com/install/linux/linux-postinstall/</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you do not have a Docker licence, you might prefer <code>podman</code> (<a href="https://podman.io/" class="bare">https://podman.io/</a>) instead of <code>docker</code>. To install <code>podman</code> and <code>podman-compose</code> please follow the instructions at <a href="https://quarkus.io/guides/podman" class="bare">https://quarkus.io/guides/podman</a>. Do not forget the extra steps to configure the testcontainers library. As a convenience you can even alias <code>docker</code> to <code>podman</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_docker_installation">Checking for Docker Installation</h5>
<div class="paragraph">
<p>Once installed, check that both <code>docker</code> and <code>docker compose</code> are available in your <code>PATH</code>.
For that, execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ docker version</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Docker version 20.10.8, build 3967b7d
Cloud integration: v1.0.24
Version:           20.10.14
API version:       1.41</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, check the Docker Compose version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ docker compose version</code></pre>
</div>
</div>
<div class="paragraph">
<p>Docker compose being a separate utility, you should get a different version than Docker itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Docker Compose version v2.5.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, run your first container as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ docker run hello-world</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the first time, this will download the <code>hello-world</code> image from the Docker Hub and run it.
You should get something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
1. The Docker client contacted the Docker daemon.
2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
(amd64)
3. The Docker daemon created a new container from that image which runs the
executable that produces the output you are currently reading.
4. The Docker daemon streamed that output to the Docker client, which sent it
to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
$ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_some_docker_commands">Some Docker Commands</h5>
<div class="paragraph">
<p>Docker is a command-line utility where you can use several parameters and options to start/stop a container.
You invoke <code>docker</code> with zero, one, or several command-line options with the container or image ID you want to work with.
Docker comes with several options that are described in the documentation if you need more help.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>
To get some help on the commands and options, you can type, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ docker help

Usage:  docker [OPTIONS] COMMAND

$ docker help attach

Usage:  docker attach [OPTIONS] CONTAINER

Attach local standard input, output, and error streams to a running container</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some commands that you will be using to start/stop containers in this workshop.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker container ls</code>: Lists containers.</p>
</li>
<li>
<p><code>docker container start CONTAINER</code>: Starts one or more stopped containers.</p>
</li>
<li>
<p><code>docker compose -f docker-compose.yaml up -d</code>: Starts all containers defined in a Docker Compose file.</p>
</li>
<li>
<p><code>docker compose -f docker-compose.yaml down</code>: Stops all containers defined in a Docker Compose file.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-installing-jq">jq</h4>
<div class="paragraph">
<p>Very often, when using cURL to invoke a RESTful web service, we get some JSON payload.
cURL does not format this JSON so that you will get a flat String such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8083/api/heroes
[{&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;Chewbacca&quot;,&quot;level&quot;:&quot;14&quot;},{&quot;id&quot;:&quot;2&quot;,&quot;name&quot;:&quot;Wonder Woman&quot;,&quot;level&quot;:&quot;15&quot;},{&quot;id&quot;:&quot;3&quot;,&quot;name&quot;:&quot;Anakin Skywalker&quot;,&quot;level&quot;:&quot;8&quot;}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>But what we want is to format the JSON payload, so it is easier to read.
For that, there is a neat utility tool called <code>jq</code> that we could use.
<code>jq</code> is a tool for processing JSON inputs, applying the given filter to its JSON text inputs, and producing the filter&#8217;s results as JSON on standard output.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</div>
<div class="sect4">
<h5 id="_installing_jq">Installing jq</h5>
<div class="paragraph">
<p>You can install it on Mac OSX with a simple <code>brew install jq</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_jq_installation">Checking for jq Installation</h5>
<div class="paragraph">
<p>Once installed, it&#8217;s just a matter of piping the cURL output to jq like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8083/api/heroes | jq

[
  {
    &quot;id&quot;: &quot;1&quot;,
    &quot;name&quot;: &quot;Chewbacca&quot;,
    &quot;lastName&quot;: &quot;14&quot;
  },
  {
    &quot;id&quot;: &quot;2&quot;,
    &quot;name&quot;: &quot;Wonder Woman&quot;,
    &quot;lastName&quot;: &quot;15&quot;
  },
  {
    &quot;id&quot;: &quot;3&quot;,
    &quot;name&quot;: &quot;Anakin Skywalker&quot;,
    &quot;lastName&quot;: &quot;8&quot;
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-installing-graalvm">GraalVM 22.3</h4>
<div class="paragraph">
<p>GraalVM extends the <em>Java Virtual Machine</em> (JVM) to support more languages and several execution modes.<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup>
It supports a large set of languages:
Java of course, other JVM-based languages (such as Groovy, Kotlin etc.) but also JavaScript, Ruby, Python, R and C/C++.
It includes a high-performance Java compiler, which can be used in a <em>Just-In-Time</em> (JIT) configuration on the HotSpot VM or in an <em>Ahead-Of-Time</em> (AOT) configuration with the GraalVM native compiler.
One objective of GraalVM is to improve the performance of Java virtual machine-based languages to match the performance of native languages.</p>
</div>
<div class="sect4">
<h5 id="_prerequisites_for_graalvm">Prerequisites for GraalVM</h5>
<div class="paragraph">
<p>On Linux, you need GCC and the Glibc and zlib headers.
Examples for common distributions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"># dnf (rpm-based)
sudo dnf install gcc glibc-devel zlib-devel
# Debian-based distributions:
sudo apt-get install build-essential libz-dev zlib1g-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>On macOS X there are several ways to install GraalVM.
But using SDKMAN! is the preferred option, as it allows you to easily switch between different versions of GraalVM if needed.</p>
</div>
<div class="paragraph">
<p>On Windows, you need the <em>Developer Command Prompt for Microsoft Visual C++</em>.
Check the <a href="https://www.graalvm.org/docs/getting-started/windows/#prerequisites-for-using-native-image-on-windows">Windows prerequisites page</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_installing_graalvm">Installing GraalVM</h5>
<div class="sect5">
<h6 id="_listing_graalvm_versions">Listing GraalVM Versions</h6>
<div class="paragraph">
<p>First of all, check if you already have the GraalVM Candidates installed on your machine.
To list the available versions of GraalVM, use the SDKMAN! <code>list java</code> command.
The result is a table of entries grouped by the vendor and sorted by version.
GraalVM has its own group and is listed under the <code>GraalVM</code> vendor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="term">$ sdk list java

=======================================================================
Available Java Versions for macOS ARM 64bit
=======================================================================
Vendor        | Use | Version      | Dist    | Status  | Identifier
-----------------------------------------------------------------------
GraalVM       |     | 22.3.r19     | grl     |         | 22.3.r19-grl
              |     | 22.3.r17     | grl     |         | 22.3.r17-grl
              |     | 22.3.r11     | grl     |         | 22.3.r11-grl
              |     | 22.2.r17     | grl     |         | 22.2.r17-grl
              |     | 22.2.r11     | grl     |         | 22.2.r11-grl
              |     | 22.1.0.r17   | grl     |         | 22.1.0.r17-grl
              |     | 22.1.0.r11   | grl     |         | 22.1.0.r11-grl
=======================================================================</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have any GraalVM candidate installed, you should see <code>installed</code> in the <code>Status</code> column.
If you don&#8217;t have any GraalVM candidate installed, use SDKMAN! to install one or several.</p>
</div>
</div>
<div class="sect5">
<h6 id="_installing_a_graalvm_version">Installing a GraalVM Version</h6>
<div class="paragraph">
<p>There are several versions of GraalVM available for different versions of the JDK.
Because we are using Java 17 in this fascicle, we will install the version of GraalVM that is compatible with Java 17 (the versions finishing with <code>r17-grl</code>).
Let&#8217;s install GraalVM 22.3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="term">$ sdk install java 22.3.r17-grl

Downloading: java 22.3.r17-grl
Repackaging Java 22.3.r17-grl...
Installing: java 22.3.r17-grl
Done installing!

Do you want java 22.3.r17-grl to be set as default? (Y/n):</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once installed, define the <code>GRAALVM_HOME</code> environment variable to point to the directory where GraalVM is installed (eg. on Mac OS X it could be <code>~/.sdkman/candidates/java/22.3.r17-grl</code>).</p>
</div>
<div class="paragraph">
<p>The <code>native-image</code> tool must be installed.
It can be done by running the following command under <code>$GRAALVM_HOME/bin</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./gu install native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>from your GraalVM <code>bin</code> directory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Mac OS X - Catalina</div>
<div class="paragraph">
<p>On Mac OS X Catalina, the installation of the <code>native-image</code> executable may fail.
GraalVM binaries are not (yet) notarized for Catalina.
To bypass the issue, it is recommended to run the following command instead of disabling macOS Gatekeeper entirely:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">xattr -r -d com.apple.quarantine ${GRAAL_VM}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_graalvm_installation">Checking for GraalVM Installation</h5>
<div class="paragraph">
<p>Once installed and set up, you should be able to run the following command and get something like the following output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ $GRAALVM_HOME/bin/native-image --version</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">GraalVM 22.3.1 Java 17 CE (Java Version 17.0.6+10-jvmci-22.3-b13)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-installing-ai">OpenAI or Azure OpenAI Subscriptions</h4>
<div class="paragraph">
<p>The Narration microservice needs to access an AI service to generate the text narrating the fight.
You can choose between OpenAI or Azure OpenAI.
Azure OpenAI, or "OpenAI on Azure" is a service that provides REST API access to OpenAI&#8217;s models, including the GPT-4, GPT-3, Codex and Embeddings series.
The difference between OpenAI and Azure OpenAI is that it runs on Azure global infrastructure, which meets your production needs for critical enterprise security, compliance, and regional availability.</p>
</div>
<div class="sect4">
<h5 id="_openai">OpenAI</h5>
<div class="paragraph">
<p><a href="https://openai.com/">OpenAI</a> is a leading artificial intelligence research organization creating cutting-edge AI technologies.
OpenAI offers a range of APIs that enable developers to integrate AI capabilities into their applications.
Some of these APIs include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GPT API: This API provides access to the GPT-3 and 4 language model</p>
</li>
<li>
<p>Codex API: This API provides access to the Codex model, which is a language model trained on a dataset of public code</p>
</li>
<li>
<p>DALL-E API: This API provides access to the DALL-E model, which is a language model trained on a dataset of text-image pairs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will be using the GPT-3 API to generate the text narrating the fight.</p>
</div>
<div class="paragraph">
<p>First, you need to have an OpenAI subscription and then generate an API key.
Then you need to ge the organisation id and key to invoke the API.
To get the organisation id, go to <a href="https://platform.openai.com/account/org-settings">OpenAI organisation settings</a> and copy the organisation id.:</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/openai-org.png" alt="openai org">
</div>
</div>
<div class="paragraph">
<p>Then, to get the API key, go to <a href="https://platform.openai.com/account/api-keys">OpenAI API keys</a> and copy the API key:</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/openai-key.png" alt="openai key">
</div>
</div>
<div class="paragraph">
<p>You will have to <a href="https://platform.openai.com/account/billing/overview">credit your OpenAI account</a> with some money to be able to use the API.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/openai-fund.png" alt="openai fund">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_azure_openai">Azure OpenAI</h5>
<div class="paragraph">
<p>If you already have an Azure subscription, you can use it to create an <a href="https://azure.microsoft.com/products/ai-services/openai-service">Azure OpenAI</a> resource.
Otherwise, you can create a <a href="https://azure.microsoft.com/free">free Azure subscription</a> and use it to create an Azure OpenAI resource.
Then, you need to use the Azure OpenAI service to generate the API key and endpoint URL.
You can either do that using the <a href="https://portal.azure.com/">Azure Portal</a> or the <a href="https://learn.microsoft.com/cli/azure/">Azure CLI</a>.</p>
</div>
<div class="paragraph">
<p>The easiest being use the Azure CLI, we recommend that you <a href="https://learn.microsoft.com/cli/azure/install-azure-cli">install it</a> and use it to create the Azure OpenAI resource and generate the API key and endpoint URL.
Once Azure CLI is installed and you have your Azure subscription, sign in to your Azure account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">az login</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have several Azure subscription, make sure you are using the right one.
For that, you can execute the following command to list all your subscriptions and set the one you want to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">az account list --output table
az account set --subscription &lt;subscription-id&gt;
az account show</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, execute the following command to create the Azure OpenAI resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">echo &quot;Setting up environment variables...&quot;
echo &quot;----------------------------------&quot;
PROJECT=&quot;&lt;give-your-project-a-name&gt;&quot;
RESOURCE_GROUP=&quot;rg-$PROJECT&quot;
LOCATION=&quot;eastus&quot;
TAG=&quot;$PROJECT&quot;
COGNITIVE_SERVICE=&quot;cognit-$PROJECT&quot;
COGNITIVE_DEPLOYMENT=&quot;gpt35turbo&quot;

echo &quot;Creating the resource group...&quot;
echo &quot;------------------------------&quot;
az group create \
  --name &quot;$RESOURCE_GROUP&quot; \
  --location &quot;$LOCATION&quot; \
  --tags system=&quot;$TAG&quot;


echo &quot;Creating the Cognitive Service...&quot;
echo &quot;---------------------------------&quot;
az cognitiveservices account create \
  --name &quot;$COGNITIVE_SERVICE&quot; \
  --resource-group &quot;$RESOURCE_GROUP&quot; \
  --location &quot;$LOCATION&quot; \
  --custom-domain &quot;$COGNITIVE_SERVICE&quot; \
  --tags system=&quot;$TAG&quot; \
  --kind &quot;OpenAI&quot; \
  --sku &quot;S0&quot;


echo &quot;Deploying the model...&quot;
echo &quot;----------------------&quot;
az cognitiveservices account deployment create \
  --name &quot;$COGNITIVE_SERVICE&quot; \
  --resource-group &quot;$RESOURCE_GROUP&quot; \
  --deployment-name &quot;$COGNITIVE_DEPLOYMENT&quot; \
  --model-name &quot;gpt-35-turbo&quot; \
  --model-version &quot;0301&quot;  \
  --model-format &quot;OpenAI&quot; \
  --sku-capacity 1 \
  --sku-name &quot;Standard&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script will create the Azure OpenAI resource and deploy the model.
Once the script has executed, you can use the following command to get the API key and endpoint URL.
You will need these properties later one when you will configure the Narration microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">echo &quot;Storing the key and endpoint in environment variables...&quot;
echo &quot;--------------------------------------------------------&quot;
AZUREOPENAI_KEY=$(
  az cognitiveservices account keys list \
    --name &quot;$COGNITIVE_SERVICE&quot; \
    --resource-group &quot;$RESOURCE_GROUP&quot; \
    | jq -r .key1
)
AZUREOPENAI_ENDPOINT=$(
  az cognitiveservices account show \
    --name &quot;$COGNITIVE_SERVICE&quot; \
    --resource-group &quot;$RESOURCE_GROUP&quot; \
    | jq -r .properties.endpoint
)

# Set the properties
echo &quot;--------------------------------------------------&quot;
echo &quot;The following properties can be copied to either the rest-narration/src/main/resources/conf.properties or to the ~/.sk/conf.properties file:&quot;
echo &quot;--------------------------------------------------&quot;
echo &quot;client.azureopenai.key=$AZUREOPENAI_KEY&quot;
echo &quot;client.azureopenai.endpoint=$AZUREOPENAI_ENDPOINT&quot;
echo &quot;client.azureopenai.deploymentname=$COGNITIVE_DEPLOYMENT&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you&#8217;ve finished the workshop, remember to delete the Azure OpenAI resources to avoid being charged for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Clean up
az group delete \
  --name &quot;$RESOURCE_GROUP&quot; \
  --yes

az cognitiveservices account purge \
  --name &quot;$COGNITIVE_SERVICE&quot; \
  --resource-group &quot;$RESOURCE_GROUP&quot; \
  --location &quot;$LOCATION&quot;

az cognitiveservices account delete \
  --name &quot;$COGNITIVE_SERVICE&quot; \
  --resource-group &quot;$RESOURCE_GROUP&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="azure-intro-installing-wsl">WSL</h4>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/windows/wsl">Windows Subsystem for Linux</a> (WSL) lets developers run a GNU/Linux environment&#8201;&#8212;&#8201;including most command-line tools, utilities, and applications&#8201;&#8212;&#8201;directly on Windows, unmodified, without the overhead of a traditional virtual machine or dual-boot setup.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using Windows, it is recommended to install WSL as all the commands use bash.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_installing_wsl">Installing WSL</h5>
<div class="paragraph">
<p>You can install everything you need to run Windows Subsystem for Linux (WSL) by entering this command in an administrator PowerShell or Windows Command Prompt and then restarting your machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">wsl --install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will enable the required optional components, download the latest Linux kernel, set WSL 2 as your default, and install a Linux distribution for you (Ubuntu by default).</p>
</div>
<div class="paragraph">
<p>The first time you launch a newly installed Linux distribution, a console window will open and you&#8217;ll be asked to wait for files to de-compress and be stored on your machine.
All future launches should take less than a second.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recap">Recap</h4>
<div class="paragraph">
<p>Before going further, make sure the following commands work on your machine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -version
$GRAALVM_HOME/bin/native-image --version
curl --version
docker version
docker compose version</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have not mentioned cURL up to now, because most modern operating systems ship with it pre-installed.
If your system is missing cURL, the appendix includes <a href="#appendix-installing-curl">instructions for installing cURL</a>.</p>
</div>
<div class="paragraph">
<p>And also make sure to have your OpenAI or Azure credentials ready if you want to develop the "Narration" microservice.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="introduction-preparing">Preparing for the Workshop</h3>
<div class="paragraph">
<p>In this workshop, you will be developing an application dealing with Super Heroes (and Super-Villains ) as well as Quarkus extensions.
The code will be separated into two different directories:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-212f96fa2bf7640c4a678243922e2fe6.png" alt="Diagram" width="437" height="38">
</div>
</div>
<div class="sect3">
<h4 id="_download_the_workshop_scaffolding">Download the workshop scaffolding</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>We&#8217;ve done some of the layout for you. First, download the zip file  <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip" class="bare">https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip</a>, and unzip it wherever you want.
This zip file contains <em>some</em> of the code of the workshop, along with assets you will need to complete it.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_super_heroes_application">Super Heroes Application</h5>
<div class="paragraph">
<p>Under the <code>super-heroes</code> directory you will find the entire Super Hero application spread throughout a set of subdirectories, each one containing a microservice or some tooling.
The final structure will be the following (don&#8217;t worry if you don&#8217;t have all this yet, this is what we&#8217;re aiming towards):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-fb06ca44d555cf95f35d7c92f3d3c4a9.png" alt="Diagram" width="651" height="164">
</div>
</div>
<div class="paragraph">
<p>Most of these subdirectories are Maven projects and follow the Maven directory structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-00ca08a1d306588270267e5ef81e7d5a.png" alt="Diagram" width="215" height="150">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-preparing-checking-ports">Checking Ports</h4>
<div class="paragraph">
<p>During this workshop, we will use several ports.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Use <code>lsof</code> to make sure the following ports are free, so you don&#8217;t run into any conflicts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">lsof -i tcp:8080    # UI
lsof -i tcp:8082    # Fight REST API
lsof -i tcp:8083    # Hero REST API
lsof -i tcp:8084    # Villain REST API
lsof -i tcp:8086    # Narration REST API
lsof -i tcp:5432    # Postgres</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ready">Ready?</h4>
<div class="paragraph">
<p>After the prerequisites have been installed and the environment has been checked,  it&#8217;s now time to write some code!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rest">Creating a <em>classical</em> REST/HTTP Microservice</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>At the heart of the Super-Hero application comes Villains!
You can&#8217;t have superheroes without super-villains.</p>
</div>
<div class="paragraph">
<p>We need to expose a REST API allowing CRUD operations on villains.
This microservice is, let&#8217;s say, a <em>classical</em> REST microservice.
It uses HTTP to expose a REST API and internally store data into a database.
It&#8217;s using the <em>imperative</em> development model.</p>
</div>
<div class="paragraph">
<p>The <em>fight</em> microservice will use this service.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-ae227f1604103413b163428e53fd2ef7.png" alt="Diagram" width="300" height="671">
</div>
</div>
<div class="paragraph">
<p>In the following sections, you learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to create a new Quarkus application</p>
</li>
<li>
<p>How to implement REST API using JAX-RS and the RESTEasy Reactive extension<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup></p>
</li>
<li>
<p>How to compose your application using beans</p>
</li>
<li>
<p>How to access your database using Hibernate ORM with Panache</p>
</li>
<li>
<p>How to use transactions</p>
</li>
<li>
<p>How to enable OpenAPI and Swagger-UI</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This service is exposed on the port 8084.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But first, let&#8217;s describe our service.
The Super-Villains microservice manages villains with their names, powers, and so on.
The REST API allows adding, removing, listing, and picking a random villain from the stored set.
Nothing outstanding but a good first step to discover Quarkus.</p>
</div>
<div class="sect2">
<h3 id="rest-bootstrapping">Villain Microservice</h3>
<div class="paragraph">
<p>First thing first, we need a project.
That&#8217;s what you are going to see in this section.</p>
</div>
<div class="sect3">
<h4 id="_bootstrapping_the_villain_rest_endpoint">Bootstrapping the Villain REST Endpoint</h4>
<div class="paragraph">
<p>The easiest way to create a new Quarkus project is to use the Quarkus Maven plugin.
Open a terminal and run the following command under the <code>quarkus-workshop-super-heroes/super-heroes</code> directory:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw io.quarkus:quarkus-maven-plugin:3.6.0:create \
    -DplatformVersion=3.6.0 \
    -DprojectGroupId=io.quarkus.workshop.super-heroes \
    -DprojectArtifactId=rest-villains \
    -DclassName=&quot;io.quarkus.workshop.superheroes.villain.VillainResource&quot; \
    -Dpath=&quot;api/villains&quot; \
    -Dextensions=&quot;resteasy-reactive-jackson&quot;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that we scaffold the project with a reactive implementation of RestEasy (<code>resteasy-reactive-jackson</code>).
This is the recommended way to develop REST applications with Quarkus even if we use the imperative programming model in the Villain microservice.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Remember that <code>mvnw</code> is the maven wrapper. It behaves like <code>mvn</code>,
but allows a project&#8217;s build dependencies to be encapsulated.</p>
</div>
<div class="paragraph">
<p>The last line selects the extension we want to use.
As a start, we only select <code>resteasy-reactive-jackson</code>, which will also import <code>resteasy-reactive</code>.</p>
</div>
<div class="paragraph">
<p>If you want your IDE to manage this new Maven project, you can declare it in the parent POM (<code>quarkus-super-heroes/pom.xml</code>) by adding this new module in the <code>&lt;modules&gt;</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;module&gt;</span>super-heroes/rest-villains<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Prefer a Web UI?</div>
<div class="paragraph">
<p>Instead of the Maven command, you can use <a href="https://code.quarkus.io" class="bare">https://code.quarkus.io</a> and select the <code>resteasy-reactive-jackson</code> extension.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_directory_structure">Directory Structure</h4>
<div class="paragraph">
<p>Once you bootstrap the project, you get the following directory structure with a few Java classes and other artifacts :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-d35c181e82e42e8580f8c3e6dd1c2f98.png" alt="Diagram" width="263" height="527">
</div>
</div>
<div class="paragraph">
<p>The Maven archetype generates the following <code>rest-villains</code> sub-directory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Maven structure with a <code>pom.xml</code></p>
</li>
<li>
<p>An <code>io.quarkus.workshop.superheroes.villain.VillainResource</code> resource exposed on <code>/api/villains</code></p>
</li>
<li>
<p>An associated unit test <code>VillainResourceTest</code></p>
</li>
<li>
<p>The landing page <code>index.html</code> that is accessible on <a href="http://localhost:8080" class="bare">http://localhost:8080</a> after starting the application</p>
</li>
<li>
<p>Example <code>Dockerfile</code> files for both native and JVM modes in <code>src/main/docker</code></p>
</li>
<li>
<p>The <code>application.properties</code> configuration file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once generated, look at the <code>pom.xml</code>.
You will find the import of the Quarkus BOM, allowing you to omit the version on the different Quarkus dependencies.
In addition, you can see the <code>quarkus-maven-plugin</code> responsible for the packaging of the application and providing the development mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="comment">&lt;!-- ... --&gt;</span>
  <span class="tag">&lt;properties&gt;</span>
    <span class="tag">&lt;compiler-plugin.version&gt;</span>3.11.0<span class="tag">&lt;/compiler-plugin.version&gt;</span>
    <span class="tag">&lt;maven.compiler.release&gt;</span>17<span class="tag">&lt;/maven.compiler.release&gt;</span>
    <span class="tag">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tag">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="tag">&lt;project.reporting.outputEncoding&gt;</span>UTF-8<span class="tag">&lt;/project.reporting.outputEncoding&gt;</span>
    <span class="tag">&lt;quarkus.platform.artifact-id&gt;</span>quarkus-bom<span class="tag">&lt;/quarkus.platform.artifact-id&gt;</span>
    <span class="tag">&lt;quarkus.platform.group-id&gt;</span>io.quarkus<span class="tag">&lt;/quarkus.platform.group-id&gt;</span>
    <span class="tag">&lt;quarkus.platform.version&gt;</span>3.6.0<span class="tag">&lt;/quarkus.platform.version&gt;</span>
    <span class="tag">&lt;skipITs&gt;</span>true<span class="tag">&lt;/skipITs&gt;</span>
    <span class="tag">&lt;surefire-plugin.version&gt;</span>3.2.2<span class="tag">&lt;/surefire-plugin.version&gt;</span>
  <span class="tag">&lt;/properties&gt;</span>
  <span class="comment">&lt;!-- ... --&gt;</span>
  <span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
      <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>${quarkus.platform.group-id}<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>${quarkus.platform.artifact-id}<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${quarkus.platform.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
        <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
      <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
  <span class="tag">&lt;/dependencyManagement&gt;</span>
  <span class="comment">&lt;!-- ... --&gt;</span>
  <span class="tag">&lt;build&gt;</span>
    <span class="tag">&lt;plugins&gt;</span>
      <span class="tag">&lt;plugin&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>${quarkus.platform.group-id}<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>quarkus-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${quarkus.platform.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;extensions&gt;</span>true<span class="tag">&lt;/extensions&gt;</span>
        <span class="tag">&lt;executions&gt;</span>
          <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
              <span class="tag">&lt;goal&gt;</span>build<span class="tag">&lt;/goal&gt;</span>
              <span class="tag">&lt;goal&gt;</span>generate-code<span class="tag">&lt;/goal&gt;</span>
              <span class="tag">&lt;goal&gt;</span>generate-code-tests<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
          <span class="tag">&lt;/execution&gt;</span>
        <span class="tag">&lt;/executions&gt;</span>
      <span class="tag">&lt;/plugin&gt;</span>
     <span class="comment">&lt;!-- ... --&gt;</span>
    <span class="tag">&lt;/plugins&gt;</span>
  <span class="tag">&lt;/build&gt;</span>
<span class="comment">&lt;!-- ... --&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we focus on the dependencies section, you can see the extensions allowing the development of REST applications (resteasy-reactive and resteasy-reactive-jackson)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>quarkus-arc<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>quarkus-resteasy-reactive<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>quarkus-resteasy-reactive-jackson<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="comment">&lt;!-- ... --&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>quarkus-arc</code> is the dependency injection framework integrated into Quarkus.
It&#8217;s designed to perform build-time injections.
We will see later why this is essential for Quarkus.</p>
</li>
<li>
<p><code>resteasy-reactive</code> is the framework we will use to implement our REST API.
It uses JAX-RS annotations such as <code>@Path</code>, <code>@GET</code>&#8230;&#8203;</p>
</li>
<li>
<p><code>reasteasy-reactive-jackson</code> adds JSON object mapping capabilities to RESTEasy reactive.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_the_villain_resource">The Villain Resource</h4>
<div class="paragraph">
<p>During the project creation, the <code>VillainResource.java</code> file has been created with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">jakarta.ws.rs.GET</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainResource</span> {

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello from RESTEasy Reactive</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a very simple REST endpoint returning a "Hello World" to requests on <code>/api/villains</code>.
It uses JAX-RS annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Path</code> indicates the HTTP path handled by the resource,</p>
</li>
<li>
<p><code>@GET</code> indicates that the method should be called when receiving a <code>GET</code> request on <code>/api/villains</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Methods can also have their own <code>@Path</code> annotation suffixed to the class one (if any).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_application">Running the Application</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now we are ready to run our application.</p>
</div>
<div class="paragraph">
<p>Use: <code>./mvnw quarkus:dev</code> in the <code>rest-villains</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ ./mvnw quarkus:dev
[INFO] Scanning for projects...
[INFO]
[INFO] -----------&lt; io.quarkus.workshop.super-heroes:rest-villains &gt;-----------
[INFO] Building rest-villains 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- quarkus-maven-plugin:3.6.0:dev (default-cli) @ rest-villains ---
[INFO] Invoking resources:3.6.0:resources (default-resources) @ rest-villains
[INFO] Copying 2 resources from src/main/resources to target/classes
[INFO] Invoking quarkus:3.6.0:generate-code (default) @ rest-villains
[INFO] Invoking compiler:3.11.0:compile (default-compile) @ rest-villains
[INFO] Nothing to compile - all classes are up to date
[INFO] Invoking resources:3.6.0:testResources (default-testResources) @ rest-villains
[INFO] skip non existing resourceDirectory /Users/agoncal/Documents/Code/Temp/quarkus-super-heroes/super-heroes/rest-villains/src/test/resources
[INFO] Invoking quarkus:3.6.0:generate-code-tests (default) @ rest-villains
[INFO] Invoking compiler:3.11.0:testCompile (default-testCompile) @ rest-villains
[INFO] Nothing to compile - all classes are up to date
Listening for transport dt_socket at address: 5005

__  ____  __  _____   ___  __ ____  ______
 --/ __ \/ / / / _ | / _ \/ //_/ / / / __/
 -/ /_/ / /_/ / __ |/ , _/ ,&lt; / /_/ /\ \
--\___\_\____/_/ |_/_/|_/_/|_|\____/___/
2022-11-15 14:05:29,414 INFO  [io.quarkus] (Quarkus Main Thread) rest-villains 1.0.0-SNAPSHOT on JVM (powered by Quarkus 3.6.0) started in 1.093s. Listening on: http://localhost:8080

2022-11-15 14:05:29,423 INFO  [io.quarkus] (Quarkus Main Thread) Profile dev activated. Live Coding activated.
2022-11-15 14:05:29,423 INFO  [io.quarkus] (Quarkus Main Thread) Installed features: [cdi, resteasy-reactive, resteasy-reactive-jackson, smallrye-context-propagation, vertx]

Tests paused
Press [r] to resume testing, [o] Toggle test output, [:] for the terminal, [h] for more options&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then check that the endpoint returns <code>hello</code> as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8080/api/villains</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">Hello from RESTEasy Reactive</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can open <a href="http://localhost:8080/api/villains" class="bare">http://localhost:8080/api/villains</a> in your browser.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_development_mode">Development Mode</h4>
<div class="paragraph">
<p><code>quarkus:dev</code> runs Quarkus in development mode.
It enables hot deployment with background compilation, which means that when you modify your Java files or your resource files and invoke a REST endpoint (i.e., cURL command or refresh your browser), these changes will automatically take effect.
It works too for resource files like the configuration property and HTML files.
Refreshing the browser triggers a scan of the workspace, and if any changes are detected, the Java files are recompiled and the application is redeployed; your request is then serviced by the redeployed application.
If there are any issues with compilation or deployment an error page will let you know.</p>
</div>
<div class="paragraph">
<p>The development mode also allows debugging and listens for a debugger on port 5005.
If you want to wait for the debugger to attach before running, you can pass <code>-Dsuspend=true</code> on the command line.
If you don&#8217;t want the debugger at all, you can use <code>-Ddebug=false</code>.</p>
</div>
<div class="paragraph">
<p>Alright, time to change some code.
Open your favorite IDE and import the project.
To check that the hot reload is working, update the <code>VillainResource.hello()</code> method by returning the String "<em>Hello Villain Resource</em>".</p>
</div>
<div class="paragraph">
<p>Now, execute the cURL command again:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8080/api/villains</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output has changed ("<em>Hello Villain Resource</em>") without you having to stop and restart Quarkus!</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_application">Testing the Application</h4>
<div class="paragraph">
<p>All right, so far, so good, but wouldn&#8217;t it be better with a few tests, just in case.</p>
</div>
<div class="paragraph">
<p>In the generated <code>pom.xml</code> file, you can see two test dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="comment">&lt;!-- ... --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>quarkus-junit5<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>io.rest-assured<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>rest-assured<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, we will use Junit 5 combined with RESTAssured, which eases the testing of REST applications.</p>
</div>
<div class="paragraph">
<p>If you look at the <code>maven-surefire-plugin</code> configuration in the <code>pom.xml</code>, you will see that we set the <code>java.util.logging</code> system property to ensure tests will use the correct method log manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${surefire-plugin.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
      <span class="tag">&lt;systemPropertyVariables&gt;</span>
        <span class="tag">&lt;java.util.logging.manager&gt;</span>org.jboss.logmanager.LogManager<span class="tag">&lt;/java.util.logging.manager&gt;</span>
        <span class="tag">&lt;maven.home&gt;</span>${maven.home}<span class="tag">&lt;/maven.home&gt;</span>
      <span class="tag">&lt;/systemPropertyVariables&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated project contains a simple test in <code>VillainResourceTest.java</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.junit.QuarkusTest</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.given</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers.is</span>;

<span class="annotation">@QuarkusTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainResourceTest</span> {

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testHelloEndpoint() {
        given()
          .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
          .then()
             .statusCode(<span class="integer">200</span>)
             .body(is(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello from RESTEasy Reactive</span><span class="delimiter">&quot;</span></span>));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the <code>QuarkusTest</code> runner, the <code>VillainResourceTest</code> class instructs JUnit to start the application before the tests.
Then, the <code>testHelloEndpoint</code> method checks the HTTP response status code and content.
Notice that these tests use RestAssured, but feel free to use your favorite library.<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Quarkus provides a RestAssured integration that updates the default port used by RestAssured before the tests are run.
So in your RestAssured tests, you don&#8217;t have to specify the default test port 8081 used by Quarkus.
You can also configure the ports used by tests by configuring the <code>quarkus.http.test-port</code> property in the application.properties.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In the terminal running the application in <em>dev mode</em> (<code>./mvnw quarkus:dev</code>), you should see at the bottom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Tests paused
Press [r] to resume testing, [o] Toggle test output, [:] for the terminal, [h] for more options&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hit the <code>r</code> key, and watch Quarkus execute your tests automatically and even continuously.
Unfortunately, this first run didn&#8217;t end well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">2022-11-15 14:13:17,924 ERROR [io.qua.test] (Test runner thread) ==================== TEST REPORT #1 ====================
2022-11-15 14:13:17,925 ERROR [io.qua.test] (Test runner thread) Test VillainResourceTest#testHelloEndpoint() failed
: java.lang.AssertionError: 1 expectation failed.
Response body doesn't match expectation.
Expected: is &quot;Hello from RESTEasy Reactive&quot;
  Actual: Hello Villain Resource

        at io.restassured.internal.ValidatableResponseImpl.body(ValidatableResponseImpl.groovy)
        at io.quarkus.workshop.superheroes.villain.VillainResourceTest.testHelloEndpoint(VillainResourceTest.java:18)


2022-11-15 14:13:17,927 ERROR [io.qua.test] (Test runner thread) &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Summary: &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
io.quarkus.workshop.superheroes.villain.VillainResourceTest#testHelloEndpoint(VillainResourceTest.java:18) VillainResourceTest#testHelloEndpoint() 1 expectation failed.
Response body doesn't match expectation.
Expected: is &quot;Hello from RESTEasy Reactive&quot;
  Actual: Hello Villain Resource

2022-11-15 14:13:17,929 ERROR [io.qua.test] (Test runner thread) &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1 TEST FAILED &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;

2022-11-15 14:13:18,155 ERROR [io.qua.test] (Test runner thread) ==================== TEST REPORT #2 ====================
2022-11-15 14:13:18,155 ERROR [io.qua.test] (Test runner thread) Test VillainResourceTest#testHelloEndpoint() failed
: java.lang.AssertionError: 1 expectation failed.
Response body doesn't match expectation.
Expected: is &quot;Hello from RESTEasy Reactive&quot;
  Actual: Hello Villain Resource

        at io.restassured.internal.ValidatableResponseImpl.body(ValidatableResponseImpl.groovy)
        at io.quarkus.workshop.superheroes.villain.VillainResourceTest.testHelloEndpoint(VillainResourceTest.java:18)


2022-11-15 14:13:18,156 ERROR [io.qua.test] (Test runner thread) &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Summary: &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
io.quarkus.workshop.superheroes.villain.VillainResourceTest#testHelloEndpoint(VillainResourceTest.java:18) VillainResourceTest#testHelloEndpoint() 1 expectation failed.
Response body doesn't match expectation.
Expected: is &quot;Hello from RESTEasy Reactive&quot;
  Actual: Hello Villain Resource

2022-11-15 14:13:18,157 ERROR [io.qua.test] (Test runner thread) &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1 TEST FAILED &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It fails! It&#8217;s expected, you changed the output of <code>VillainResource.hello()</code> earlier.
Adjust the test body condition accordingly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.junit.QuarkusTest</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.given</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers.is</span>;

<span class="annotation">@QuarkusTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainResourceTest</span> {

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testHelloEndpoint() {
        given()
          .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
          .then()
             .statusCode(<span class="integer">200</span>)
             .body(is(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Villain Resource</span><span class="delimiter">&quot;</span></span>));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file, and watch the dev mode automatically rerunning your test (and passing)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">--
2022-11-15 14:15:22,997 INFO  [io.qua.test] (Test runner thread) All tests are now passing
--
All 1 test is passing (0 skipped), 1 test was run in 186ms. Tests completed at 14:15:23.
Press [r] to re-run, [o] Toggle test output, [:] for the terminal, [h] for more options&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Continuous testing is a big part of Quarkus development.
Quarkus detects and runs the tests for you.</p>
</div>
<div class="paragraph">
<p>You can also run the tests from a terminal using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw test</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_packaging_and_running_the_application">Packaging and Running the Application</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>The application is packaged using the <code>./mvnw package</code> command (it also runs the tests).
That command generates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>target/rest-villains-1.0.0-SNAPSHOT.jar</code>: containing just the classes and resources of the projects, it&#8217;s the regular artifact produced by the Maven build (it is not an executable jar);</p>
</li>
<li>
<p><code>target/quarkus-app/</code> : this directory uses the <em>fast jar</em> packaging. It contains an executable jar (<code>quarkus-run.jar</code>), and all the dependencies (structured into <code>app</code>, <code>lib</code> and <code>quarkus</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This <em>fast jar</em> takes advantage of the build-time principle of Quarkus (we discuss it soon) to improve the application performances and which can be easily transposed to container layers.</p>
</div>
<div class="paragraph">
<p>Stop the application running in dev mode (by hitting <code>q</code> or <code>CTRL+C</code>), and run the application using: <code>java -jar target/quarkus-app/quarkus-run.jar</code>.</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before running the application, don&#8217;t forget to stop the hot reload mode (hit CTRL+C), or you will have a port conflict.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<div class="title">Troubleshooting</div>
<p>You might come across the following error while developing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">WARN  [io.qu.ne.ru.NettyRecorder] (Thread-48) Localhost lookup took more than one second; you need to add a /etc/hosts entry to improve Quarkus startup time. See https://thoeni.io/post/macos-sierra-java/ for details.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this is the case, it&#8217;s just a matter of adding the node name of your machine to the /etc/hosts.
For that, first, get the name of your node with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ uname -n
my-node.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then <code>sudo vi /etc/hosts</code> so you have the right to edit the file and add the following entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">127.0.0.1 localhost my-node.local</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In another terminal, check that the application runs using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8080/api/villains
Hello Villain Resource</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest-transaction-orm">Transactions and ORM</h3>
<div class="paragraph">
<p>The Villain API&#8217;s role is to allow CRUD operations on Super Villains.
In this module we will create a Villain entity and persist/update/delete/retrieve it from a PostgreSQL database in a transactional way.</p>
</div>
<div class="paragraph">
<p>This microservice uses an imperative/classic execution model.
Interactions with the database will uses Hibernate ORM and will block until the responses from the database are retrieved.</p>
</div>
<div class="sect3">
<h4 id="_directory_structure_2">Directory Structure</h4>
<div class="paragraph">
<p>In this module we will add extra classes to the Villain API project.
You will end-up with the following directory structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-b3ee510d38dad3af75462173c8341109.png" alt="Diagram" width="336" height="206">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_installing_the_postgresql_dependency_hibernate_with_panache_and_hibernate_validator">Installing the PostgreSQL Dependency, Hibernate with Panache and Hibernate Validator</h4>
<div class="paragraph">
<p>This microservice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interacts with a PostgreSQL database - so it needs a driver</p>
</li>
<li>
<p>Uses Hibernate with Panache - needs the extension providing it</p>
</li>
<li>
<p>Validates payloads and entities - needs a validator</p>
</li>
<li>
<p>Consumes and produces JSON - needs a JSON mapper</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hibernate ORM is the de-facto JPA implementation and offers you the full breadth of an Object Relational Mapper.
It makes complex mappings possible, but it does not make simple and common mappings trivial.
Hibernate ORM with Panache focuses on making your entities trivial and fun to write in Quarkus.<sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup></p>
</div>
<div class="paragraph">
<p>Because JPA and Bean Validation work well together, we will use Bean Validation to constrain our business model.</p>
</div>
<div class="paragraph">
<p>To add the required dependencies, just run the following command under the <code>super-heroes/rest-villains</code> directory:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:add-extension -Dextensions=&quot;jdbc-postgresql,hibernate-orm-panache,hibernate-validator&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
No need to add an extension for JSON, we already included <code>resteasy-reactive-jackson</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will add the following dependencies in the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="comment">&lt;!-- ... --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>quarkus-hibernate-orm-panache<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>quarkus-hibernate-validator<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>quarkus-jdbc-postgresql<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="comment">&lt;!-- ... --&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From now on, you can choose to either edit your pom directly or use the <code>quarkus:add-extension</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_villain_entity">Villain Entity</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To define a Panache entity, simply extend <code>PanacheEntity</code>, annotate it with <code>@Entity</code> and add your columns as public fields (no need to have getters and setters).
The <code>Villain</code> entity should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.hibernate.orm.panache.PanacheEntity</span>;

<span class="keyword">import</span> <span class="include">jakarta.persistence.Column</span>;
<span class="keyword">import</span> <span class="include">jakarta.persistence.Entity</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.Min</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.Size</span>;

<span class="keyword">import</span> <span class="include">java.util.Random</span>;

<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Villain</span> <span class="directive">extends</span> PanacheEntity {

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Size</span>(min = <span class="integer">3</span>, max = <span class="integer">50</span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> <span class="predefined-type">String</span> otherName;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Min</span>(<span class="integer">1</span>)
    <span class="directive">public</span> <span class="type">int</span> level;

    <span class="directive">public</span> <span class="predefined-type">String</span> picture;

    <span class="annotation">@Column</span>(columnDefinition = <span class="string"><span class="delimiter">&quot;</span><span class="content">TEXT</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> powers;


    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Villain{</span><span class="delimiter">&quot;</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">id=</span><span class="delimiter">&quot;</span></span> + id +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, name='</span><span class="delimiter">&quot;</span></span> + name + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, otherName='</span><span class="delimiter">&quot;</span></span> + otherName + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, level=</span><span class="delimiter">&quot;</span></span> + level +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, picture='</span><span class="delimiter">&quot;</span></span> + picture + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, powers='</span><span class="delimiter">&quot;</span></span> + powers + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">'</span><span class="content">}</span><span class="delimiter">'</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice that you can put all your JPA column annotations and Bean Validation constraint annotations on the public fields.</p>
</div>
<div class="sect4">
<h5 id="_adding_operations">Adding Operations</h5>
<div class="paragraph">
<p>Thanks to Panache, once you have written the <code>Villain</code> entity, here are the most common operations you will be able to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// creating a villain</span>
Villain villain = <span class="keyword">new</span> Villain();
villain.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Lex Luthor</span><span class="delimiter">&quot;</span></span>;
villain.level = <span class="integer">9</span>;

<span class="comment">// persist it</span>
villain.persist();

<span class="comment">// getting a list of all Villain entities</span>
<span class="predefined-type">List</span>&lt;Villain&gt; villains = Villain.listAll();

<span class="comment">// finding a specific villain by ID</span>
villain = Villain.findById(id);

<span class="comment">// counting all villains</span>
<span class="type">long</span> countAll = Villain.count();</code></pre>
</div>
</div>
<div class="paragraph">
<p>But we are missing a business method: we need to return a random villain.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that it&#8217;s just a matter to add the following method to our <code>Villain.java</code> entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> Villain findRandom() {
    <span class="type">long</span> countVillains = count();
    <span class="predefined-type">Random</span> random = <span class="keyword">new</span> <span class="predefined-type">Random</span>();
    <span class="type">int</span> randomVillain = random.nextInt((<span class="type">int</span>) countVillains);
    <span class="keyword">return</span> findAll().page(randomVillain, <span class="integer">1</span>).firstResult();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You would need to add the following import statement if not done automatically by your IDE <code>import java.util.Random;</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Picking a random villain is achieved as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Gets the number of villains stored in the database (<code>count()</code>)</p>
</li>
<li>
<p>Picks a random number between 0 and <code>count()</code></p>
</li>
<li>
<p>Asks Hibernate with Panache to find all villains in a paginated way and return the random page containing 1 villain.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_hibernate">Configuring Hibernate</h4>
<div class="paragraph">
<p>Quarkus development mode is really useful for applications that mix front end or services and database access.
We use <code>quarkus.hibernate-orm.database.generation=drop-and-create</code> in conjunction with <code>import.sql</code> so every change to your app and in particular to your entities, the database schema will be properly recreated and your data (stored in <code>import.sql</code>) will be used to repopulate it from scratch.
This is best to perfectly control your environment and works magic with Quarkus live reload mode:
your entity changes or any change to your <code>import.sql</code> is immediately picked up and the schema updated without restarting the application!</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that, make sure to have the following configuration in your <code>application.properties</code> (located in <code>src/main/resources</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation=drop-and-create</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_villain_service">Villain Service</h4>
<div class="paragraph">
<p>To manipulate the <code>Villain</code> entity we will develop a transactional <code>VillainService</code> class.
The idea is to wrap methods modifying the database (e.g. <code>entity.persist()</code>) within a transaction.
Marking a CDI bean method <code>@Transactional</code> will do that for you and make that method a transaction boundary.</p>
</div>
<div class="paragraph">
<p><code>@Transactional</code> can be used to control transaction boundaries on any bean at the method level or at the class level to ensure every method is transactional.
You can control whether and how the transaction is started with parameters on <code>@Transactional</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Transactional(REQUIRED)</code> (default): starts a transaction if none was started, stays with the existing one otherwise.</p>
</li>
<li>
<p><code>@Transactional(REQUIRES_NEW)</code>: starts a transaction if none was started ; if an existing one was started, suspends it and starts a new one for the boundary of that method.</p>
</li>
<li>
<p><code>@Transactional(MANDATORY)</code>: fails if no transaction was started ; works within the existing transaction otherwise.</p>
</li>
<li>
<p><code>@Transactional(SUPPORTS)</code>: if a transaction was started, joins it ; otherwise works with no transaction.</p>
</li>
<li>
<p><code>@Transactional(NOT_SUPPORTED)</code>: if a transaction was started, suspends it and works with no transaction for the boundary of the method ; otherwise works with no transaction.</p>
</li>
<li>
<p><code>@Transactional(NEVER)</code>: if a transaction was started, raises an exception ; otherwise works with no transaction.</p>
</li>
</ul>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Creates a new <code>VillainService.java</code> file in the same package with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.transaction.Transactional.TxType.REQUIRED</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.transaction.Transactional.TxType.SUPPORTS</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.transaction.Transactional</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.config.inject.ConfigProperty</span>;

<span class="annotation">@ApplicationScoped</span>
<span class="annotation">@Transactional</span>(REQUIRED)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainService</span> {


    <span class="annotation">@Transactional</span>(SUPPORTS)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Villain&gt; findAllVillains() {
        <span class="keyword">return</span> Villain.listAll();
    }

    <span class="annotation">@Transactional</span>(SUPPORTS)
    <span class="directive">public</span> Villain findVillainById(<span class="predefined-type">Long</span> id) {
        <span class="keyword">return</span> Villain.findById(id);
    }

    <span class="annotation">@Transactional</span>(SUPPORTS)
    <span class="directive">public</span> Villain findRandomVillain() {
        Villain randomVillain = <span class="predefined-constant">null</span>;
        <span class="keyword">while</span> (randomVillain == <span class="predefined-constant">null</span>) {
            randomVillain = Villain.findRandom();
        }
        <span class="keyword">return</span> randomVillain;
    }

    <span class="directive">public</span> Villain persistVillain(<span class="annotation">@Valid</span> Villain villain) {
        villain.persist();
        <span class="keyword">return</span> villain;
    }

    <span class="directive">public</span> Villain updateVillain(<span class="annotation">@Valid</span> Villain villain) {
        Villain entity = Villain.findById(villain.id);
        entity.name = villain.name;
        entity.otherName = villain.otherName;
        entity.level = villain.level;
        entity.picture = villain.picture;
        entity.powers = villain.powers;
        <span class="keyword">return</span> entity;
    }

    <span class="directive">public</span> <span class="type">void</span> deleteVillain(<span class="predefined-type">Long</span> id) {
        Villain villain = Villain.findById(id);
        villain.delete();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@ApplicationScoped</code> annotation declares a <em>bean</em>.
The other component of the application can access this bean.
Arc, the dependency injection framework integrated in Quarkus, handles the creation and the access to this class.</p>
</div>
<div class="paragraph">
<p>Notice that both methods that persist and update a villain, pass a <code>Villain</code> object as a parameter.
Thanks to the Bean Validation&#8217;s <code>@Valid</code> annotation, the <code>Villain</code> object will be checked to see if it&#8217;s valid or not.
If it&#8217;s not, the transaction will be rolled back.</p>
</div>
</div>
<div class="sect3">
<h4 id="_accessing_a_database_in_dev_mode">Accessing a database in dev mode</h4>
<div class="paragraph">
<p>Our project now requires a connection to a PostgreSQL database.
In dev mode, no need to start a database or configure anything.
Quarkus does that for us (just make sure you have Docker up and running).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Start the application in dev mode with <code>./mvnw quarkus:dev</code>.
In the log, you will see the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">2021-09-21 15:58:44,640 INFO  [org.tes.doc.DockerClientProviderStrategy] (build-38) Loaded org.testcontainers.dockerclient.UnixSocketClientProviderStrategy from ~/.testcontainers.properties, will try it first
2021-09-21 15:58:45,068 INFO  [org.tes.doc.DockerClientProviderStrategy] (build-38) Found Docker environment with local Unix socket (unix:///var/run/docker.sock)
2021-09-21 15:58:45,070 INFO  [org.tes.DockerClientFactory] (build-38) Docker host IP address is localhost
2021-09-21 15:58:45,116 INFO  [org.tes.DockerClientFactory] (build-38) Connected to docker:
  Server Version: 20.10.8
  API Version: 1.41
  Operating System: Docker Desktop
  Total Memory: 5943 MB
2021-09-21 15:58:45,118 INFO  [org.tes.uti.ImageNameSubstitutor] (build-38) Image name substitution will be performed by: DefaultImageNameSubstitutor (composite of 'ConfigurationFileImageNameSubstitutor' and 'PrefixingImageNameSubstitutor')
2021-09-21 15:58:45,453 INFO  [org.tes.uti.RegistryAuthLocator] (build-38) Credential helper/store (docker-credential-desktop) does not have credentials for index.docker.io
2021-09-21 15:58:45,957 INFO  [org.tes.DockerClientFactory] (build-38) Ryuk started - will monitor and terminate Testcontainers containers on JVM exit
2021-09-21 15:58:45,958 INFO  [org.tes.DockerClientFactory] (build-38) Checking the system...
2021-09-21 15:58:45,958 INFO  [org.tes.DockerClientFactory] (build-38)  Docker server version should be at least 1.6.0
2021-09-21 15:58:46,083 INFO  [org.tes.DockerClientFactory] (build-38)  Docker environment should have more than 2GB free disk space
2021-09-21 15:58:46,143 INFO  [ .2]] (build-38) Creating container for image: postgres:13.2
2021-09-21 15:58:46,217 INFO  [ .2]] (build-38) Starting container with ID: a7fd54795185ab17baf487388c1e3280fdfea3f6ef8670c0336d367dba3e1d9e
2021-09-21 15:58:46,545 INFO  [ .2]] (build-38) Container postgres:13.2 is starting: a7fd54795185ab17baf487388c1e3280fdfea3f6ef8670c0336d367dba3e1d9e
2021-09-21 15:58:48,043 INFO  [ .2]] (build-38) Container postgres:13.2 started in PT1.959377S

2021-09-21 15:58:48,044 INFO  [io.qua.dev.pos.dep.PostgresqlDevServicesProcessor] (build-38) Dev Services for the default datasource (postgresql) started</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Quarkus detects the need for a database and starts one using a Docker container.
It automatically configures the application, which means we are good to go and implement our REST API.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the application fails to start properly and the logs contain something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">WARN  [or.te.ut.RyukResourceReaper] (testcontainers-ryuk) Can not connect to Ryuk at localhost:49153: java.net.ConnectException: Connection refused (Connection refused)</code></pre>
</div>
</div>
<div class="paragraph">
<p>try launching the application again
after having the <code>TESTCONTAINERS_RYUK_DISABLED</code> environment variable to <code>true</code>.
This setting will likely also be needed <strong>throughout</strong> the workshop.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_villainresource_endpoint">VillainResource Endpoint</h4>
<div class="paragraph">
<p>The <code>VillainResource</code> was bootstrapped with only one method <code>hello()</code>.
We need to add extra methods that will allow CRUD operations on villains.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Here are the new methods to add to the <code>VillainResource</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">org.jboss.resteasy.reactive.RestPath</span>;
<span class="keyword">import</span> <span class="include">org.jboss.resteasy.reactive.RestResponse</span>;

<span class="keyword">import</span> <span class="include">jakarta.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.DELETE</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.GET</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.POST</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.PUT</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Context</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriBuilder</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriInfo</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.TEXT_PLAIN</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainResource</span> {

    <span class="predefined-type">Logger</span> logger;
    VillainService service;

    <span class="directive">public</span> VillainResource(<span class="predefined-type">Logger</span> logger, VillainService service) {
        <span class="local-variable">this</span>.service = service;
        <span class="local-variable">this</span>.logger = logger;
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/random</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> RestResponse&lt;Villain&gt; getRandomVillain() {
        Villain villain = service.findRandomVillain();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Found random villain </span><span class="delimiter">&quot;</span></span> + villain);
        <span class="keyword">return</span> RestResponse.ok(villain);
    }

    <span class="annotation">@GET</span>
    <span class="directive">public</span> RestResponse&lt;<span class="predefined-type">List</span>&lt;Villain&gt;&gt; getAllVillains() {
        <span class="predefined-type">List</span>&lt;Villain&gt; villains = service.findAllVillains();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Total number of villains </span><span class="delimiter">&quot;</span></span> + villains.size());
        <span class="keyword">return</span> RestResponse.ok(villains);
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> RestResponse&lt;Villain&gt; getVillain(<span class="annotation">@RestPath</span> <span class="predefined-type">Long</span> id) {
        Villain villain = service.findVillainById(id);
        <span class="keyword">if</span> (villain != <span class="predefined-constant">null</span>) {
            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Found villain </span><span class="delimiter">&quot;</span></span> + villain);
            <span class="keyword">return</span> RestResponse.ok(villain);
        } <span class="keyword">else</span> {
            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">No villain found with id </span><span class="delimiter">&quot;</span></span> + id);
            <span class="keyword">return</span> RestResponse.noContent();
        }
    }

    <span class="annotation">@POST</span>
    <span class="directive">public</span> RestResponse&lt;<span class="predefined-type">Void</span>&gt; createVillain(<span class="annotation">@Valid</span> Villain villain, <span class="annotation">@Context</span> UriInfo uriInfo) {
        villain = service.persistVillain(villain);
        UriBuilder builder = uriInfo.getAbsolutePathBuilder().path(<span class="predefined-type">Long</span>.toString(villain.id));
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">New villain created with URI </span><span class="delimiter">&quot;</span></span> + builder.build().toString());
        <span class="keyword">return</span> RestResponse.created(builder.build());
    }

    <span class="annotation">@PUT</span>
    <span class="directive">public</span> RestResponse&lt;Villain&gt; updateVillain(<span class="annotation">@Valid</span> Villain villain) {
        villain = service.updateVillain(villain);
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Villain updated with new valued </span><span class="delimiter">&quot;</span></span> + villain);
        <span class="keyword">return</span> RestResponse.ok(villain);
    }

    <span class="annotation">@DELETE</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> RestResponse&lt;<span class="predefined-type">Void</span>&gt; deleteVillain(<span class="annotation">@RestPath</span> <span class="predefined-type">Long</span> id) {
        service.deleteVillain(id);
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Villain deleted with </span><span class="delimiter">&quot;</span></span> + id);
        <span class="keyword">return</span> RestResponse.noContent();
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Produces</span>(TEXT_PLAIN)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Villain Resource</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we added <code>@Path("/hello")</code> to the <code>hello</code> method to not conflict with the <code>getAllVillains()</code> method.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dependency_injection">Dependency Injection</h4>
<div class="paragraph">
<p>Dependency injection in Quarkus is based on ArC which is a CDI-based dependency injection solution tailored for Quarkus' architecture.<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup>
You can learn more about it in the Contexts and Dependency Injection guide.<sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup></p>
</div>
<div class="paragraph">
<p>ArC handles injection at build time.
You can use field injection and inject the <code>VillainService</code> and the logger using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> <span class="predefined-type">Logger</span> logger;
<span class="annotation">@Inject</span> VillainService service;</code></pre>
</div>
</div>
<div class="paragraph">
<p>But in your previous class, we used constructor injection.
Both the <code>VillainService</code> and the <code>Logger</code> are injected as constructor parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> VillainResource(<span class="predefined-type">Logger</span> logger, VillainService service) {
    <span class="local-variable">this</span>.service = service;
    <span class="local-variable">this</span>.logger = logger;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_data">Adding Data</h4>
<div class="paragraph">
<p>To load some SQL statements when Hibernate ORM starts, add the following <code>import.sql</code> in the root of the <code>resources</code> directory.
It contains SQL statements terminated by a semicolon.
This is useful to have a data set ready for the tests or demos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">ALTER</span> SEQUENCE villain_seq RESTART WITH <span class="integer">50</span>;

<span class="class">INSERT</span> <span class="class">INTO</span> villain(id, name, otherName, picture, powers, level)
<span class="keyword">VALUES</span> (nextval(<span class="string"><span class="delimiter">'</span><span class="content">villain_seq</span><span class="delimiter">'</span></span>), <span class="string"><span class="delimiter">'</span><span class="content">Buuccolo</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Majin Buu</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/15355.jpg</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Accelerated Healing, Adaptation, Agility, Flight, Immortality, Intelligence, Invulnerability, Reflexes, Self-Sustenance, Size Changing, Spatial Awareness, Stamina, Stealth, Super Breath, Super Speed, Super Strength, Teleportation</span><span class="delimiter">'</span></span>,
        <span class="integer">22</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> villain(id, name, otherName, picture, powers, level)
<span class="keyword">VALUES</span> (nextval(<span class="string"><span class="delimiter">'</span><span class="content">villain_seq</span><span class="delimiter">'</span></span>), <span class="string"><span class="delimiter">'</span><span class="content">Darth Vader</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Anakin Skywalker</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/10444.jpg</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Accelerated Healing, Agility, Astral Projection, Cloaking, Danger Sense, Durability, Electrokinesis, Energy Blasts, Enhanced Hearing, Enhanced Senses, Force Fields, Hypnokinesis, Illusions, Intelligence, Jump, Light Control, Marksmanship, Precognition, Psionic Powers, Reflexes, Stealth, Super Speed, Telekinesis, Telepathy, The Force, Weapons Master</span><span class="delimiter">'</span></span>,
        <span class="integer">13</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> villain(id, name, otherName, picture, powers, level)
<span class="keyword">VALUES</span> (nextval(<span class="string"><span class="delimiter">'</span><span class="content">villain_seq</span><span class="delimiter">'</span></span>), <span class="string"><span class="delimiter">'</span><span class="content">The Rival (CW)</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Edward Clariss</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/13846.jpg</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Accelerated Healing, Agility, Bullet Time, Durability, Electrokinesis, Endurance, Enhanced Senses, Intangibility, Marksmanship, Phasing, Reflexes, Speed Force, Stamina, Super Speed, Super Strength</span><span class="delimiter">'</span></span>,
        <span class="integer">10</span>);</code></pre>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Ok, but that&#8217;s just a few entries.
Download the SQL file <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/super-heroes/rest-villains/src/main/resources/import.sql">import.sql</a> and copy it under <code>src/main/resources</code>.
Now, you have more than 500 villains that will be loaded in the database.</p>
</div>
<div class="paragraph">
<p>If you didn&#8217;t yet, start the application in dev mode by executing the following command under the <code>rest-villains</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, open your browser to <a href="http://localhost:8080/api/villains" class="bare">http://localhost:8080/api/villains</a>.
You should see lots of heroes&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_crud_tests_in_villainresourcetest">CRUD Tests in VillainResourceTest</h4>
<div class="paragraph">
<p>To test the <code>VillainResource</code> endpoint, we just need to extend the <code>VillainResourceTest</code> we already have.
No need to configure anything, Quarkus will start a test database for you.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In <code>io.quarkus.workshop.superheroes.villain.VillainResourceTest</code>, you will add the following test methods to the <code>VillainResourceTest</code> class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>shouldNotGetUnknownVillain</code>: giving a random Villain identifier, the <code>VillainResource</code> endpoint should return a 204 (No content)</p>
</li>
<li>
<p><code>shouldGetRandomVillain</code>: checks that the <code>VillainResource</code> endpoint returns a random villain</p>
</li>
<li>
<p><code>shouldNotAddInvalidItem</code>: passing an invalid <code>Villain</code> should fail when creating it (thanks to the <code>@Valid</code> annotation)</p>
</li>
<li>
<p><code>shouldGetInitialItems</code>: checks that the <code>VillainResource</code> endpoint returns the list of heroes</p>
</li>
<li>
<p><code>shouldAddAnItem</code>: checks that the <code>VillainResource</code> endpoint creates a valid <code>Villain</code></p>
</li>
<li>
<p><code>shouldUpdateAnItem</code>: checks that the <code>VillainResource</code> endpoint updates a newly created <code>Villain</code></p>
</li>
<li>
<p><code>shouldRemoveAnItem</code>: checks that the <code>VillainResource</code> endpoint deletes a villain from the database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.junit.QuarkusTest</span>;
<span class="keyword">import</span> <span class="include">io.restassured.common.mapper.TypeRef</span>;
<span class="keyword">import</span> <span class="include">org.hamcrest.core.Is</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.MethodOrderer</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Order</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.TestMethodOrder</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Random</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.get</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.given</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.ACCEPT</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.CONTENT_TYPE</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.TEXT_PLAIN</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.BAD_REQUEST</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.CREATED</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.NO_CONTENT</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.OK</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers.is</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertTrue</span>;

<span class="annotation">@QuarkusTest</span>
<span class="annotation">@TestMethodOrder</span>(MethodOrderer.OrderAnnotation.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainResourceTest</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> JSON = <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json;charset=UTF-8</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine (updated)</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_OTHER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine chocolate in</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_OTHER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine chocolate in (updated)</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_chocolatine.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_chocolatine_updated.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">does not eat pain au chocolat</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">does not eat pain au chocolat (updated)</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> DEFAULT_LEVEL = <span class="integer">42</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> UPDATED_LEVEL = <span class="integer">43</span>;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NB_VILLAINS = <span class="integer">570</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> villainId;

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testHelloEndpoint() {
        given().header(ACCEPT, TEXT_PLAIN).when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains/hello</span><span class="delimiter">&quot;</span></span>).then().statusCode(<span class="integer">200</span>).body(is(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Villain Resource</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNotGetUnknownVillain() {
        <span class="predefined-type">Long</span> randomId = <span class="keyword">new</span> <span class="predefined-type">Random</span>().nextLong();
        given().pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, randomId).when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains/{id}</span><span class="delimiter">&quot;</span></span>).then().statusCode(NO_CONTENT.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldGetRandomVillain() {
        given().when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains/random</span><span class="delimiter">&quot;</span></span>).then().statusCode(OK.getStatusCode()).contentType(APPLICATION_JSON);
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNotAddInvalidItem() {
        Villain villain = <span class="keyword">new</span> Villain();
        villain.name = <span class="predefined-constant">null</span>;
        villain.otherName = DEFAULT_OTHER_NAME;
        villain.picture = DEFAULT_PICTURE;
        villain.powers = DEFAULT_POWERS;
        villain.level = <span class="integer">0</span>;

        given()
            .body(villain)
            .header(CONTENT_TYPE, JSON)
            .header(ACCEPT, JSON)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(BAD_REQUEST.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">1</span>)
    <span class="type">void</span> shouldGetInitialItems() {
        <span class="predefined-type">List</span>&lt;Villain&gt; villains = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .extract()
            .body()
            .as(getVillainTypeRef());
        assertEquals(NB_VILLAINS, villains.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">2</span>)
    <span class="type">void</span> shouldAddAnItem() {
        Villain villain = <span class="keyword">new</span> Villain();
        villain.name = DEFAULT_NAME;
        villain.otherName = DEFAULT_OTHER_NAME;
        villain.picture = DEFAULT_PICTURE;
        villain.powers = DEFAULT_POWERS;
        villain.level = DEFAULT_LEVEL;

        <span class="predefined-type">String</span> location = given()
            .body(villain)
            .header(CONTENT_TYPE, JSON)
            .header(ACCEPT, JSON)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(CREATED.getStatusCode())
            .extract()
            .header(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>);
        assertTrue(location.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// Stores the id</span>
        <span class="predefined-type">String</span><span class="type">[]</span> segments = location.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>);
        villainId = segments[segments.length - <span class="integer">1</span>];
        assertNotNull(villainId);

        given()
            .pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, villainId)
            .when()
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains/{id}</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">otherName</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_OTHER_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">level</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_LEVEL))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">picture</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_PICTURE))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">powers</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_POWERS));

        <span class="predefined-type">List</span>&lt;Villain&gt; villains = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .extract()
            .body()
            .as(getVillainTypeRef());
        assertEquals(NB_VILLAINS + <span class="integer">1</span>, villains.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">3</span>)
    <span class="type">void</span> testUpdatingAnItem() {
        Villain villain = <span class="keyword">new</span> Villain();
        villain.id = <span class="predefined-type">Long</span>.valueOf(villainId);
        villain.name = UPDATED_NAME;
        villain.otherName = UPDATED_OTHER_NAME;
        villain.picture = UPDATED_PICTURE;
        villain.powers = UPDATED_POWERS;
        villain.level = UPDATED_LEVEL;

        given()
            .body(villain)
            .header(CONTENT_TYPE, JSON)
            .header(ACCEPT, JSON)
            .when()
            .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">otherName</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_OTHER_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">level</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_LEVEL))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">picture</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_PICTURE))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">powers</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_POWERS));

        <span class="predefined-type">List</span>&lt;Villain&gt; villains = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .extract()
            .body()
            .as(getVillainTypeRef());
        assertEquals(NB_VILLAINS + <span class="integer">1</span>, villains.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">4</span>)
    <span class="type">void</span> shouldRemoveAnItem() {
        given().pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, villainId).when().delete(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains/{id}</span><span class="delimiter">&quot;</span></span>).then().statusCode(NO_CONTENT.getStatusCode());

        <span class="predefined-type">List</span>&lt;Villain&gt; villains = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .extract()
            .body()
            .as(getVillainTypeRef());
        assertEquals(NB_VILLAINS, villains.size());
    }

    <span class="directive">private</span> TypeRef&lt;<span class="predefined-type">List</span>&lt;Villain&gt;&gt; getVillainTypeRef() {
        <span class="keyword">return</span> <span class="keyword">new</span> TypeRef&lt;<span class="predefined-type">List</span>&lt;Villain&gt;&gt;() {
            <span class="comment">// Kept empty on purpose</span>
        };
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The tests and the application runs in the same JVM, meaning that the test can be injected with application <em>beans</em>.
This feature is very useful to test specific parts of the application.
However, in our case, we just execute HTTP requests to check the result.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Run the test either in the dev mode or using <code>./mvnw test</code>.
They should pass.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_building_production_package">Building production package</h4>
<div class="paragraph">
<p>Our service is not completely done yet, but let&#8217;s run it in <em>prod</em> mode.</p>
</div>
<div class="sect4">
<h5 id="_configuring_the_application">Configuring the application</h5>
<div class="paragraph">
<p>In <em>prod</em> mode, the dev services won&#8217;t be used.
We need to configure the application to connect to a <em>real</em> database.</p>
</div>
<div class="paragraph">
<p>The main way of obtaining connections to a database is to use a datasource.
In Quarkus, the out of the box datasource and connection pooling implementation is Agroal.<sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup></p>
</div>
<div class="paragraph">
<p>So, we need to configure the database access in the <code>src/main/resources/application.properties</code> file,
but only when the application runs in <em>prod</em> mode.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Add the following datasource configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">%prod.quarkus.datasource.username=superbad
%prod.quarkus.datasource.password=superbad
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/villains_database
%prod.quarkus.hibernate-orm.sql-load-script=import.sql</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>%prod</code> indicates that the property is only used when the application runs with the given profile.
We configure the access to the database, and force the data initialization (which would have been disabled by default in <em>prod</em> mode).</p>
</div>
</div>
<div class="sect4">
<h5 id="_running_the_infrastructure">Running the Infrastructure</h5>
<div class="paragraph">
<p>Before going further, be sure to run the infrastructure.
To execute this service, you need a database.
Let&#8217;s use Docker and docker compose to ease the installation of such infrastructure.</p>
</div>
<div class="paragraph">
<p>You should already have installed the infrastructure into the <code>infrastructure</code> directory.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now, just execute <code>docker compose -f docker-compose.yaml up -d</code> under the <code>infrastructure</code> directory.
You should see a few logs going on and then all the containers get started.</p>
</div>
<div class="paragraph">
<p>On Linux, use the <code>docker-compose-linux.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Listing 1. On Linux</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose-linux.yaml up -d</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>During the workshop, just leave all the containers up and running.
Then, after the workshop, remember to shut them down using: <code>docker compose -f docker-compose.yaml down</code>
 or  <code>docker compose -f docker-compose-linux.yaml down</code> on Linux
.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_packaging_and_running_the_application_2">Packaging and running the application</h5>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Stop the dev mode, and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw package</code></pre>
</div>
</div>
<div class="paragraph">
<p>As previously, you will get your application in <code>target/quarkus-app</code>, run it using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open your browser to <a href="http://localhost:8080/api/villains" class="bare">http://localhost:8080/api/villains</a>, and verify it displays the expected content.
Once done, stop the application using <code>CTRL+C</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest-configuration">Configuring the Villain Microservice</h3>
<div class="paragraph">
<p>Hardcoded values in our code are a no go (even if we all did it at some point).
In this guide, we learn how to configure our Villain API as well as some parts of Quarkus.</p>
</div>
<div class="sect3">
<h4 id="_configuring_logging">Configuring Logging</h4>
<div class="paragraph">
<p>In the <code>VillainResource</code>, we injected a logger.
That&#8217;s very useful to provide meaningful information about the execution.
But you often need to adjust the configuration, such as the log level.</p>
</div>
<div class="paragraph">
<p>Runtime configuration of logging is done through the normal <code>application.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.log.console.enable=true
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
quarkus.log.console.level=INFO
quarkus.log.console.darken=1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_quarkus_listening_port">Configuring Quarkus Listening Port</h4>
<div class="paragraph">
<p>Because we will end-up running several microservices, let&#8217;s configure Quarkus so it listens to a different port than 8080:
This is quite easy as we just need to add one property in the <code>application.properties</code> file:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">## HTTP configuration
quarkus.http.port=8084</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Changing the port is one of the rare configuration that cannot be done while the application is running.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>You would need to restart the application to change the port.</p>
</div>
<div class="paragraph">
<p>Hit <code>CTRL+C</code> to stop the application if it still running and restart it with: <code>./mvnw quarkus:dev</code>.
Then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8084/api/villains | jq</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_injecting_configuration_value">Injecting Configuration Value</h4>
<div class="paragraph">
<p>When we persist a new villain, we want to multiply the level by a value that can be configured (to reduce the level, so heroes will win the fights more easily).
For this, Quarkus uses MicroProfile Config to inject the configuration in the application.<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup>
The injection uses the <code>@ConfigProperty</code> annotation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When injecting a configured value, you can use <code>@Inject @ConfigProperty</code> or just <code>@ConfigProperty</code>.
The <code>@Inject</code> annotation is not necessary for members annotated with <code>@ConfigProperty</code>, a behavior which differs from <a href="https://microprofile.io/project/eclipse/microprofile-config">MicroProfile Config</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Edit the <code>VillainService</code>, and introduce the following configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ConfigProperty</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">level.multiplier</span><span class="delimiter">&quot;</span></span>, defaultValue=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>) <span class="type">double</span> levelMultiplier;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may need to add the following import statement if your IDE does not do it automatically: <code>import org.eclipse.microprofile.config.inject.ConfigProperty;</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you do not provide a value for this property, the application startup fails with <code>jakarta.enterprise.inject.spi.DeploymentException: No config value of type [int] exists for: level.multiplier</code>.
To avoid having to configure a value, we configure a default one (property <code>defaultValue</code>).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now, modify the <code>VillainService.persistVillain()</code> method to use the injected properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> Villain persistVillain(<span class="annotation">@Valid</span> Villain villain) {
        villain.level = (<span class="type">int</span>) <span class="predefined-type">Math</span>.round(villain.level * levelMultiplier);
        villain.persist();
        <span class="keyword">return</span> villain;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_configuration">Create the Configuration</h4>
<div class="paragraph">
<p>By default, Quarkus reads <code>application.properties</code>.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Edit the <code>src/main/resources/application.properties</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">level.multiplier=0.5</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_and_testing_the_application">Running and Testing the Application</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>If you didn&#8217;t already, start the application with <code>./mvnw quarkus:dev</code>.
Once started, create a new villain with the following cUrl command (notice the verbose option <code>-v</code> to see the HTTP response headers):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl -X POST -d  '{&quot;level&quot;:5, &quot;name&quot;:&quot;Super Bad&quot;, &quot;powers&quot;:&quot;Agility, Longevity&quot;}'  -H &quot;Content-Type: application/json&quot; http://localhost:8084/api/villains -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">&lt; HTTP/1.1 201 Created
&lt; Location: http://localhost:8084/api/villains/582</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we&#8217;ve passed a level of 5 to create this new villain.
The cURL command returns the location of the newly created villain.
Take this URL and do an HTTP GET on it.
You will see that the level has been decreased.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The example shows a newly created Villain with id <code>582</code>.
But this id could be different on your machine.
Just make sure to use the correct id in the next command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8084/api/villains/582 | jq

{
  &quot;id&quot;: 582,
  &quot;level&quot;: 3,
  &quot;name&quot;: &quot;Super Bad&quot;,
  &quot;powers&quot;: &quot;Agility, Longevity&quot;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may not know <code>jq</code>.
It&#8217;s an amazing tool to manipulate JSON in the shell.
More info on: <a href="https://stedolan.github.io/jq/" class="bare">https://stedolan.github.io/jq/</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hey! Wait a minute! It you enabled continuous testing, Quarkus should have warned you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">--
Running 2/8. Running: io.quarkus.workshop.superheroes.villain.VillainResourceTest#shouldAddAnItem()
Press [o] Toggle test output, [h] for more options&gt;WARNING: An illegal reflective access operation has occurred
2021-09-21 21:02:16,067 ERROR [io.qua.test] (Test runner thread) ==================== TEST REPORT #1 ====================
2021-09-21 21:02:16,067 ERROR [io.qua.test] (Test runner thread) Test VillainResourceTest#shouldAddAnItem() failed
: java.lang.AssertionError: 1 expectation failed.
JSON path level doesn't match.
Expected: is &lt;42&gt;
  Actual: &lt;21&gt;

        at io.restassured.internal.ValidatableResponseImpl.body(ValidatableResponseImpl.groovy)
        at io.quarkus.workshop.superheroes.villain.VillainResourceTest.shouldAddAnItem(VillainResourceTest.java:133)

2021-09-21 21:02:16,070 ERROR [io.qua.test] (Test runner thread) &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1 TEST FAILED &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests are failing now!
Indeed, they don&#8217;t know the multiplier.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Press <code>r</code> in the dev mode to run the tests.
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In the <code>application.properties</code> file, add: <code>%test.level.multiplier=1</code> which set the multiplier to 1 when running the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">All 8 tests are passing (0 skipped), 8 tests were run in 1722ms. Tests completed at 21:03:25.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest-openapi">Open API</h3>
<div class="paragraph">
<p>A Quarkus application can expose its API description through an OpenAPI specification.
Quarkus also lets you test it via a user-friendly UI named Swagger UI.</p>
</div>
<div class="paragraph">
<p>In this section, we will see how to use OpenAPI with Quarkus and introduce the dev console.</p>
</div>
<div class="sect3">
<h4 id="_directory_structure_3">Directory Structure</h4>
<div class="paragraph">
<p>In this module we will add extra class (<code>VillainApplication</code>) to the Villain API project.
You will end-up with the following directory structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-41ee2d5b485f1d6914ec23c00a0ce414.png" alt="Diagram" width="343" height="220">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_installing_the_openapi_extension">Installing the OpenAPI extension</h4>
<div class="paragraph">
<p>Quarkus proposes a <code>smallrye-openapi</code> extension compliant with the MicroProfile OpenAPI specification in order to generate your API OpenAPI v3 specification.<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup></p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To install the OpenAPI dependency, just run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:add-extension -Dextensions=&quot;smallrye-openapi&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will add the following dependency in the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>quarkus-smallrye-openapi<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_open_api">Open API</h4>
<div class="paragraph">
<p>Now, <em>curl</em> <code><a href="http://localhost:8084/q/openapi" class="bare">http://localhost:8084/q/openapi</a></code> endpoint with the command <code>curl <a href="http://localhost:8084/q/openapi" class="bare">http://localhost:8084/q/openapi</a></code> and you will see the following OpenAPI contract:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">openapi</span>: <span class="string"><span class="content">3.0.3</span></span>
<span class="key">info</span>:
  <span class="key">title</span>: <span class="string"><span class="content">rest-villains API</span></span>
  <span class="key">version</span>: <span class="string"><span class="content">1.0.0-SNAPSHOT</span></span>
<span class="key">paths</span>:
  <span class="key">/api/villains</span>:
    <span class="key">get</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
          <span class="key">content</span>:
            <span class="key">application/json</span>:
              <span class="key">schema</span>:
                <span class="key">type</span>: <span class="string"><span class="content">array</span></span>
                <span class="key">items</span>:
                  <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
    <span class="key">put</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">requestBody</span>:
        <span class="key">content</span>:
          <span class="key">application/json</span>:
            <span class="key">schema</span>:
              <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
          <span class="key">content</span>:
            <span class="key">application/json</span>:
              <span class="key">schema</span>:
                <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
    <span class="key">post</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">requestBody</span>:
        <span class="key">content</span>:
          <span class="key">application/json</span>:
            <span class="key">schema</span>:
              <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">201</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">Created</span></span>
  <span class="key">/api/villains/hello</span>:
    <span class="key">get</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
          <span class="key">content</span>:
            <span class="key">text/plain</span>:
              <span class="key">schema</span>:
                <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
  <span class="key">/api/villains/random</span>:
    <span class="key">get</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
          <span class="key">content</span>:
            <span class="key">application/json</span>:
              <span class="key">schema</span>:
                <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
  <span class="error">/api/villains/{id}</span>:
    <span class="key">get</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">parameters</span>:
      - <span class="string"><span class="content">name: id</span></span>
        <span class="key">in</span>: <span class="string"><span class="content">path</span></span>
        <span class="key">required</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">schema</span>:
          <span class="key">format</span>: <span class="string"><span class="content">int64</span></span>
          <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
          <span class="key">content</span>:
            <span class="key">application/json</span>:
              <span class="key">schema</span>:
                <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
    <span class="key">delete</span>:
      <span class="key">tags</span>:
      - <span class="string"><span class="content">Villain Resource</span></span>
      <span class="key">parameters</span>:
      - <span class="string"><span class="content">name: id</span></span>
        <span class="key">in</span>: <span class="string"><span class="content">path</span></span>
        <span class="key">required</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">schema</span>:
          <span class="key">format</span>: <span class="string"><span class="content">int64</span></span>
          <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
      <span class="key">responses</span>:
        <span class="key"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>:
          <span class="key">description</span>: <span class="string"><span class="content">No Content</span></span>
<span class="key">components</span>:
  <span class="key">schemas</span>:
    <span class="key">Villain</span>:
      <span class="key">required</span>:
      - <span class="string"><span class="content">name</span></span>
      - <span class="string"><span class="content">level</span></span>
      <span class="key">type</span>: <span class="string"><span class="content">object</span></span>
      <span class="key">properties</span>:
        <span class="key">id</span>:
          <span class="key">format</span>: <span class="string"><span class="content">int64</span></span>
          <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
        <span class="key">name</span>:
          <span class="key">maxLength</span>: <span class="string"><span class="content">50</span></span>
          <span class="key">minLength</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
        <span class="key">otherName</span>:
          <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
        <span class="key">level</span>:
          <span class="key">format</span>: <span class="string"><span class="content">int32</span></span>
          <span class="key">minimum</span>: <span class="string"><span class="content">1</span></span>
          <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
        <span class="key">picture</span>:
          <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
        <span class="key">powers</span>:
          <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
  <span class="key">securitySchemes</span>:
    <span class="key">SecurityScheme</span>:
      <span class="key">type</span>: <span class="string"><span class="content">http</span></span>
      <span class="key">description</span>: <span class="string"><span class="content">Authentication</span></span>
      <span class="key">scheme</span>: <span class="string"><span class="content">basic</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This contract lacks documentation.
The Eclipse MicroProfile OpenAPI allows you to customize the methods of your REST endpoint as well as the application.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>While having the OpenAPI specification is great, it can&#8217;t be consumed easily by humans.
In your browser, go to <a href="http://localhost:8084/q/dev" class="bare">http://localhost:8084/q/dev</a>.
This is the dev console.
It provides all the tools you need to develop your Quarkus application.
We will use it several times in this workshop.
Note that the dev console is only available in dev mode.</p>
</div>
<div class="paragraph">
<p>The Dev Console integrates Swagger, a UI to invoke your endpoints from the comfort of your browser.
Click on the "<em>Swagger UI</em>" button located in the "SmallRye OpenAPI" widget (<a href="http://localhost:8084/q/swagger-ui" class="bare">http://localhost:8084/q/swagger-ui</a>).</p>
</div>
<div class="paragraph">
<p>You will see all your endpoints listed.
Click on the "<em>GET</em>" button for the "/api/villains" path, then click on "<em>Try it out</em>" and finally on "Execute".
You can see the result immediately.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>When developing REST APIs, this UI is very convenient.
You can test your endpoint and immediately see the outcome.
If something does not please you, edit the code, go back to the browser, re-execute, and voil!</p>
</div>
<div class="sect4">
<h5 id="_customizing_methods">Customizing Methods</h5>
<div class="paragraph">
<p>The MicroProfile OpenAPI has a set of annotations to customize each REST endpoint method so the OpenAPI contract is richer and clearer for consumers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Operation</code>: Describes a single API operation on a path.</p>
</li>
<li>
<p><code>@APIResponse</code>: Corresponds to the OpenAPI Response model object which describes a single response from an API Operation</p>
</li>
<li>
<p><code>@Parameter</code>: The name of the parameter.</p>
</li>
<li>
<p><code>@RequestBody</code>: A brief description of the request body.</p>
</li>
</ul>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>This is what the <code>VillainResource</code> endpoint should look like once you have annotated it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;

<span class="keyword">import</span> <span class="include">java.net.URI</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">jakarta.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.DELETE</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.GET</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.POST</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.PUT</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Context</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Response</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriBuilder</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriInfo</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.Operation</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.enums.SchemaType</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Content</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.responses.APIResponse</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.tags.Tag</span>;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">org.jboss.resteasy.reactive.RestPath</span>;
<span class="keyword">import</span> <span class="include">org.jboss.resteasy.reactive.RestResponse</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Tag</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">villains</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainResource</span> {
    <span class="predefined-type">Logger</span> logger;
    VillainService service;

    <span class="directive">public</span> VillainResource(<span class="predefined-type">Logger</span> logger, VillainService service) {
        <span class="local-variable">this</span>.service = service;
        <span class="local-variable">this</span>.logger = logger;
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a random villain</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/random</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@APIResponse</span>(
        responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,
        content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Villain.class, required = <span class="predefined-constant">true</span>))
    )
    <span class="directive">public</span> RestResponse&lt;Villain&gt; getRandomVillain() {
        Villain villain = service.findRandomVillain();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Found random villain </span><span class="delimiter">&quot;</span></span> + villain);
        <span class="keyword">return</span> RestResponse.ok(villain);
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns all the villains from the database</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GET</span>
    <span class="annotation">@APIResponse</span>(
        responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,
        content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Villain.class, type = SchemaType.ARRAY))
    )
    <span class="directive">public</span> RestResponse&lt;<span class="predefined-type">List</span>&lt;Villain&gt;&gt; getAllVillains() {
        <span class="predefined-type">List</span>&lt;Villain&gt; villains = service.findAllVillains();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Total number of villains </span><span class="delimiter">&quot;</span></span> + villains.size());
        <span class="keyword">return</span> RestResponse.ok(villains);
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a villain for a given identifier</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>, content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Villain.class)))
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The villain is not found for a given identifier</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> RestResponse&lt;Villain&gt; getVillain(<span class="annotation">@RestPath</span> <span class="predefined-type">Long</span> id) {
        Villain villain = service.findVillainById(id);
        <span class="keyword">if</span> (villain != <span class="predefined-constant">null</span>) {
            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Found villain </span><span class="delimiter">&quot;</span></span> + villain);
            <span class="keyword">return</span> RestResponse.ok(villain);
        } <span class="keyword">else</span> {
            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">No villain found with id </span><span class="delimiter">&quot;</span></span> + id);
            <span class="keyword">return</span> RestResponse.noContent();
        }
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Creates a valid villain</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@POST</span>
    <span class="annotation">@APIResponse</span>(
        responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">201</span><span class="delimiter">&quot;</span></span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The URI of the created villain</span><span class="delimiter">&quot;</span></span>,
        content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = <span class="predefined-type">URI</span>.class))
    )
    <span class="directive">public</span> RestResponse&lt;<span class="predefined-type">Void</span>&gt; createVillain(<span class="annotation">@Valid</span> Villain villain, <span class="annotation">@Context</span> UriInfo uriInfo) {
        villain = service.persistVillain(villain);
        UriBuilder builder = uriInfo.getAbsolutePathBuilder().path(<span class="predefined-type">Long</span>.toString(villain.id));
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">New villain created with URI </span><span class="delimiter">&quot;</span></span> + builder.build().toString());
        <span class="keyword">return</span> RestResponse.created(builder.build());
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Updates an exiting  villain</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@PUT</span>
    <span class="annotation">@APIResponse</span>(
        responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The updated villain</span><span class="delimiter">&quot;</span></span>,
        content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Villain.class))
    )
    <span class="directive">public</span> RestResponse&lt;Villain&gt; updateVillain(<span class="annotation">@Valid</span> Villain villain) {
        villain = service.updateVillain(villain);
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Villain updated with new valued </span><span class="delimiter">&quot;</span></span> + villain);
        <span class="keyword">return</span> RestResponse.ok(villain);
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Deletes an exiting villain</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@DELETE</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> RestResponse&lt;<span class="predefined-type">Void</span>&gt; deleteVillain(<span class="annotation">@RestPath</span> <span class="predefined-type">Long</span> id) {
        service.deleteVillain(id);
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Villain deleted with </span><span class="delimiter">&quot;</span></span> + id);
        <span class="keyword">return</span> RestResponse.noContent();
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN)
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Villain Resource</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this new code, go back to the Swagger UI at <a href="http://localhost:8084/q/swagger-ui" class="bare">http://localhost:8084/q/swagger-ui</a> and refresh.
Your endpoints are organized by tags, and each annotated endpoint is documented.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Documenting REST API is essential when working with different teams.
You can see OpenAPI as the JavaDoc for REST.</p>
</div>
</div>
<div class="sect4">
<h5 id="_customizing_the_application">Customizing the Application</h5>
<div class="paragraph">
<p>The previous annotations allow you to customize the contract for a given REST Endpoint.
But it&#8217;s also important to document the entire application.</p>
</div>
<div class="paragraph">
<p>The Microprofile OpenAPI also has a set of annotation to do so.
The difference is that these annotations cannot be used on the endpoint methods, but instead on another Java class configuring the entire application.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For this, you need to create the <code>src/main/java/io/quarkus/workshop/superheroes/villain/VillainApplication</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">jakarta.ws.rs.ApplicationPath</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Application</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.ExternalDocumentation</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.OpenAPIDefinition</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.info.Contact</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.info.Info</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.servers.Server</span>;

<span class="annotation">@ApplicationPath</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@OpenAPIDefinition</span>(
    info = <span class="annotation">@Info</span>(
        title = <span class="string"><span class="delimiter">&quot;</span><span class="content">Villain API</span><span class="delimiter">&quot;</span></span>,
        description = <span class="string"><span class="delimiter">&quot;</span><span class="content">This API allows CRUD operations on a villain</span><span class="delimiter">&quot;</span></span>,
        version = <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>,
        contact = <span class="annotation">@Contact</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Quarkus</span><span class="delimiter">&quot;</span></span>, url = <span class="string"><span class="delimiter">&quot;</span><span class="content">https://github.com/quarkusio</span><span class="delimiter">&quot;</span></span>)
    ),
    servers = { <span class="annotation">@Server</span>(url = <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8084</span><span class="delimiter">&quot;</span></span>) },
    externalDocs = <span class="annotation">@ExternalDocumentation</span>(url = <span class="string"><span class="delimiter">&quot;</span><span class="content">https://github.com/quarkusio/quarkus-workshops</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">All the Quarkus workshops</span><span class="delimiter">&quot;</span></span>)
)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainApplication</span> <span class="directive">extends</span> Application {
    <span class="comment">// Empty body</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go back to the Swagger UI and refresh again.
At the top of the document, you can see the version and the global API documentation.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_customized_contract">Customized Contract</h5>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>If you go back to the <code><a href="http://localhost:8084/q/openapi" class="bare">http://localhost:8084/q/openapi</a></code> endpoint you will see the following OpenAPI contract:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">openapi</span>: <span class="string"><span class="content">3.0.3</span></span>
<span class="key">info</span>:
    <span class="key">title</span>: <span class="string"><span class="content">Villain API</span></span>
    <span class="key">description</span>: <span class="string"><span class="content">This API allows CRUD operations on a villain</span></span>
    <span class="key">contact</span>:
        <span class="key">name</span>: <span class="string"><span class="content">Quarkus</span></span>
        <span class="key">url</span>: <span class="string"><span class="content">https://github.com/quarkusio</span></span>
    <span class="key">version</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>
<span class="key">externalDocs</span>:
    <span class="key">description</span>: <span class="string"><span class="content">All the Quarkus workshops</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">https://github.com/quarkusio/quarkus-workshops</span></span>
<span class="key">servers</span>:
    -   <span class="string"><span class="content">url: http://localhost:8084</span></span>
<span class="key">tags</span>:
    -   <span class="string"><span class="content">name: villains</span></span>
<span class="key">paths</span>:
    <span class="key">/api/villains</span>:
        <span class="key">get</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">summary</span>: <span class="string"><span class="content">Returns all the villains from the database</span></span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
                    <span class="key">content</span>:
                        <span class="key">application/json</span>:
                            <span class="key">schema</span>:
                                <span class="key">type</span>: <span class="string"><span class="content">array</span></span>
                                <span class="key">items</span>:
                                    <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
        <span class="key">put</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">summary</span>: <span class="string"><span class="content">Updates an exiting  villain</span></span>
            <span class="key">requestBody</span>:
                <span class="key">content</span>:
                    <span class="key">application/json</span>:
                        <span class="key">schema</span>:
                            <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">The updated villain</span></span>
                    <span class="key">content</span>:
                        <span class="key">application/json</span>:
                            <span class="key">schema</span>:
                                <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
        <span class="key">post</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">summary</span>: <span class="string"><span class="content">Creates a valid villain</span></span>
            <span class="key">requestBody</span>:
                <span class="key">content</span>:
                    <span class="key">application/json</span>:
                        <span class="key">schema</span>:
                            <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">201</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">The URI of the created villain</span></span>
                    <span class="key">content</span>:
                        <span class="key">application/json</span>:
                            <span class="key">schema</span>:
                                <span class="key">format</span>: <span class="string"><span class="content">uri</span></span>
                                <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
    <span class="key">/api/villains/hello</span>:
        <span class="key">get</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
                    <span class="key">content</span>:
                        <span class="key">text/plain</span>:
                            <span class="key">schema</span>:
                                <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
    <span class="key">/api/villains/random</span>:
        <span class="key">get</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">summary</span>: <span class="string"><span class="content">Returns a random villain</span></span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
                    <span class="key">content</span>:
                        <span class="key">application/json</span>:
                            <span class="key">schema</span>:
                                <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
    <span class="error">/api/villains/{id}</span>:
        <span class="key">get</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">summary</span>: <span class="string"><span class="content">Returns a villain for a given identifier</span></span>
            <span class="key">parameters</span>:
                -   <span class="string"><span class="content">name: id</span></span>
                    <span class="key">in</span>: <span class="string"><span class="content">path</span></span>
                    <span class="key">required</span>: <span class="string"><span class="content">true</span></span>
                    <span class="key">schema</span>:
                        <span class="key">format</span>: <span class="string"><span class="content">int64</span></span>
                        <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">OK</span></span>
                    <span class="key">content</span>:
                        <span class="key">application/json</span>:
                            <span class="key">schema</span>:
                                <span class="error">$ref</span>: <span class="error">'#/components/schemas/Villain'</span>
                <span class="key"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">The villain is not found for a given identifier</span></span>
        <span class="key">delete</span>:
            <span class="key">tags</span>:
                - <span class="string"><span class="content">villains</span></span>
            <span class="key">summary</span>: <span class="string"><span class="content">Deletes an exiting villain</span></span>
            <span class="key">parameters</span>:
                -   <span class="string"><span class="content">name: id</span></span>
                    <span class="key">in</span>: <span class="string"><span class="content">path</span></span>
                    <span class="key">required</span>: <span class="string"><span class="content">true</span></span>
                    <span class="key">schema</span>:
                        <span class="key">format</span>: <span class="string"><span class="content">int64</span></span>
                        <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
            <span class="key">responses</span>:
                <span class="key"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>:
                    <span class="key">description</span>: <span class="string"><span class="content">No Content</span></span>
<span class="key">components</span>:
    <span class="key">schemas</span>:
        <span class="key">Villain</span>:
            <span class="key">required</span>:
                - <span class="string"><span class="content">name</span></span>
                - <span class="string"><span class="content">level</span></span>
            <span class="key">type</span>: <span class="string"><span class="content">object</span></span>
            <span class="key">properties</span>:
                <span class="key">id</span>:
                    <span class="key">format</span>: <span class="string"><span class="content">int64</span></span>
                    <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
                <span class="key">name</span>:
                    <span class="key">maxLength</span>: <span class="string"><span class="content">50</span></span>
                    <span class="key">minLength</span>: <span class="string"><span class="content">3</span></span>
                    <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
                <span class="key">otherName</span>:
                    <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
                <span class="key">level</span>:
                    <span class="key">format</span>: <span class="string"><span class="content">int32</span></span>
                    <span class="key">minimum</span>: <span class="string"><span class="content">1</span></span>
                    <span class="key">type</span>: <span class="string"><span class="content">integer</span></span>
                <span class="key">picture</span>:
                    <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
                <span class="key">powers</span>:
                    <span class="key">type</span>: <span class="string"><span class="content">string</span></span>
    <span class="key">securitySchemes</span>:
        <span class="key">SecurityScheme</span>:
            <span class="key">type</span>: <span class="string"><span class="content">http</span></span>
            <span class="key">description</span>: <span class="string"><span class="content">Authentication</span></span>
            <span class="key">scheme</span>: <span class="string"><span class="content">basic</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can expose or exchange this contract to the API consumers, so they now what to expect when using your API.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openapi_tests_in_villainresourcetest">OpenAPI Tests in VillainResourceTest</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Let&#8217;s add an extra test method in <code>VillainResourceTest</code> ensuring that the OpenAPI specification is packaged with the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> shouldPingOpenAPI() {
    given().header(ACCEPT, JSON).when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/q/openapi</span><span class="delimiter">&quot;</span></span>).then().statusCode(OK.getStatusCode());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the test:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From the dev mode, or</p>
</li>
<li>
<p>By executing the test using <code>./mvnw test</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have any problem with the code, don&#8217;t understand or feel you are running, remember to ask for some help.
Also, you can get the code of this entire workshop from <a href="https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes" class="bare">https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes</a>.
You can also download the completed code from <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop-complete.zip" class="bare">https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop-complete.zip</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quarkus">Quarkus</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>In the previous chapter, you had a quick peek at Quarkus and how you can build HTTP / REST-based applications with it.
But that was just the beginning; Quarkus can do a lot more, which is the purpose of this chapter.
In this chapter, you are going to see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What&#8217;s Quarkus? and how does it change the Java landscape</p>
</li>
<li>
<p>What are the main Quarkus idea, and how it helps in the <em>cloud native world</em></p>
</li>
<li>
<p>The Quarkus build process, in other words, the <em>secret sauce number 1</em></p>
</li>
<li>
<p>The Quarkus reactive nature, in other words, the <em>secret sauce number 2</em></p>
</li>
<li>
<p>Some Quarkus features such as the application lifecycle support</p>
</li>
<li>
<p>How you can use Quarkus to generate native executable</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="quarkus-definition">What&#8217;s Quarkus?</h3>
<div class="paragraph">
<p>Java was born more than 25 years ago.
The world 25 years ago was quite different.
The software industry has gone through several revolutions over these two decades.
Java has always been able to reinvent itself to stay relevant.</p>
</div>
<div class="paragraph">
<p>But a new revolution is happening.
While for years, most applications were running on huge machines, with lots of CPU and memory, they are now running on the Cloud, in constrained environments, in containers, where the resources are shared.
Density is the new optimization: crank as many mini-apps (or microservices) as possible per node.
And scale by adding more instances of an app instead of a more powerful single instance.</p>
</div>
<div class="paragraph">
<p>The Java ergonomics, designed 20 years ago, do not fit well in this new environment.
Java applications were designed to run 24/7 for months, even years.
The JIT is optimizing the execution over time; the GC manages the memory efficiently&#8230;&#8203;
But all these features have a cost, and the memory required to run Java applications and startup times are showstoppers when you deploy 20 or 50 microservices instead of one application.
The issue is not the JVM itself; it&#8217;s also the Java ecosystem that needs to be reinvented.</p>
</div>
<div class="paragraph">
<p>That&#8217;s where Quarkus, and other projects, enter the game.
Quarkus uses a build time principle.<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup>
During the build of the application, tasks that usually happen at runtime are executed at build time.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/quarkus-build-time-principle.png" alt="quarkus build time principle">
</div>
</div>
<div class="paragraph">
<p>Thus, when the application runs, everything has been pre-computed, and all the annotation scanning, XML parsing, and so on won&#8217;t be executed anymore.
It has two direct benefits: startup time (a lot faster) and memory consumption (a lot lower).</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/quarkus-augmentation.png" alt="quarkus augmentation">
</div>
</div>
<div class="paragraph">
<p>So, as depicted in the figure above, Quarkus does bring an infrastructure for frameworks to embrace build time metadata discovery (like annotations), replace proxies with generated classes, pre-configure most frameworks, and handle dependency injection at build time.</p>
</div>
<div class="paragraph">
<p>Also, during the build, Quarkus detects which class needs to be accessed by reflection at runtime, boots framework at build time to record the result, and generally offers a lot of GraalVM optimization for free (or cheap at least).
Indeed, thanks to all this metadata, Quarkus can configure native compilers such as the GraalVM compiler to generate a native executable for your Java application.
Thanks to an aggressive dead-code elimination, the final executable is smaller, faster to start, and uses a ridiculously small amount of memory.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/quarkus-native-compilation.png" alt="quarkus native compilation">
</div>
</div>
<div class="paragraph">
<p>Quarkus does not stop there.
As you have seen in the previous chapter, it proposes a stellar developer experience.
It also unifies reactive and imperative to let you decide how you want to handle I/O. It allows implementing both REST and event-driven applications using a consistent model.
To do this, Quarkus is based on a reactive core allowing high concurrency and reducing memory consumption.</p>
</div>
<div class="paragraph">
<p>Quarkus detects if your method can be called on the I/O thread and follows the reactive execution model; or if your method must be called on a worker thread and follows the imperative execution model.</p>
</div>
<div class="paragraph">
<p>Ok, but enough talking, time to see this in action.</p>
</div>
</div>
<div class="sect2">
<h3 id="quarkus-augmentation">Quarkus Augmentation</h3>
<div class="paragraph">
<p>Let&#8217;s demystify all this.</p>
</div>
<div class="paragraph">
<p>So far, you have developed the super-villains microservice.
This microservice is relatively simple.
It still has database access, ORM support, transaction, JSON serialization, and deserialization.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Let&#8217;s now package this application using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw package</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the log, you can see actions happening during what Quarkus calls the <em>augmentation</em> phase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">[INFO] --- quarkus-maven-plugin:3.6.0:build (default) @ rest-villains ---
[INFO] [org.jboss.threads] JBoss Threads version 3.4.2.Final
[INFO] [org.hibernate.Version] HHH000412: Hibernate ORM core version 5.5.7.Final
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 1932ms</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this log, you can observe the <em>build</em> principle.
Typically, about Hibernate, it saves from having to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>embed an XML parser at runtime,</p>
</li>
<li>
<p>Do the actual parsing,</p>
</li>
<li>
<p>Configure Hibernate based on the content of the file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With Quarkus, at runtime, almost everything is already configured.
Only runtime configuration properties are applied at startup (such as database URLs).</p>
</div>
<div class="paragraph">
<p>Also, during this augmentation, Java classes are generated or extended.
Remember the <code>Villain</code> Panache entity.
The class is extended during the <em>augmentation</em>.
If you run <code>javap --class-path target/quarkus-app/quarkus/transformed-bytecode.jar io.quarkus.workshop.superheroes.villain.Villain</code>, you can see methods prefixed with <code>$$</code> added to the class.</p>
</div>
<div class="paragraph">
<p>Each <em>extension</em> can combine build time and run time.
The following figure presents some of the extensions you already used, but there are a lot more.
We are going to learn more about extensions later in this workshop and even build one.
What&#8217;s important to understand for now is that the magic is packaged into extension, and every time you add a <code>quarkus-</code> dependency to your <code>pom.xml</code> file, you enable an extension.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/quarkus-extensions.png" alt="quarkus extensions">
</div>
</div>
</div>
<div class="sect2">
<h3 id="quarkus-lifecycle">Application Lifecycle</h3>
<div class="paragraph">
<p>Now that you know how Quarkus is structured let&#8217;s continue using various extensions.
You often need to execute custom actions when the application starts and clean up everything when the application stops.
In this module, we will display a banner in the logs once the Villain microservice has started.</p>
</div>
<div class="sect3">
<h4 id="_directory_structure_4">Directory Structure</h4>
<div class="paragraph">
<p>In this section, we will add an extra class (<code>VillainApplicationLifeCycle</code>) to handle the Villain API lifecycle.
You will end up with the following directory structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-c0e71dfef9a8c6bfc3196247f13073cf.png" alt="Diagram" width="365" height="234">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_displaying_a_banner">Displaying a Banner</h4>
<div class="paragraph">
<p>When our application starts, the logs are dull and lack a banner (any decent application <strong>must</strong> have a banner nowadays).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>So the first thing that you need to do is to go to the <a href="http://patorjk.com/software/taag">following website</a> and pick up your favorite "Villain API" text banner.</p>
</div>
<div class="paragraph">
<p>Create a new class named <code>VillainApplicationLifeCycle</code> (or pick another name, the name does not matter) in the <code>io.quarkus.workshop.superheroes.villain</code> package, and copy your banner, so you end up with something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.villain</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.runtime.ShutdownEvent</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.runtime.StartupEvent</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.runtime.configuration.ConfigUtils</span>;
<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.enterprise.event.Observes</span>;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VillainApplicationLifeCycle</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = <span class="predefined-type">Logger</span>.getLogger(VillainApplicationLifeCycle.class);

    <span class="type">void</span> onStart(<span class="annotation">@Observes</span> StartupEvent ev) {
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content"> __     ___ _ _       _             _    ____ ___ </span><span class="delimiter">&quot;</span></span>);
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="char">\\</span><span class="content"> </span><span class="char">\\</span><span class="content">   / (_) | | __ _(_)_ __       / </span><span class="char">\\</span><span class="content">  |  _ </span><span class="char">\\</span><span class="content">_ _|</span><span class="delimiter">&quot;</span></span>);
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">  </span><span class="char">\\</span><span class="content"> </span><span class="char">\\</span><span class="content"> / /| | | |/ _` | | '_ </span><span class="char">\\</span><span class="content">     / _ </span><span class="char">\\</span><span class="content"> | |_) | | </span><span class="delimiter">&quot;</span></span>);
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">   </span><span class="char">\\</span><span class="content"> V / | | | | (_| | | | | |   / ___ </span><span class="char">\\</span><span class="content">|  __/| | </span><span class="delimiter">&quot;</span></span>);
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">    </span><span class="char">\\</span><span class="content">_/  |_|_|_|</span><span class="char">\\</span><span class="content">__,_|_|_| |_|  /_/   </span><span class="char">\\</span><span class="content">_</span><span class="char">\\</span><span class="content">_|  |___|</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="type">void</span> onStop(<span class="annotation">@Observes</span> ShutdownEvent ev) {
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">The application VILLAIN is stopping...</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Thanks to the CDI <code>@Observes</code>, the <code>VillainApplicationLifeCycle</code> is invoked.
On startup with the <code>StartupEvent</code> so it can execute code (here, displaying the banner) when the application is starting</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Run the application with: <code>./mvnw quarkus:dev</code>, the banner is printed to the console.
When the application is stopped, the second log message is printed.</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your application is still running, just send an HTTP request, like go to <a href="http://localhost:8084" class="bare">http://localhost:8084</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The method is called by ArC, the dependency injection framework used by Quarkus.
Arc embraces the build-time principle, meaning that injection happens at build time.
In addition, Arc can detect and remove unused beans at runtime, saving memory.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>With the application running in dev mode, open your browser to <a href="http://localhost:8084/q/dev/" class="bare">http://localhost:8084/q/dev/</a>.
In the ArC widget, you can see the number of beans that have been removed ("Removed Beans"), and if you click on the link, see the list.
If you click on the "Observers" link, you will see the two methods we added.
In the "Fired Events" view, you can see which event has been fired and when.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="quarkus-profile">Configuration Profiles</h3>
<div class="paragraph">
<p>Quarkus supports the notion of configuration profiles.
These allow you to have multiple configurations in the same file and select between them via a profile name.</p>
</div>
<div class="paragraph">
<p>Quarkus has three profiles by default, although it is possible to use as many as you like. The default profiles are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dev</code> - Activated when in development mode (i.e. <code>quarkus:dev</code>)</p>
</li>
<li>
<p><code>test</code> - Activated when running tests</p>
</li>
<li>
<p><code>prod</code> - The default profile when not running in development or test mode</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s change the <code>VillainApplicationLifeCycle</code> so it displays the current profile.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that, just add a log invoking <code>ConfigUtils.getProfiles()</code> in the <code>onStart()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">The application VILLAIN is starting with profile </span><span class="delimiter">&quot;</span></span> + ConfigUtils.getProfiles());</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If not already done, you need to add the following import statement: <code>import io.quarkus.runtime.configuration.ConfigUtils;</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the <code>application.properties</code> file, you can prefix a property with the profile.
For example, we did add the <code>%test.level.multiplier=1</code> property in the previous chapter.
It indicates that the property <code>level.multiplier</code> is set to 1 in the <code>test</code> profile.</p>
</div>
<div class="paragraph">
<p>Now, you will get the <code>dev</code> profile enabled if you start your application in dev mode with <code>./mvnw compile quarkus:dev</code>.
If you start the tests, the <code>test</code> profile is enabled (the <code>multiplier</code> is set to 1).</p>
</div>
<div class="paragraph">
<p>You can also create your own profiles, and activate them with the <code>quarkus.profile</code> property.
For example, to use a profile called <code>foo</code>, package your application with <code>./mvnw package</code>, and start it with <code>java -Dquarkus.profile=foo -jar target/quarkus-app/quarkus-run.jar</code>.
You will see that the <code>foo</code> profile is enabled.
As not overridden, the <code>level.multiplier</code> property has the value 0.5.</p>
</div>
<div class="paragraph">
<p>Profiles are handy to customize the configuration per environment.
We are going to see an example of such customization in the next section.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive">Reactive</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>Quarkus combines the build time principle with a reactive core.
The combination of these two characteristics improves the application concurrency and makes use of resources more efficiently.
In this chapter, we will see the counterpart of the Villain microservice: the Hero microservice!
Instead of the imperative approach used for the villains, we will use reactive programming and Hibernate Reactive.
The logic of the microservice is the same.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-c5821fb9501d70d4e2c01bbd1c31fce8.png" alt="Diagram" width="300" height="671">
</div>
</div>
<div class="paragraph">
<p>In the following sections, you will learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to create a new reactive Quarkus application</p>
</li>
<li>
<p>How to implement REST API using JAX-RS and the RESTEasy Reactive extension using a reactive development model</p>
</li>
<li>
<p>How to access your database using Hibernate Reactive with Panache</p>
</li>
<li>
<p>How to use transactions the reactive way</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This service is exposed on the port 8083.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_why_reactive">Why reactive?</h3>
<div class="paragraph">
<p>"Reactive" is a set of principles to build <em>better</em> distributed systems.
By following these principles, you create more elastic and resilient systems.</p>
</div>
<div class="paragraph">
<p>One of the central aspects of being reactive is about using non-blocking I/O to handle remote interactions efficiently.
With a few threads, your application can handle many concurrent I/Os.
A consequence of such usage is the need to implement applications that do not block these threads.
There are multiple approaches to do so, such as callbacks, co-routines, and reactive programming.</p>
</div>
<div class="paragraph">
<p>Quarkus encourages users to use Mutiny, an intuitive and event-driven reactive programming library.
In this section, we will cover the basics of Mutiny and implement an entirely reactive microservice.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hero_microservice">Hero Microservice</h3>
<div class="paragraph">
<p>New microservice, new project!</p>
</div>
<div class="paragraph">
<p>The easiest way to create this new Quarkus project is to use the Quarkus Maven plugin.
Open a terminal and run the following command under the <code>quarkus-workshop-super-heroes/super-heroes</code> directory</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw io.quarkus:quarkus-maven-plugin:3.6.0:create \
    -DplatformVersion=3.6.0 \
    -DprojectGroupId=io.quarkus.workshop.super-heroes \
    -DprojectArtifactId=rest-heroes \
    -DclassName=&quot;io.quarkus.workshop.superheroes.hero.HeroResource&quot; \
    -Dpath=&quot;api/heroes&quot; \
    -Dextensions=&quot;resteasy-reactive-jackson,quarkus-hibernate-validator,quarkus-smallrye-openapi,quarkus-hibernate-reactive-panache,quarkus-reactive-pg-client&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, we can select multiple extensions during the project creation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>resteasy-reactive-jackson</code> provides RESTEasy Reactive and the ability to map JSON objects,</p>
</li>
<li>
<p><code>quarkus-hibernate-validator</code> provides the Hibernate Validator support,</p>
</li>
<li>
<p><code>quarkus-smallrye-openapi</code> provides the OpenAPI descriptor support and the Swagger UI in the dev console,</p>
</li>
<li>
<p><code>quarkus-hibernate-reactive-panache</code> provides Panache entity supports using Hibernate Reactive, an ORM using reactive database drivers,</p>
</li>
<li>
<p><code>quarkus-reactive-pg-client</code> provides the reactive database driver used by Hibernate Reactive to interact with PostGreSQL databases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want your IDE to manage this new Maven project, you can declare it in the parent POM by adding this new module in the <code>&lt;modules&gt;</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;module&gt;</span>super-heroes/rest-heroes<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_directory_structure_5">Directory Structure</h4>
<div class="paragraph">
<p>At the end of this chapter, you will end up with the following directory structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-4cd74d521582cd753cc00b2256e446f3.png" alt="Diagram" width="257" height="443">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_hero_entity">The Hero entity</h4>
<div class="paragraph">
<p>Let&#8217;s start with the <code>Hero</code> entity class.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the <code>io.quarkus.workshop.superheroes.hero.Hero</code> class in the created project with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.hero</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.hibernate.reactive.panache.PanacheEntity</span>;
<span class="keyword">import</span> <span class="include">io.smallrye.mutiny.Uni</span>;

<span class="keyword">import</span> <span class="include">jakarta.persistence.Column</span>;
<span class="keyword">import</span> <span class="include">jakarta.persistence.Entity</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.Min</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.Size</span>;

<span class="keyword">import</span> <span class="include">java.util.Random</span>;

<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Hero</span> <span class="directive">extends</span> PanacheEntity {

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Size</span>(min = <span class="integer">3</span>, max = <span class="integer">50</span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> <span class="predefined-type">String</span> otherName;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Min</span>(<span class="integer">1</span>)
    <span class="directive">public</span> <span class="type">int</span> level;
    <span class="directive">public</span> <span class="predefined-type">String</span> picture;

    <span class="annotation">@Column</span>(columnDefinition = <span class="string"><span class="delimiter">&quot;</span><span class="content">TEXT</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> powers;

    <span class="directive">public</span> <span class="directive">static</span> Uni&lt;Hero&gt; findRandom() {
        <span class="predefined-type">Random</span> random = <span class="keyword">new</span> <span class="predefined-type">Random</span>();
        <span class="keyword">return</span> count()
            .map(count -&gt; random.nextInt(count.intValue()))
            .chain(randomHero -&gt; findAll().page(randomHero, <span class="integer">1</span>)
                .firstResult());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hero{</span><span class="delimiter">&quot;</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">id=</span><span class="delimiter">&quot;</span></span> + id +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, name='</span><span class="delimiter">&quot;</span></span> + name + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, otherName='</span><span class="delimiter">&quot;</span></span> + otherName + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, level=</span><span class="delimiter">&quot;</span></span> + level +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, picture='</span><span class="delimiter">&quot;</span></span> + picture + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">&quot;</span><span class="content">, powers='</span><span class="delimiter">&quot;</span></span> + powers + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
            <span class="string"><span class="delimiter">'</span><span class="content">}</span><span class="delimiter">'</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>First, note that we are extending <code>io.quarkus.hibernate.reactive.panache.PanacheEntity</code>.
It&#8217;s the reactive variant of <code>import io.quarkus.hibernate.orm.panache.PanacheEntity</code>.
As a consequence, methods are asynchronous, and instead of returning an object, they return asynchronous structure that will let you know when the object is ready to be consumed.</p>
</div>
<div class="paragraph">
<p>The field part is the same as for the Villain.
The <code>toString</code> method is also equivalent.</p>
</div>
<div class="paragraph">
<p>The major difference is the <code>findRandom</code> method.
Instead of returning a <code>Hero</code>, it returns a <code>Uni&lt;Hero</code>.
A <code>Uni</code> represents an asynchronous action.
Unlike with the imperative development model, we cannot block the thread waiting for the result.
Here, we need to register a <em>continuation</em> invoked when the result is available.
During that time, the thread is released and can be used to handle another request.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s split the <code>findRandom</code> method to better understand what&#8217;s going on:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>count()</code> returns a <code>Uni&lt;Long&gt;</code> with the number of heroes stored in the database,</p>
</li>
<li>
<p>when this count is retrieved from the database, it transforms the result into a random number,</p>
</li>
<li>
<p>when this is computed, it chains the processing with another asynchronous action which retrieve the hero located at the random index.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As a consequence this method returns a <code>Uni&lt;Hero&gt;</code>.
The consumer will need to register a continuation to receive the <code>Hero</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_uni_api_in_2_minutes">Uni API in 2 minutes</h4>
<div class="paragraph">
<p>Uni comes from <a href="https://smallrye.io/smallrye-mutiny">Mutiny</a>, an intuitive, event-driven reactive programming library.</p>
</div>
<div class="paragraph">
<p>There are a few method to understand to use <code>Uni</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>map</code> : transforms (synchronously) an item when this item becomes available.</p>
</li>
<li>
<p><code>chain</code>: transforms an item, when it become available, into another <code>Uni</code>. The outcome will be the outcome of the produced <code>Uni</code>.</p>
</li>
<li>
<p><code>replaceWith</code>: replaces an item with something else.</p>
</li>
<li>
<p><code>invoke</code>: invokes the method when the item becomes available. It does not modify the item.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Uni</code> is lazy. To trigger the computation you need to subscribe to it.
However, most of the time, Quarkus handles the subscription for us.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_hero_resource">The Hero Resource</h4>
<div class="paragraph">
<p>Unlike the <code>VillainResource</code>, the <code>HeroResource</code> uses the reactive development model.
It returns asynchronous structures (<code>Uni</code>)<sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnotedef_16" title="View footnote.">16</a>]</sup>.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Open the <code>HeroResource</code> and update the content to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.hero</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.hibernate.reactive.panache.common.WithTransaction</span>;
<span class="keyword">import</span> <span class="include">io.smallrye.mutiny.Uni</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.Operation</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.enums.SchemaType</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Content</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.responses.APIResponse</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.tags.Tag</span>;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">org.jboss.resteasy.reactive.RestPath</span>;
<span class="keyword">import</span> <span class="include">org.jboss.resteasy.reactive.RestResponse</span>;


<span class="keyword">import</span> <span class="include">jakarta.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.DELETE</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.GET</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.POST</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.PUT</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Context</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Response</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriBuilder</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriInfo</span>;

<span class="keyword">import</span> <span class="include">java.net.URI</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Tag</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">heroes</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">HeroResource</span> {

    <span class="predefined-type">Logger</span> logger;

    <span class="directive">public</span> HeroResource(<span class="predefined-type">Logger</span> logger) {
        <span class="local-variable">this</span>.logger = logger;
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a random hero</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/random</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>, content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Hero.class, required = <span class="predefined-constant">true</span>)))
    <span class="directive">public</span> Uni&lt;RestResponse&lt;Hero&gt;&gt; getRandomHero() {
        <span class="keyword">return</span> Hero.findRandom()
            .onItem().ifNotNull().transform(h -&gt; {
                <span class="local-variable">this</span>.logger.debugf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Found random hero: %s</span><span class="delimiter">&quot;</span></span>, h);
                <span class="keyword">return</span> RestResponse.ok(h);
            })
            .onItem().ifNull().continueWith(() -&gt; {
                <span class="local-variable">this</span>.logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">No random villain found</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">return</span> RestResponse.notFound();
            });
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns all the heroes from the database</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GET</span>
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>, content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Hero.class, type = SchemaType.ARRAY)))
    <span class="directive">public</span> Uni&lt;<span class="predefined-type">List</span>&lt;Hero&gt;&gt; getAllHeroes() {
        <span class="keyword">return</span> Hero.listAll();
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a hero for a given identifier</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>, content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Hero.class)))
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The hero is not found for a given identifier</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Uni&lt;RestResponse&lt;Hero&gt;&gt; getHero(<span class="annotation">@RestPath</span> <span class="predefined-type">Long</span> id) {
        <span class="keyword">return</span> Hero.&lt;Hero&gt;findById(id)
            .map(hero -&gt; {
                <span class="keyword">if</span> (hero != <span class="predefined-constant">null</span>) {
                    <span class="keyword">return</span> RestResponse.ok(hero);
                }
                logger.debugf(<span class="string"><span class="delimiter">&quot;</span><span class="content">No Hero found with id %d</span><span class="delimiter">&quot;</span></span>, id);
                <span class="keyword">return</span> RestResponse.noContent();
            });
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Creates a valid hero</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@POST</span>
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">201</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The URI of the created hero</span><span class="delimiter">&quot;</span></span>, content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = <span class="predefined-type">URI</span>.class)))
    <span class="annotation">@WithTransaction</span>
    <span class="directive">public</span> Uni&lt;RestResponse&lt;<span class="predefined-type">URI</span>&gt;&gt; createHero(<span class="annotation">@Valid</span> Hero hero, <span class="annotation">@Context</span> UriInfo uriInfo) {
        <span class="keyword">return</span> hero.&lt;Hero&gt;persist()
            .map(h -&gt; {
                UriBuilder builder = uriInfo.getAbsolutePathBuilder().path(<span class="predefined-type">Long</span>.toString(h.id));
                logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">New Hero created with URI </span><span class="delimiter">&quot;</span></span> + builder.build().toString());
                <span class="keyword">return</span> RestResponse.created(builder.build());
            });
    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Updates an exiting hero</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@PUT</span>
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The updated hero</span><span class="delimiter">&quot;</span></span>, content = <span class="annotation">@Content</span>(mediaType = APPLICATION_JSON, schema = <span class="annotation">@Schema</span>(implementation = Hero.class)))
    <span class="annotation">@WithTransaction</span>
    <span class="directive">public</span> Uni&lt;Hero&gt; updateHero(<span class="annotation">@Valid</span> Hero hero) {
        <span class="keyword">return</span> Hero.&lt;Hero&gt;findById(hero.id)
            .map(retrieved -&gt; {
                retrieved.name = hero.name;
                retrieved.otherName = hero.otherName;
                retrieved.level = hero.level;
                retrieved.picture = hero.picture;
                retrieved.powers = hero.powers;
                <span class="keyword">return</span> retrieved;
            })
            .map(h -&gt; {
                logger.debugf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hero updated with new valued %s</span><span class="delimiter">&quot;</span></span>, h);
                <span class="keyword">return</span> h;
            });

    }

    <span class="annotation">@Operation</span>(summary = <span class="string"><span class="delimiter">&quot;</span><span class="content">Deletes an exiting hero</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@DELETE</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@APIResponse</span>(responseCode = <span class="string"><span class="delimiter">&quot;</span><span class="content">204</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@WithTransaction</span>
    <span class="directive">public</span> Uni&lt;RestResponse&lt;<span class="predefined-type">Void</span>&gt;&gt; deleteHero(<span class="annotation">@RestPath</span> <span class="predefined-type">Long</span> id) {
        <span class="keyword">return</span> Hero.deleteById(id)
            .invoke(() -&gt; logger.debugf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hero deleted with %d</span><span class="delimiter">&quot;</span></span>, id))
            .replaceWith(RestResponse.noContent());
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN)
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Hero Resource</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The resource implements the same HTTP API as the villain counterpart.
It does not use a transactional service, but uses Panache method directly.</p>
</div>
<div class="paragraph">
<p>As you can see, instead of returning the result directly, it returns <code>Uni&lt;T&gt;</code>.
Quarkus retrieves the <code>Uni</code> and <em>waits</em> for the outcome to be available before writing the response.
During that time, it can handle other requests.</p>
</div>
<div class="paragraph">
<p>Notice also the <code>@WithTransaction</code>, which is the reactive variant of <code>@Transactional</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_reactive_access_to_the_database">Configuring the reactive access to the database</h4>
<div class="paragraph">
<p>Configuring the reactive access to the database is relatively similar to configuring the JDBC url.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Open the <code>application.properties</code> file and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">## HTTP configuration
quarkus.http.port=8083

## Custom banner file path
quarkus.banner.path=banner.txt

# drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation=drop-and-create

%prod.quarkus.datasource.username=superman
%prod.quarkus.datasource.password=superman
%prod.quarkus.datasource.reactive.url=postgresql://localhost:5432/heroes_database
%prod.quarkus.hibernate-orm.sql-load-script=import.sql</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <em>prod</em> profile contains the <code>%prod.quarkus.datasource.reactive.url</code> which configure the access to the database.</p>
</div>
<div class="paragraph">
<p>We also set the port to be 8083.</p>
</div>
</div>
<div class="sect3">
<h4 id="_importing_heroes">Importing heroes</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the <code>src/main/resources/import.sql</code> and copy the content from <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/super-heroes/rest-heroes/src/main/resources/import.sql">import.sql</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">ALTER SEQUENCE hero_seq RESTART WITH 50;

INSERT INTO hero(id, name, otherName, picture, powers, level)
VALUES (nextval('hero_seq'), 'Chewbacca', '', 'https://www.superherodb.com/pictures2/portraits/10/050/10466.jpg',
        'Agility, Longevity, Marksmanship, Natural Weapons, Stealth, Super Strength, Weapons Master', 5);
INSERT INTO hero(id, name, otherName, picture, powers, level)
VALUES (nextval('hero_seq'), 'Angel Salvadore', 'Angel Salvadore Bohusk',
        'https://www.superherodb.com/pictures2/portraits/10/050/1406.jpg',
        'Animal Attributes, Animal Oriented Powers, Flight, Regeneration, Toxin and Disease Control', 4);
INSERT INTO hero(id, name, otherName, picture, powers, level)
VALUES (nextval('hero_seq'), 'Bill Harken', '', 'https://www.superherodb.com/pictures2/portraits/10/050/1527.jpg',
        'Super Speed, Super Strength, Toxin and Disease Resistance', 6);
...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_heroes">Testing the heroes</h4>
<div class="paragraph">
<p>Time for some tests!
Open the <code>io.quarkus.workshop.superheroes.hero.HeroResourceTest</code> class and copy the following content:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.hero</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.junit.QuarkusTest</span>;
<span class="keyword">import</span> <span class="include">io.restassured.common.mapper.TypeRef</span>;
<span class="keyword">import</span> <span class="include">org.hamcrest.core.Is</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.MethodOrderer</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Order</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.TestMethodOrder</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Random</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.get</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.given</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.ACCEPT</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.CONTENT_TYPE</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.TEXT_PLAIN</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.BAD_REQUEST</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.CREATED</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.NO_CONTENT</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.OK</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers.is</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertTrue</span>;

<span class="annotation">@QuarkusTest</span>
<span class="annotation">@TestMethodOrder</span>(MethodOrderer.OrderAnnotation.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">HeroResourceTest</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> JSON = <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json;charset=UTF-8</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette (updated)</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_OTHER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette Tradition</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_OTHER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette Tradition (updated)</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_baguette.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_baguette_updated.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">eats baguette really quickly</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UPDATED_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">eats baguette really quickly (updated)</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> DEFAULT_LEVEL = <span class="integer">42</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> UPDATED_LEVEL = <span class="integer">43</span>;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NB_HEROES = <span class="integer">941</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> heroId;

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldPingOpenAPI() {
        given()
            .header(ACCEPT, APPLICATION_JSON)
            .when()
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/q/openapi</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testHelloEndpoint() {
        given()
            .header(ACCEPT, TEXT_PLAIN)
            .when()
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes/hello</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(<span class="integer">200</span>)
            .body(is(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Hero Resource</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNotGetUnknownHero() {
        <span class="predefined-type">Long</span> randomId = <span class="keyword">new</span> <span class="predefined-type">Random</span>().nextLong();
        given()
            .pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, randomId)
            .when()
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes/{id}</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(NO_CONTENT.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldGetRandomHero() {
        given()
            .when()
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes/random</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON);
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNotAddInvalidItem() {
        Hero hero = <span class="keyword">new</span> Hero();
        hero.name = <span class="predefined-constant">null</span>;
        hero.otherName = DEFAULT_OTHER_NAME;
        hero.picture = DEFAULT_PICTURE;
        hero.powers = DEFAULT_POWERS;
        hero.level = <span class="integer">0</span>;

        given()
            .body(hero)
            .header(CONTENT_TYPE, APPLICATION_JSON)
            .header(ACCEPT, APPLICATION_JSON)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(BAD_REQUEST.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">1</span>)
    <span class="type">void</span> shouldGetInitialItems() {
        <span class="predefined-type">List</span>&lt;Hero&gt; heroes = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>).then()
                                              .statusCode(OK.getStatusCode())
                                              .contentType(APPLICATION_JSON)
                                              .extract()
                                              .body()
                                              .as(getHeroTypeRef());
        assertEquals(NB_HEROES, heroes.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">2</span>)
    <span class="type">void</span> shouldAddAnItem() {
        Hero hero = <span class="keyword">new</span> Hero();
        hero.name = DEFAULT_NAME;
        hero.otherName = DEFAULT_OTHER_NAME;
        hero.picture = DEFAULT_PICTURE;
        hero.powers = DEFAULT_POWERS;
        hero.level = DEFAULT_LEVEL;

        <span class="predefined-type">String</span> location = given()
            .body(hero)
            .header(CONTENT_TYPE, APPLICATION_JSON)
            .header(ACCEPT, APPLICATION_JSON)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(CREATED.getStatusCode())
            .extract()
            .header(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>);
        assertTrue(location.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// Stores the id</span>
        <span class="predefined-type">String</span><span class="type">[]</span> segments = location.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>);
        heroId = segments[segments.length - <span class="integer">1</span>];
        assertNotNull(heroId);

        given()
            .pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, heroId)
            .when()
            .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes/{id}</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">otherName</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_OTHER_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">level</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_LEVEL))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">picture</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_PICTURE))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">powers</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_POWERS));

        <span class="predefined-type">List</span>&lt;Hero&gt; heroes = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>).then()
                                              .statusCode(OK.getStatusCode())
                                              .extract()
                                              .body()
                                              .as(getHeroTypeRef());
        assertEquals(NB_HEROES + <span class="integer">1</span>, heroes.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">3</span>)
    <span class="type">void</span> shouldUpdateAnItem() {
        Hero hero = <span class="keyword">new</span> Hero();
        hero.id = <span class="predefined-type">Long</span>.valueOf(heroId);
        hero.name = UPDATED_NAME;
        hero.otherName = UPDATED_OTHER_NAME;
        hero.picture = UPDATED_PICTURE;
        hero.powers = UPDATED_POWERS;
        hero.level = UPDATED_LEVEL;

        given()
            .body(hero)
            .header(CONTENT_TYPE, APPLICATION_JSON)
            .header(ACCEPT, APPLICATION_JSON)
            .when()
            .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">otherName</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_OTHER_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">level</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_LEVEL))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">picture</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_PICTURE))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">powers</span><span class="delimiter">&quot;</span></span>, Is.is(UPDATED_POWERS));

        <span class="predefined-type">List</span>&lt;Hero&gt; heroes = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>).then()
                                              .statusCode(OK.getStatusCode())
                                              .contentType(APPLICATION_JSON)
                                              .extract()
                                              .body()
                                              .as(getHeroTypeRef());
        assertEquals(NB_HEROES + <span class="integer">1</span>, heroes.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">4</span>)
    <span class="type">void</span> shouldRemoveAnItem() {
        given()
            .pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, heroId)
            .when()
            .delete(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes/{id}</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(NO_CONTENT.getStatusCode());

        <span class="predefined-type">List</span>&lt;Hero&gt; heroes = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>).then()
                                              .statusCode(OK.getStatusCode())
                                              .contentType(APPLICATION_JSON)
                                              .extract()
                                              .body()
                                              .as(getHeroTypeRef());
        assertEquals(NB_HEROES, heroes.size());
    }

    <span class="directive">private</span> TypeRef&lt;<span class="predefined-type">List</span>&lt;Hero&gt;&gt; getHeroTypeRef() {
        <span class="keyword">return</span> <span class="keyword">new</span> TypeRef&lt;<span class="predefined-type">List</span>&lt;Hero&gt;&gt;() {
            <span class="comment">// Kept empty on purpose</span>
        };
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The tests are very similar to the ones from the villain service.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_testing_and_packaging_the_application">Running, Testing and Packaging the Application</h3>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, make sure the tests pass by executing the command <code>./mvnw test</code> (or from your IDE).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that the tests are green, we are ready to run our application.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Use <code>./mvnw quarkus:dev</code> to start it.
Once the application is started, create a new hero with the following cUrl command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl -X POST -d  '{&quot;level&quot;:2, &quot;name&quot;:&quot;Super level&quot;, &quot;powers&quot;:&quot;leaping&quot;}'  -H &quot;Content-Type: application/json&quot; http://localhost:8083/api/heroes -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to the verbose mode (<code>-v</code>) you should see a similar output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">&lt; HTTP/1.1 201 Created
&lt; Location: http://localhost:8083/api/heroes/952</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The cUrl command returns the location of the newly created hero.
Take this URL and do an HTTP GET on it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The example shows a newly created Hero with id <code>952</code>.
But this id could be different on your machine.
Just make sure to use the correct id in the next command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8083/api/heroes/952 | jq</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">952</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Super level</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">otherName</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">level</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">picture</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">powers</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">leaping</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you can also check Swagger UI by going to the dev console: <a href="http://localhost:8083/q/dev" class="bare">http://localhost:8083/q/dev</a>.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Then, build the application using: <code>./mvnw package</code>, and run the application using <code>java -jar target/quarkus-app/quarkus-run.jar</code>.
Open your browser and go to <a href="http://localhost:8083/api/heroes" class="bare">http://localhost:8083/api/heroes</a>.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="microservices">From Microservice to Microservices</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>So far we&#8217;ve built two microservices: the villains and heroes microservices.
In the following sections you will develop an extra microservice: a <em>fight</em> microservice where heroes and villains fight.
We will also add a React front-end, so we can fight graphically.
But as you can notice in the diagram below, these microservices still not communicate with each other.
You will have to wait the next chapter for that ;o)</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-ba4cce28188efc82438e95c34a129907.png" alt="Diagram" width="2206" height="1350">
</div>
</div>
<div class="paragraph">
<p>Each microservice is developed in its own directory.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-a4d8621e9b70a4542b084242842a5e14.png" alt="Diagram" width="121" height="262">
</div>
</div>
<div class="paragraph">
<p>In the following sections, you will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new Quarkus application</p>
</li>
<li>
<p>Implement REST API using JAX-RS</p>
</li>
<li>
<p>Access your database using Hibernate ORM with Panache</p>
</li>
<li>
<p>Use transactions</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This service is exposed on the port 8082.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="microservices-fight">Fight Microservice</h3>
<div class="paragraph">
<p>Ok, let&#8217;s develop another microservice.
We have a REST API that returns a random Hero.
Another REST API that returns a random Villain&#8230;&#8203;
we need a new REST API that invokes those two, gets one random hero and one random villain and makes them fight.
Let&#8217;s call it the Fight API.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This microservice uses the imperative development model but use reactive extensions.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_bootstrapping_the_fight_rest_endpoint">Bootstrapping the Fight REST Endpoint</h4>
<div class="paragraph">
<p>Like for the Hero and Villain API, the easiest way to create this new Quarkus project is to use a Maven archetype.
Under the <code>quarkus-workshop-super-heroes/super-heroes</code> root directory where you have all your code.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Open a terminal and run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw io.quarkus:quarkus-maven-plugin:3.6.0:create \
  -DplatformVersion=3.6.0 \
  -DprojectGroupId=io.quarkus.workshop.super-heroes \
  -DprojectArtifactId=rest-fights \
  -DclassName=&quot;io.quarkus.workshop.superheroes.fight.FightResource&quot; \
  -Dpath=&quot;api/fights&quot; \
  -Dextensions=&quot;jdbc-postgresql,hibernate-orm-panache,hibernate-validator,quarkus-resteasy-reactive-jackson,smallrye-openapi,kafka&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you open the <code>pom.xml</code> file, you will see that the following extensions have been imported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.quarkus:quarkus-hibernate-orm-panache</code></p>
</li>
<li>
<p><code>io.quarkus:quarkus-hibernate-validator</code></p>
</li>
<li>
<p><code>io.quarkus:quarkus-smallrye-openapi</code></p>
</li>
<li>
<p><code>io.quarkus:quarkus-smallrye-reactive-messaging-kafka</code></p>
</li>
<li>
<p><code>io.quarkus:quarkus-resteasy-reactive-jackson</code></p>
</li>
<li>
<p><code>io.quarkus:quarkus-jdbc-postgresql</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>The Quarkus Maven plugin has generated some code that we won&#8217;t be using.
You can delete the Java classes <code>MyReactiveMessagingApplication</code> and <code>MyReactiveMessagingApplicationTest</code>.</p>
</div>
<div class="paragraph">
<p>If you want your IDE to manage this new Maven project, you can declare it in the parent POM by adding this new module in the <code>&lt;modules&gt;</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;module&gt;</span>super-heroes/rest-fights<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_directory_structure_6">Directory Structure</h4>
<div class="paragraph">
<p>At the end you should have the following directory structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-d24aa1313b8c9a01356a21fa17a4a21c.png" alt="Diagram" width="258" height="513">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fight_entity">Fight Entity</h4>
<div class="paragraph">
<p>A fight is between a hero and a villain.
Each time there is a fight, there is a winner and a loser.
So the <code>Fight</code> entity is there to store all these fights.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the <code>io.quarkus.workshop.superheroes.fight.Fight</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.hibernate.orm.panache.PanacheEntity</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;

<span class="keyword">import</span> <span class="include">jakarta.persistence.Column</span>;
<span class="keyword">import</span> <span class="include">jakarta.persistence.Entity</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;

<span class="keyword">import</span> <span class="include">java.time.Instant</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Schema</span>(description = <span class="string"><span class="delimiter">&quot;</span><span class="content">Each fight has a winner and a loser</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Fight</span> <span class="directive">extends</span> PanacheEntity {

    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> Instant fightDate;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> winnerName;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="type">int</span> winnerLevel;
    <span class="annotation">@NotNull</span>
    <span class="annotation">@Column</span>(columnDefinition = <span class="string"><span class="delimiter">&quot;</span><span class="content">TEXT</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> winnerPowers;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> winnerPicture;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> loserName;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="type">int</span> loserLevel;
    <span class="annotation">@NotNull</span>
    <span class="annotation">@Column</span>(columnDefinition = <span class="string"><span class="delimiter">&quot;</span><span class="content">TEXT</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> loserPowers;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> loserPicture;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> winnerTeam;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> loserTeam;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fighters_bean">Fighters Bean</h4>
<div class="paragraph">
<p>Now comes a trick.
The Fight REST API will ultimately invoke the Hero and Villain APIs (next sections) to get two random fighters.
The <code>Fighters</code> class has one <code>Hero</code> and one <code>Villain</code>.
Notice that <code>Fighters</code> is not an entity, it is not persisted in the database, just marshalled and unmarshalled to JSon.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the <code>io.quarkus.workshop.superheroes.fight.Fighters</code> class, with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.client.Hero</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.client.Villain</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;

<span class="annotation">@Schema</span>(description = <span class="string"><span class="delimiter">&quot;</span><span class="content">A fight between one hero and one villain</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Fighters</span> {

    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> Hero hero;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> Villain villain;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It does not compile because it needs a <code>Hero</code>  class and a <code>Villain</code> class.
The Fight REST API is just interested in the hero&#8217;s name, level, picture and powers (not the other name as described in the Hero API).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>So create the <code>Hero</code> bean looks like this (notice the <code>client</code> subpackage):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;

<span class="annotation">@Schema</span>(description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The hero fighting against the villain</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Hero</span> {

    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> name;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="type">int</span> level;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> picture;
    <span class="directive">public</span> <span class="predefined-type">String</span> powers;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also create the <code>Villain</code> counterpart (also in the <code>client</code> subpackage):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;

<span class="annotation">@Schema</span>(description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The villain fighting against the hero</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Villain</span> {

    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> name;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="type">int</span> level;
    <span class="annotation">@NotNull</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> picture;
    <span class="directive">public</span> <span class="predefined-type">String</span> powers;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So, these classes are just used to map the results from the <code>Hero</code> and <code>Villain</code> microservices.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fightservice_transactional_service">FightService Transactional Service</h4>
<div class="paragraph">
<p>Now, let&#8217;s create a <code>FightService</code> class that orchestrate the fights.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the <code>io.quarkus.workshop.superheroes.fight.FightService</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight</span>;

<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;

<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">jakarta.transaction.Transactional</span>;

<span class="keyword">import</span> <span class="include">java.time.Instant</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Random</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.transaction.Transactional.TxType.REQUIRED</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.transaction.Transactional.TxType.SUPPORTS</span>;

<span class="annotation">@ApplicationScoped</span>
<span class="annotation">@Transactional</span>(SUPPORTS)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FightService</span> {

    <span class="annotation">@Inject</span> <span class="predefined-type">Logger</span> logger;

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Random</span> random = <span class="keyword">new</span> <span class="predefined-type">Random</span>();

    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Fight&gt; findAllFights() {
        <span class="keyword">return</span> Fight.listAll();
    }

    <span class="directive">public</span> Fight findFightById(<span class="predefined-type">Long</span> id) {
        <span class="keyword">return</span> Fight.findById(id);
    }

    <span class="directive">public</span> Fighters findRandomFighters() {
        <span class="comment">// Will be implemented later</span>
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Transactional</span>(REQUIRED)
    <span class="directive">public</span> Fight persistFight(Fighters fighters) {
        <span class="comment">// Amazingly fancy logic to determine the winner...</span>
        Fight fight;

        <span class="type">int</span> heroAdjust = random.nextInt(<span class="integer">20</span>);
        <span class="type">int</span> villainAdjust = random.nextInt(<span class="integer">20</span>);

        <span class="keyword">if</span> ((fighters.hero.level + heroAdjust)
            &gt; (fighters.villain.level + villainAdjust)) {
            fight = heroWon(fighters);
        } <span class="keyword">else</span> <span class="keyword">if</span> (fighters.hero.level &lt; fighters.villain.level) {
            fight = villainWon(fighters);
        } <span class="keyword">else</span> {
            fight = random.nextBoolean() ? heroWon(fighters) : villainWon(fighters);
        }

        fight.fightDate = Instant.now();
        fight.persist();

        <span class="keyword">return</span> fight;
    }

    <span class="directive">private</span> Fight heroWon(Fighters fighters) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Yes, Hero won :o)</span><span class="delimiter">&quot;</span></span>);
        Fight fight = <span class="keyword">new</span> Fight();
        fight.winnerName = fighters.hero.name;
        fight.winnerPicture = fighters.hero.picture;
        fight.winnerLevel = fighters.hero.level;
        fight.winnerPowers = fighters.hero.powers;
        fight.loserName = fighters.villain.name;
        fight.loserPicture = fighters.villain.picture;
        fight.loserLevel = fighters.villain.level;
        fight.loserPowers = fighters.villain.powers;
        fight.winnerTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">heroes</span><span class="delimiter">&quot;</span></span>;
        fight.loserTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">villains</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">return</span> fight;
    }

    <span class="directive">private</span> Fight villainWon(Fighters fighters) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Gee, Villain won :o(</span><span class="delimiter">&quot;</span></span>);
        Fight fight = <span class="keyword">new</span> Fight();
        fight.winnerName = fighters.villain.name;
        fight.winnerPicture = fighters.villain.picture;
        fight.winnerLevel = fighters.villain.level;
        fight.winnerPowers = fighters.villain.powers;
        fight.loserName = fighters.hero.name;
        fight.loserPicture = fighters.hero.picture;
        fight.loserLevel = fighters.hero.level;
        fight.loserPowers = fighters.hero.powers;
        fight.winnerTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">villains</span><span class="delimiter">&quot;</span></span>;
        fight.loserTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">heroes</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">return</span> fight;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>persistFight</code> method.
This method is the one creating a fight between a hero and a villain.
As you can see the algorithm to determine the winner is a bit random (even though it uses the levels).
If you are not happy about the way the fight operates, choose your own winning algorithm ;o)</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For now, the <code>Fighters findRandomFighters()</code> method returns null.
Later, this method will invoke the Hello and Villain API to get a random Hero and random Villain.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fightresource_endpoint">FightResource Endpoint</h4>
<div class="paragraph">
<p>To expose a REST API we also need a <code>FightResource</code> (with OpenAPI annotations of course).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight</span>;

<span class="keyword">import</span> <span class="include">jakarta.ws.rs</span>.*;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.config.inject.ConfigProperty</span>;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;

<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Response</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.UriInfo</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.TEXT_PLAIN</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(APPLICATION_JSON)
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">FightResource</span> {

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Logger</span> logger;

    <span class="annotation">@Inject</span>
    FightService service;


    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/randomfighters</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Response getRandomFighters() {
        Fighters fighters = service.findRandomFighters();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Get random fighters </span><span class="delimiter">&quot;</span></span> + fighters);
        <span class="keyword">return</span> Response.ok(fighters).build();
    }

    <span class="annotation">@GET</span>
    <span class="directive">public</span> Response getAllFights() {
        <span class="predefined-type">List</span>&lt;Fight&gt; fights = service.findAllFights();
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Total number of fights </span><span class="delimiter">&quot;</span></span> + fights);
        <span class="keyword">return</span> Response.ok(fights).build();
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Response getFight(<span class="predefined-type">Long</span> id) {
        Fight fight = service.findFightById(id);
        <span class="keyword">if</span> (fight != <span class="predefined-constant">null</span>) {
            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Found fight </span><span class="delimiter">&quot;</span></span> + fight);
            <span class="keyword">return</span> Response.ok(fight).build();
        } <span class="keyword">else</span> {
            logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">No fight found with id </span><span class="delimiter">&quot;</span></span> + id);
            <span class="keyword">return</span> Response.noContent().build();
        }
    }

    <span class="annotation">@POST</span>
    <span class="directive">public</span> Fight fight(<span class="annotation">@Valid</span> Fighters fighters, UriInfo uriInfo) {
        <span class="keyword">return</span> service.persistFight(fighters);
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN)
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Fight Resource</span><span class="delimiter">&quot;</span></span>;
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The OpenAPI annotations have been omitted to keep the service focused on the task.
Feel free to add them if you want complete OpenAPI descriptors.</p>
</div>
<div class="paragraph">
<p>Notice that most of the REST endpoints that you&#8217;ve seen so far produce or consume JSON.
JSON being the default media type in Quarkus, we could have omitted the <code>@Produces</code> or <code>@Consume</code> annotation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_data_2">Adding Data</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To load some SQL statements when Hibernate ORM starts, create the <code>src/main/resources/import.sql</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">ALTER</span> SEQUENCE fight_seq RESTART WITH <span class="integer">50</span>;

<span class="class">INSERT</span> <span class="class">INTO</span> fight(id, fightDate, winnerName, winnerLevel, winnerPicture, winnerPowers, loserName, loserLevel, loserPicture, loserPowers, winnerTeam, loserTeam)
<span class="keyword">VALUES</span> (nextval(<span class="string"><span class="delimiter">'</span><span class="content">fight_seq</span><span class="delimiter">'</span></span>), current_timestamp,
        <span class="string"><span class="delimiter">'</span><span class="content">Chewbacca</span><span class="delimiter">'</span></span>, <span class="integer">5</span>, <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/10466.jpg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Agility, Longevity, Marksmanship, Natural Weapons, Stealth, Super Strength, Weapons Master</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Buuccolo</span><span class="delimiter">'</span></span>, <span class="integer">3</span>, <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/15355.jpg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Accelerated Healing, Adaptation, Agility, Flight, Immortality, Intelligence, Invulnerability, Reflexes, Self-Sustenance, Size Changing, Spatial Awareness, Stamina, Stealth, Super Breath, Super Speed, Super Strength, Teleportation</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">heroes</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">villains</span><span class="delimiter">'</span></span>);
<span class="class">INSERT</span> <span class="class">INTO</span> fight(id, fightDate, winnerName, winnerLevel, winnerPicture, winnerPowers, loserName, loserLevel, loserPicture, loserPowers, winnerTeam, loserTeam)
<span class="keyword">VALUES</span> (nextval(<span class="string"><span class="delimiter">'</span><span class="content">fight_seq</span><span class="delimiter">'</span></span>), current_timestamp,
        <span class="string"><span class="delimiter">'</span><span class="content">Galadriel</span><span class="delimiter">'</span></span>, <span class="integer">10</span>, <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/11796.jpg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Danger Sense, Immortality, Intelligence, Invisibility, Magic, Precognition, Telekinesis, Telepathy</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Darth Vader</span><span class="delimiter">'</span></span>, <span class="integer">8</span>, <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/10444.jpg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Accelerated Healing, Agility, Astral Projection, Cloaking, Danger Sense, Durability, Electrokinesis, Energy Blasts, Enhanced Hearing, Enhanced Senses, Force Fields, Hypnokinesis, Illusions, Intelligence, Jump, Light Control, Marksmanship, Precognition, Psionic Powers, Reflexes, Stealth, Super Speed, Telekinesis, Telepathy, The Force, Weapons Master</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">heroes</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">villains</span><span class="delimiter">'</span></span>);
<span class="class">INSERT</span> <span class="class">INTO</span> fight(id, fightDate, winnerName, winnerLevel, winnerPicture, winnerPowers, loserName, loserLevel, loserPicture, loserPowers, winnerTeam, loserTeam)
<span class="keyword">VALUES</span> (nextval(<span class="string"><span class="delimiter">'</span><span class="content">fight_seq</span><span class="delimiter">'</span></span>), current_timestamp,
        <span class="string"><span class="delimiter">'</span><span class="content">Annihilus</span><span class="delimiter">'</span></span>, <span class="integer">23</span>, <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/1307.jpg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Agility, Durability, Flight, Reflexes, Stamina, Super Speed, Super Strength</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">Shikamaru</span><span class="delimiter">'</span></span>, <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">https://www.superherodb.com/pictures2/portraits/10/050/11742.jpg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Adaptation, Agility, Element Control, Fire Control, Intelligence, Jump, Marksmanship, Possession, Reflexes, Shapeshifting, Stamina, Stealth, Telekinesis, Wallcrawling, Weapon-based Powers, Weapons Master</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">villains</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">heroes</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">Configuration</h4>
<div class="paragraph">
<p>As usual, we need to configure the application.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In the <code>application.properties</code> file add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">## HTTP configuration
quarkus.http.port=8082

## Custom banner file path
quarkus.banner.path=banner.txt

## drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation=drop-and-create

## Logging configuration
quarkus.log.console.enable=true
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
quarkus.log.console.level=DEBUG

## Production configuration
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/fights_database
%prod.quarkus.datasource.db-kind=postgresql
%prod.quarkus.datasource.username=superfight
%prod.quarkus.datasource.password=superfight
%prod.quarkus.hibernate-orm.sql-load-script=import.sql
%prod.quarkus.log.console.level=INFO
%prod.quarkus.hibernate-orm.database.generation=update



## Kafka configuration</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the fight service uses the port <code>8082</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fightresourcetest_test_class">FightResourceTest Test Class</h4>
<div class="paragraph">
<p>We need to test our REST API.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that, copy the following <code>FightResourceTest</code> class under the <code>src/test/java/io/quarkus/workshop/superheroes/fight</code> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.junit.QuarkusTest</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.client.Hero</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.client.Villain</span>;
<span class="keyword">import</span> <span class="include">io.restassured.common.mapper.TypeRef</span>;
<span class="keyword">import</span> <span class="include">org.hamcrest.core.Is</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.MethodOrderer</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Order</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.TestMethodOrder</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">java.util.Random</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.get</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.given</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.ACCEPT</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.CONTENT_TYPE</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status</span>.*;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers</span>.*;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;

<span class="annotation">@QuarkusTest</span>
<span class="annotation">@TestMethodOrder</span>(MethodOrderer.OrderAnnotation.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FightResourceTest</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_WINNER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_WINNER_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_baguette.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> DEFAULT_WINNER_LEVEL = <span class="integer">42</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_WINNER_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">Eats baguette in less than a second</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_LOSER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_LOSER_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_chocolatine.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> DEFAULT_LOSER_LEVEL = <span class="integer">6</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_LOSER_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">Transforms chocolatine into pain au chocolat</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> NB_FIGHTS = <span class="integer">3</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> fightId;

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldPingOpenAPI() {
        given()
            .header(ACCEPT, APPLICATION_JSON)
            .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/q/openapi</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testHelloEndpoint() {
        given()
            .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights/hello</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(<span class="integer">200</span>)
            .body(is(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Fight Resource</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNotGetUnknownFight() {
        <span class="predefined-type">Long</span> randomId = <span class="keyword">new</span> <span class="predefined-type">Random</span>().nextLong();
        given()
            .pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, randomId)
            .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights/{id}</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(NO_CONTENT.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNotAddInvalidItem() {
        Fighters fighters = <span class="keyword">new</span> Fighters();
        fighters.hero = <span class="predefined-constant">null</span>;
        fighters.villain = <span class="predefined-constant">null</span>;

        given()
            .body(fighters)
            .header(CONTENT_TYPE, APPLICATION_JSON)
            .header(ACCEPT, APPLICATION_JSON)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(BAD_REQUEST.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">1</span>)
    <span class="type">void</span> shouldGetInitialItems() {
        <span class="predefined-type">List</span>&lt;Fight&gt; fights = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights</span><span class="delimiter">&quot;</span></span>).then()
            .statusCode(OK.getStatusCode())
            .extract().body().as(getFightTypeRef());
        assertEquals(NB_FIGHTS, fights.size());
    }

    <span class="annotation">@Test</span>
    <span class="annotation">@Order</span>(<span class="integer">2</span>)
    <span class="type">void</span> shouldAddAnItem() {
        Hero hero = <span class="keyword">new</span> Hero();
        hero.name = DEFAULT_WINNER_NAME;
        hero.picture = DEFAULT_WINNER_PICTURE;
        hero.level = DEFAULT_WINNER_LEVEL;
        hero.powers = DEFAULT_WINNER_POWERS;
        Villain villain = <span class="keyword">new</span> Villain();
        villain.name = DEFAULT_LOSER_NAME;
        villain.picture = DEFAULT_LOSER_PICTURE;
        villain.level = DEFAULT_LOSER_LEVEL;
        villain.powers = DEFAULT_LOSER_POWERS;
        Fighters fighters = <span class="keyword">new</span> Fighters();
        fighters.hero = hero;
        fighters.villain = villain;

        fightId = given()
            .body(fighters)
            .header(CONTENT_TYPE, APPLICATION_JSON)
            .header(ACCEPT, APPLICATION_JSON)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .body(containsString(<span class="string"><span class="delimiter">&quot;</span><span class="content">winner</span><span class="delimiter">&quot;</span></span>), containsString(<span class="string"><span class="delimiter">&quot;</span><span class="content">loser</span><span class="delimiter">&quot;</span></span>))
            .extract().body().jsonPath().getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);

        assertNotNull(fightId);

        given()
            .pathParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, fightId)
            .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights/{id}</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode())
            .contentType(APPLICATION_JSON)
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">winnerName</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_WINNER_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">winnerPicture</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_WINNER_PICTURE))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">winnerLevel</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_WINNER_LEVEL))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">winnerPowers</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_WINNER_POWERS))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">loserName</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_LOSER_NAME))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">loserPicture</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_LOSER_PICTURE))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">loserLevel</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_LOSER_LEVEL))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">loserPowers</span><span class="delimiter">&quot;</span></span>, Is.is(DEFAULT_LOSER_POWERS))
            .body(<span class="string"><span class="delimiter">&quot;</span><span class="content">fightDate</span><span class="delimiter">&quot;</span></span>, Is.is(notNullValue()));

        <span class="predefined-type">List</span>&lt;Fight&gt; fights = get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights</span><span class="delimiter">&quot;</span></span>).then()
            .statusCode(OK.getStatusCode())
            .extract().body().as(getFightTypeRef());
        assertEquals(NB_FIGHTS + <span class="integer">1</span>, fights.size());
    }

    <span class="directive">private</span> TypeRef&lt;<span class="predefined-type">List</span>&lt;Fight&gt;&gt; getFightTypeRef() {
        <span class="keyword">return</span> <span class="keyword">new</span> TypeRef&lt;<span class="predefined-type">List</span>&lt;Fight&gt;&gt;() {
            <span class="comment">// Kept empty on purpose</span>
        };
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_testing_and_packaging_the_application_2">Running, Testing and Packaging the Application</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, delete the generated <code>FightResourceIT</code> native test class, as we won&#8217;t run native tests.
Then, make sure the tests pass by executing the command <code>./mvnw test</code> (or from your IDE).
Quarkus automatically starts the PostGreSQL database.</p>
</div>
<div class="paragraph">
<p>Now that the tests are green, we are ready to run our application.
Use <code>./mvnw quarkus:dev</code> to start it (notice that there is no banner yet, it will come later).
Once the application is started, just check that it returns the fights from the database with the following cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl http://localhost:8082/api/fights</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you can also check Swagger UI by going to <a href="http://localhost:8082/q/swagger-ui" class="bare">http://localhost:8082/q/swagger-ui</a>.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ui">User Interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have the three main microservices, time to have a decent user interface to start fighting.
The purpose of this workshop is not to develop a web interface and learn <em>yet another web framework</em>.
This time you will just execute another Quarkus instance with an already React application.
We will be using <a href="https://quarkiverse.github.io/quarkiverse-docs/quarkus-quinoa/dev/">Quinoa</a>
to handle building and serving the React application.</p>
</div>
<div class="sect2">
<h3 id="_quinoa">Quinoa?</h3>
<div class="paragraph">
<p><a href="https://quarkus.io/extensions/io.quarkiverse.quinoa/quarkus-quinoa">Quinoa</a> is a Quarkus extension which eases the development of single page apps or web components.
It lets you live code the backend and frontend together with close to no configuration.
It also helps with both packaging and serving, and if you want it to, abstracts away <code>npm</code>.</p>
</div>
<div class="paragraph">
<p>When enabled in development mode, Quinoa will start the UI live coding server provided by the target framework and forward relevant requests to it.
In production mode, Quinoa will run the build and process the generated files to serve them at runtime.</p>
</div>
<div class="paragraph">
<p>Quinoa is framework-agnostic, and works with React, Angular, Vue, Lit, and others, alongside other Quarkus services (REST, GraphQL, Security, Events, etc).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_web_application">The Web Application</h3>
<div class="paragraph">
<p>Navigate to the <code>super-heroes/ui-super-heroes</code> directory.
It contains the code of the application.</p>
</div>
<div class="paragraph">
<p>The React application is in <code>src/main/webui</code>.
Being a React application, you will find a <code>package.json</code> file which defines all the needed dependencies.
All the React code (graphical components, model, services) is located under <code>src/main/webui/src/app</code>.</p>
</div>
<div class="sect3">
<h4 id="_running_the_web_application">Running the Web Application</h4>
<div class="paragraph">
<p>We don&#8217;t need to worry too much about the React code.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>From the <code>ui-super-heroes</code>
directory, use <code>./mvnw quarkus:dev</code> to start the web application.</p>
</div>
<div class="paragraph">
<p>Be sure you have the hero, villain and fights microservices running (dev mode is enough).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t have Node installed, Quinoa will install it during the start process (under the <code>.quinoa</code> directory).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">INFO  [com.git.eir.mav.plu.fro.lib.NodeInstaller] (build-<span class="integer">40</span>) Installing node version v16<span class="float">.16</span><span class="float">.0</span>
INFO  [com.git.eir.mav.plu.fro.lib.NodeInstaller] (build-<span class="integer">40</span>) Extracting NPM
INFO  [com.git.eir.mav.plu.fro.lib.NodeInstaller] (build-<span class="integer">40</span>) Installed node locally.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see console output like the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">2023-05-18 14:22:02,745 INFO  [io.qua.qui.dep.ForwardedDevProcessor] (build-5) Quinoa package manager live coding is up and running on port: 3000 (in 18118ms)
2023-05-18 14:22:02,749 INFO  [io.qua.qui.dep.ForwardedDevProcessor] (build-40) Quinoa is forwarding unhandled requests to port: 3000
__  ____  __  _____   ___  __ ____  ______
 --/ __ \/ / / / _ | / _ \/ //_/ / / / __/
 -/ /_/ / /_/ / __ |/ , _/ ,&lt; / /_/ /\ \
--\___\_\____/_/ |_/_/|_/_/|_|\____/___/
2023-05-18 14:22:03,237 INFO  [io.quarkus] (Quarkus Main Thread) ui-super-heroes 1.0.0-SNAPSHOT on JVM (powered by Quarkus 3.6.0) started in 24.765s. Listening on: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the application is started, go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> (8080 is the default Quarkus port as we didn&#8217;t change it in the <code>application.properties</code> this time).
It should display a main web page. There won&#8217;t be much content yet,
because we need to fix a few things and add some more implementation.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/blank-ui.png" alt="blank ui">
</div>
</div>
<div class="paragraph">
<p>If you want, you can visit <a href="http://localhost:3000" class="bare">http://localhost:3000</a> (the usual React port) to confirm that Quinoa is forwarding what&#8217;s on port 3000 to port 8080.
The version of the application on <a href="http://localhost:3000" class="bare">http://localhost:3000</a> will always stay disappointingly blank,
because it&#8217;s looking for its config on the wrong port. So don&#8217;t use that one!</p>
</div>
<div class="paragraph">
<p>You might want to create a fuller Quarkus BFF for the UI, and use something like <a href="https://quarkus.io/guides/stork">Stork</a> for service discovery.
However, that&#8217;s beyond the scope of this workshop!</p>
</div>
</div>
<div class="sect3">
<h4 id="_live_coding_the_ui">Live coding the UI</h4>
<div class="paragraph">
<p>Live coding works for the javascript parts of the application, just as it does for the Java ones.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Open <code>src/main/webui/src/app/app.component.html</code> and edit the text, perhaps by adding 'Hello there' into the welcome message.
Check localhost:8080, and your new content should appear.
(It may take a moment or two for the refresh to trigger.)</p>
</div>
<div class="paragraph">
<p>You can also change the javascript code.
For example, try updating the text in <code>src/main/webui/src/app/app.component.ts</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="microservices-cors">CORS</h3>
<div class="paragraph">
<p>Cross-origin resource sharing (CORS) is a mechanism that allows restricted resources on a web page to be requested from another domain outside the domain from which the first resource was served.<sup class="footnote">[<a id="_footnoteref_17" class="footnote" href="#_footnotedef_17" title="View footnote.">17</a>]</sup>
So when we want our heroes and villains to fight, we actually cross several origins:
we go from localhost:8080 (the UI) to localhost:8082 (Fight API) which invokes localhost:8083 (Hero) and localhost:8084 (Villain).
If you look at the console of your Browser you should see something similar to this:</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/cors.png" alt="cors">
</div>
</div>
<div class="paragraph">
<p>Quarkus comes with a CORS filter which intercepts all incoming HTTP requests.
It can be enabled in the Quarkus configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.http.cors=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the filter is enabled and an HTTP request is identified as cross-origin, the CORS policy and headers defined using the following properties will be applied before passing the request on to its actual target (servlet, JAX-RS resource, etc.):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quarkus.http.cors.origins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated list of origins allowed for CORS. The filter allows any origin if this is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quarkus.http.cors.methods</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated list of HTTP methods allowed for CORS. The filter allows any method if this is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quarkus.http.cors.headers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated list of HTTP headers allowed for CORS. The filter allows any header if this is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quarkus.http.cors.exposed-headers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comma-separated list of HTTP headers exposed in CORS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quarkus.http.cors.access-control-max-age</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration indicating how long the results of a pre-flight request can be cached. This value will be returned in a Access-Control-Max-Age response header.</p></td>
</tr>
</tbody>
</table>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>So make sure you set the following properties on the:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fight microservice,</p>
</li>
<li>
<p>Hero microservice,</p>
</li>
<li>
<p>Villain microservice</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.http.cors=true
quarkus.http.cors.origins=/.*/</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But, even with this, the UI is still not working.
The CORS errors are gone, so that&#8217;s a good step, but we forgot something else:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-f44d76d59eea57d7c7c2debf5e432cb3.png" alt="Diagram" width="2151" height="749">
</div>
</div>
<div class="paragraph">
<p>Remember the function to retrieve random fighters.
We are currently returning <code>null</code>.
Let&#8217;s move to the next session to see how we can implement this method.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rest-client">HTTP communication &amp; Fault Tolerance</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>So far we&#8217;ve built one Fight microservice which need to invoke the Hero and Villain microservices.
In the following sections you will develop this invocation thanks to the MicroProfile REST Client.
We will also deal with fault tolerance thanks to timeouts and circuit breaker.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-f383c38e127f13fbdd6cc3ba98a08354.png" alt="Diagram" width="2206" height="1350">
</div>
</div>
<div class="sect2">
<h3 id="rest-clients">REST Client</h3>
<div class="paragraph">
<p>This chapter explains how to use the MicroProfile REST Client in order to interact with REST APIs with very little effort.<sup class="footnote">[<a id="_footnoteref_18" class="footnote" href="#_footnotedef_18" title="View footnote.">18</a>]</sup></p>
</div>
<div class="sect3">
<h4 id="_directory_structure_7">Directory Structure</h4>
<div class="paragraph">
<p>Remember the structure of the Fight microservice:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-2cac30cbb3df97fa722b8e506f58d4ed.png" alt="Diagram" width="259" height="555">
</div>
</div>
<div class="paragraph">
<p>We are going to rework the:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FightService</code> class</p>
</li>
<li>
<p><code>FightResourceTest</code> class</p>
</li>
<li>
<p><code>application.properties</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_installing_the_reactive_rest_client_dependency">Installing the Reactive REST Client Dependency</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To install the Reactive REST Client dependency, just run the following command in the Fight microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:add-extension -Dextensions=&quot;io.quarkus:quarkus-rest-client-reactive-jackson&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will add the following dependency in the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>quarkus-rest-client-reactive-jackson<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This dependency imports both the reactive rest client implementation and the JSON mapping support (which uses Jackson).</p>
</div>
</div>
<div class="sect3">
<h4 id="_fightservice_invoking_external_microservices">FightService Invoking External Microservices</h4>
<div class="paragraph">
<p>Remember that in the previous sections we left the <code>FightService.findRandomFighters()</code> method returns <code>null</code>.
We have to fix this.
What we actually want is to invoke both the Hero and Villain APIs, asking for a random hero and a random villain.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that, replace the <code>findRandomFighters</code> method with the following code to the <code>FightService</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestClient</span> HeroProxy heroProxy;
<span class="annotation">@RestClient</span> VillainProxy villainProxy;

<span class="comment">// ...</span>

Fighters findRandomFighters() {
    Hero hero = findRandomHero();
    Villain villain = findRandomVillain();
    Fighters fighters = <span class="keyword">new</span> Fighters();
    fighters.hero = hero;
    fighters.villain = villain;
    <span class="keyword">return</span> fighters;
}

Villain findRandomVillain() {
    <span class="keyword">return</span> villainProxy.findRandomVillain();
}

Hero findRandomHero() {
   <span class="keyword">return</span> heroProxy.findRandomHero();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the Rest client injection.
They use the <code>@RestClient</code> qualifier, i.e. a bean selector.
With Quarkus, when you use a qualifier, you can omit <code>@Inject</code>.</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If not done automatically by your IDE, add the following import statement: <code>import org.eclipse.microprofile.rest.client.inject.RestClient;</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_interfaces">Creating the Interfaces</h4>
<div class="paragraph">
<p>Using the MicroProfile REST Client is as simple as creating an interface using the proper JAX-RS and MicroProfile annotations.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In our case both interfaces should be created under the <code>client</code> subpackage and have the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</span>;

<span class="keyword">import</span> <span class="include">jakarta.ws.rs.GET</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/heroes</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
<span class="annotation">@RegisterRestClient</span>(configKey = <span class="string"><span class="delimiter">&quot;</span><span class="content">hero</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">HeroProxy</span> {

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/random</span><span class="delimiter">&quot;</span></span>)
    Hero findRandomHero();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>findRandomHero</code> method gives our code the ability to query a random hero from the Hero REST API.
The client will handle all the networking and marshalling leaving our code clean of such technical details.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The purpose of the annotations in the code above is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@RegisterRestClient</code> allows Quarkus to know that this interface is meant to be available for CDI injection as a REST Client</p>
</li>
<li>
<p><code>@Path</code> and <code>@GET</code> are the standard JAX-RS annotations used to define how to access the service</p>
</li>
<li>
<p><code>@Produces</code> defines the expected content-type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>VillainProxy</code> is very similar and looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</span>;

<span class="keyword">import</span> <span class="include">jakarta.ws.rs.GET</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/villains</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
<span class="annotation">@RegisterRestClient</span>(configKey = <span class="string"><span class="delimiter">&quot;</span><span class="content">villain</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">VillainProxy</span> {

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/random</span><span class="delimiter">&quot;</span></span>)
    Villain findRandomVillain();
}</code></pre>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Once created, go back to the <code>FightService</code> class and add the following import statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.client.HeroProxy</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.client.VillainProxy</span>;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_rest_client_invocation">Configuring REST Client Invocation</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In order to determine the base URL to which REST calls will be made, the REST Client uses configuration from <code>application.properties</code>.
The name of the property needs to follow a certain convention which is best displayed in the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.rest-client.hero.url=http://localhost:8083
quarkus.rest-client.villain.url=http://localhost:8084</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Having this configuration means that all requests performed using <code>HeroProxy</code> will use <a href="http://localhost:8083" class="bare">http://localhost:8083</a> as the base URL.
Using this configuration, calling the <code>findRandomHero</code> method of <code>HeroProxy</code> would result in an HTTP GET request being made to <a href="http://localhost:8083/api/heroes/random" class="bare">http://localhost:8083/api/heroes/random</a>.</p>
</div>
<div class="paragraph">
<p>Now, go back in the UI and refresh, you should see some pictures!</p>
</div>
</div>
<div class="sect3">
<h4 id="_updating_the_test_with_mock_support">Updating the Test with Mock Support</h4>
<div class="paragraph">
<p>But, now we have another problem.
To run the tests of the Fight API we need the Hero and Villain REST APIs to be up and running.
To avoid this, we need to Mock the <code>HeroProxy</code> and <code>VillainProxy</code> interfaces.</p>
</div>
<div class="paragraph">
<p>Quarkus supports the use of mock objects using the CDI <code>@Alternative</code> mechanism.<sup class="footnote">[<a id="_footnoteref_19" class="footnote" href="#_footnotedef_19" title="View footnote.">19</a>]</sup></p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To use this simply override the bean you wish to mock with a class in the <code>src/test/java</code> directory, and put the <code>@Alternative</code> and <code>@Priority(1)</code> annotations on the bean.
Alternatively, a convenient <code>io.quarkus.test.Mock</code> stereotype annotation could be used.
This built-in stereotype declares <code>@Alternative</code>, <code>@Priority(1)</code> and <code>@Dependent</code>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_mocking_a_villain_service">Mocking a Villain service</h5>
<div class="paragraph">
<p>So, to mock the <code>VillainProxy</code> interface we just need to implement the following <code>MockVillainProxy</code> class (under the <code>client</code> subpackage under <code>src/test/java/io/quarkus/workshop/superheroes/fight</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.Mock</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.rest.client.inject.RestClient</span>;

<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;

<span class="annotation">@Mock</span>
<span class="annotation">@ApplicationScoped</span>
<span class="annotation">@RestClient</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MockVillainProxy</span> <span class="directive">implements</span> VillainProxy {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Villain findRandomVillain() {
        <span class="keyword">return</span> DefaultTestVillain.INSTANCE;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are using some common classes for the test data.
They don&#8217;t exist yet, so the IDE will complain!
Let your IDE&#8217;s quick fix create the classes for you, or create them manually (under the <code>client</code> subpackage under <code>src/test/java/io/quarkus/workshop/superheroes/fight</code>), and then fill in the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultTestVillain</span> <span class="directive">extends</span> Villain {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_VILLAIN_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_VILLAIN_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_chocolatine.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_VILLAIN_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">does not eat pain au chocolat</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> DEFAULT_VILLAIN_LEVEL = <span class="integer">42</span>;

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> DefaultTestVillain INSTANCE = <span class="keyword">new</span> DefaultTestVillain();

    <span class="directive">private</span> DefaultTestVillain() {
        <span class="local-variable">this</span>.name = DEFAULT_VILLAIN_NAME;
        <span class="local-variable">this</span>.picture = DEFAULT_VILLAIN_PICTURE;
        <span class="local-variable">this</span>.powers = DEFAULT_VILLAIN_POWERS;
        <span class="local-variable">this</span>.level = DEFAULT_VILLAIN_LEVEL;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_mocking_a_hero_service">Mocking a Hero service</h5>
<div class="paragraph">
<p>We could create a <code>@Mock</code> for the <code>HeroProxy</code>, as we did for the Villain, but there are some drawbacks to using <code>@Mock</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any class defined by <code>@Mock</code> is global in scope, and can&#8217;t be isolated to individual tests.
That can result in unwanted cross-talk between tests.</p>
</li>
<li>
<p>Because of how the mock is defined, it&#8217;s also harder to use <a href="https://site.mockito.org/">Mockito</a> to generate the mock instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s try a different approach.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll still want a class which holds test data for the hero. Create the following under the <code>client</code> subpackage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultTestHero</span> <span class="directive">extends</span> Hero {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_HERO_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_HERO_PICTURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">super_baguette.png</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> DEFAULT_HERO_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">eats baguette really quickly</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> DEFAULT_HERO_LEVEL = <span class="integer">42</span>;

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> DefaultTestHero INSTANCE = <span class="keyword">new</span> DefaultTestHero();

    <span class="directive">private</span> DefaultTestHero() {
        <span class="local-variable">this</span>.name = DEFAULT_HERO_NAME;
        <span class="local-variable">this</span>.picture = DEFAULT_HERO_PICTURE;
        <span class="local-variable">this</span>.powers = DEFAULT_HERO_POWERS;
        <span class="local-variable">this</span>.level = DEFAULT_HERO_LEVEL;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the extended Quarkus Mockito support to the <code>fight</code> service&#8217;s <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>quarkus-junit5-mockito<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add the following to the top of the <code>FightResourceTest</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@InjectMock</span>
<span class="annotation">@RestClient</span>
HeroProxy heroProxy;

<span class="annotation">@BeforeEach</span>
<span class="directive">public</span> <span class="type">void</span> setup() {
    when(heroProxy.findRandomHero()).thenReturn(DefaultTestHero.INSTANCE);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>when</code> call is a static import of <code>Mockito.when</code>.
The <a href="https://quarkus.io/guides/getting-started-testing#further-simplification-with-injectmock"><code>@InjectMock</code></a> annotation results in a mock being created and made available in test methods of the test class.
Importantly, other test classes are not affected by this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">io.quarkus.test.InjectMock</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.Mockito.when</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.rest.client.inject.RestClient</span>;</code></pre>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Finally, edit the <code>FightResourceTest</code> and add the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> shouldGetRandomFighters() {
    Fighters fighters = given()
        .when()
        .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights/randomfighters</span><span class="delimiter">&quot;</span></span>)
        .then()
        .statusCode(OK.getStatusCode())
        .contentType(APPLICATION_JSON)
        .extract()
        .as(Fighters.class);

    Hero hero = fighters.hero;
    assertEquals(hero.name, DefaultTestHero.DEFAULT_HERO_NAME);
    assertEquals(hero.picture, DefaultTestHero.DEFAULT_HERO_PICTURE);
    assertEquals(hero.level, DefaultTestHero.DEFAULT_HERO_LEVEL);
    assertEquals(hero.powers, DefaultTestHero.DEFAULT_HERO_POWERS);

    Villain villain = fighters.villain;
    assertEquals(villain.name, DefaultTestVillain.DEFAULT_VILLAIN_NAME);
    assertEquals(villain.picture, DefaultTestVillain.DEFAULT_VILLAIN_PICTURE);
    assertEquals(villain.level, DefaultTestVillain.DEFAULT_VILLAIN_LEVEL);
    assertEquals(villain.powers, DefaultTestVillain.DEFAULT_VILLAIN_POWERS);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, run the test from the dev mode, or from your IDE.
You can shutdown the hero and villain services to verify that the tests still pass.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Time to play.
Start the Hero, Villain and Fight microservices as well as the user interface (using <code>./mvnw quarkus:dev</code> on each project) and select random fighters.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/react-ui.png" alt="react ui">
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest-client-fallbacks">Fallbacks</h3>
<div class="paragraph">
<p>So now you&#8217;ve been playing this great Super Heroes Fight for a few hours&#8230;&#8203; and you kill the Hero REST API.
What happens?
Well, the Fight REST API cannot invoke the Hero API anymore and breaks with the following exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Caused by: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: localhost/127.0.0.1:8083
Caused by: java.net.ConnectException: Connection refused
        at java.base/sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)
        at java.base/sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:777)
        at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:330)
        at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:334)
        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:707)
        at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:655)
        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:581)
        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493)
        at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)
        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.base/java.lang.Thread.run(Thread.java:829)</code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the challenges brought by the distributed nature of microservices is that communication with external systems is inherently unreliable.
This increases demand on resiliency of applications.
To simplify making more resilient applications, Quarkus contains an implementation of the MicroProfile Fault Tolerance specification.<sup class="footnote">[<a id="_footnoteref_20" class="footnote" href="#_footnotedef_20" title="View footnote.">20</a>]</sup></p>
</div>
<div class="sect3">
<h4 id="_installing_the_fault_tolerance_dependency">Installing the Fault Tolerance Dependency</h4>
<div class="paragraph">
<p>To install the MicroProfile Fault Tolerance dependency, just run the following command in the Fight microservice:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:add-extension -Dextensions=&quot;smallrye-fault-tolerance&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will add the following dependency in the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>quarkus-smallrye-fault-tolerance<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_fallbacks">Adding Fallbacks</h4>
<div class="paragraph">
<p>Let&#8217;s make our find random fighters feature better by providing a fallback way of getting a dummy hero or villain in case of failure.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that, add two fallback methods to the <code>FightService</code> and a <code>@Fallback</code> annotation to both <code>findRandomHero</code> and <code>findRandomVillain</code> methods as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Fallback</span>(fallbackMethod = <span class="string"><span class="delimiter">&quot;</span><span class="content">fallbackRandomHero</span><span class="delimiter">&quot;</span></span>)
Hero findRandomHero() {
    <span class="keyword">return</span> heroProxy.findRandomHero();
}

<span class="annotation">@Fallback</span>(fallbackMethod = <span class="string"><span class="delimiter">&quot;</span><span class="content">fallbackRandomVillain</span><span class="delimiter">&quot;</span></span>)
Villain findRandomVillain() {
    <span class="keyword">return</span> villainProxy.findRandomVillain();
}

<span class="directive">public</span> Hero fallbackRandomHero() {
    logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Falling back on Hero</span><span class="delimiter">&quot;</span></span>);
    Hero hero = <span class="keyword">new</span> Hero();
    hero.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Fallback hero</span><span class="delimiter">&quot;</span></span>;
    hero.picture = <span class="string"><span class="delimiter">&quot;</span><span class="content">https://dummyimage.com/240x320/1e8fff/ffffff&amp;text=Fallback+Hero</span><span class="delimiter">&quot;</span></span>;
    hero.powers = <span class="string"><span class="delimiter">&quot;</span><span class="content">Fallback hero powers</span><span class="delimiter">&quot;</span></span>;
    hero.level = <span class="integer">1</span>;
    <span class="keyword">return</span> hero;
}

<span class="directive">public</span> Villain fallbackRandomVillain() {
    logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Falling back on Villain</span><span class="delimiter">&quot;</span></span>);
    Villain villain = <span class="keyword">new</span> Villain();
    villain.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Fallback villain</span><span class="delimiter">&quot;</span></span>;
    villain.picture = <span class="string"><span class="delimiter">&quot;</span><span class="content">https://dummyimage.com/240x320/b22222/ffffff&amp;text=Fallback+Villain</span><span class="delimiter">&quot;</span></span>;
    villain.powers = <span class="string"><span class="delimiter">&quot;</span><span class="content">Fallback villain powers</span><span class="delimiter">&quot;</span></span>;
    villain.level = <span class="integer">42</span>;
    <span class="keyword">return</span> villain;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Also add the <code>import org.eclipse.microprofile.faulttolerance.Fallback;</code> statement.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_application_2">Running the Application</h4>
<div class="paragraph">
<p>Now we are ready to run our application and test the fallbacks.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For that, kill the Hero (and/or the Villain API) and start playing again.
You should see the following:</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/fault-tolerance-fallback.png" alt="fault tolerance fallback">
</div>
</div>
<div class="paragraph">
<p>Restart the Hero REST API&#8230;&#8203; and keep on playing.
Super-heroes are back to the fight!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest-client-timeout">Timeout</h3>
<div class="paragraph">
<p>Sometimes invoking a REST API can take a long time.
In fact, the more microservices invoke other microservices, the more network latency you can have.
And what happens when a HTTP request takes long?
Well, it hangs.
On your browser you can see the request pending if you turn on the dev tools and look at what&#8217;s the network is doing.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/fault-tolerance-pending.png" alt="fault tolerance pending">
</div>
</div>
<div class="sect3">
<h4 id="_adding_timeouts">Adding Timeouts</h4>
<div class="paragraph">
<p>Getting random fighters can take longer than expected.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To simulate a long-running process, add the following code to the <code>FightResource</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ConfigProperty</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">process.milliseconds</span><span class="delimiter">&quot;</span></span>, defaultValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
<span class="type">long</span> tooManyMilliseconds;

<span class="directive">private</span> <span class="type">void</span> veryLongProcess() {
    <span class="keyword">try</span> {
        <span class="predefined-type">Thread</span>.sleep(tooManyMilliseconds);
    } <span class="keyword">catch</span> (<span class="exception">InterruptedException</span> e) {
        <span class="predefined-type">Thread</span>.currentThread().interrupt();
    }
}

<span class="annotation">@GET</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/randomfighters</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Timeout</span>(<span class="integer">500</span>) <span class="comment">// &lt;-- Added</span>
<span class="directive">public</span> Response getRandomFighters() {
    veryLongProcess(); <span class="comment">// &lt;-- Added</span>
    Fighters fighters = service.findRandomFighters();
    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Get random fighters </span><span class="delimiter">&quot;</span></span> + fighters);
    <span class="keyword">return</span> Response.ok(fighters).build();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t forget to add the following import:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.eclipse.microprofile.config.inject.ConfigProperty</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.faulttolerance.Timeout</span>;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s say we&#8217;ve added some new functionality in the <code>veryLongProcess</code> method.
When the process is really too long and the system is overloaded, we would rather time out.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Note that the timeout was configured to 500 ms, and a <code>Thread.sleep</code> was introduced and can be configured in the <code>application.properties</code>.
If we set the property to a higher value than the timeout, let&#8217;s say 10.000, then the request should be interrupted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">process.milliseconds=<span class="integer">10000</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_application_3">Running the Application</h4>
<div class="paragraph">
<p>Now that you have set the number of waiting milliseconds to 10.000, run the application and start fighting again.
You should see the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">18:40:48 ERROR [or.jb.re.re.co.co.AbstractResteasyReactiveContext] (executor-thread-0) Request failed: org.eclipse.microprofile.faulttolerance.exceptions.TimeoutException: Timeout[io.quarkus.workshop.superheroes.fight.FightResource#getRandomFighters] timed out
        at io.smallrye.faulttolerance.core.timeout.Timeout.timeoutException(Timeout.java:91)
        at io.smallrye.faulttolerance.core.timeout.Timeout.doApply(Timeout.java:78)
        at io.smallrye.faulttolerance.core.timeout.Timeout.apply(Timeout.java:30)
...</code></pre>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Before going further, set the <code>process.milliseconds</code> to 0.</p>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have any problem with the code, don&#8217;t understand or feel you are running, remember to ask for some help.
Also, you can get the code of this entire workshop from <a href="https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes" class="bare">https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes</a>.
You can also download the completed code from <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop-complete.zip" class="bare">https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop-complete.zip</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ai">Artificial Intelligence</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>On one side we have superheroes, and on the other side we have super villains.
What happens when they fight?
Let&#8217;s ask an AI to narrate the fight!</p>
</div>
<div class="paragraph">
<p>In this section we will introduce a new microservice that will use AI to narrate the fight between a superhero and a super villain.
It will use the Semantic Kernel API to generate the text invoking OpenAI or Azure OpenAI (you choose).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-fb020717f07781a3b0d3c7233671acc6.png" alt="Diagram" width="300" height="612">
</div>
</div>
<div class="paragraph">
<p>In the following sections, you will learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What is Semantic Kernel?</p>
</li>
<li>
<p>How to invoke OpenAI or Azure OpenAI GPT model using Semantic Kernel</p>
</li>
<li>
<p>How to create an OpenAI Plugin (a.k.a Skill) to narrate a fight</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This service is exposed on the port 8086.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_whats_semantic_kernel">What&#8217;s Semantic Kernel?</h3>
<div class="paragraph">
<p><a href="https://learn.microsoft.com/semantic-kernel/overview">Semantic Kernel</a> is an open-source SDK that lets you easily combine AI services like OpenAI, Azure OpenAI, and Hugging Face with conventional programming languages like C#, Python or Java.
By doing so, you can create AI apps that combine the best of both worlds:
the deterministic nature of conventional programming and the semantic aspect of AI.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/semantic-kernel.png" alt="semantic kernel">
</div>
</div>
<div class="paragraph">
<p>Semantic Kernel has been engineered to allow developers to flexibly integrate AI services into their existing apps.
To do so, Semantic Kernel provides a set of connectors that make it easy to add memories and models.
In this way, Semantic Kernel is able to add a simulated "brain" to your app.</p>
</div>
<div class="paragraph">
<p>Additionally, Semantic Kernel makes it easy to add skills to your applications with AI plugins that allow you to interact with the real world.
These plugins are composed of prompts and native functions that can respond to triggers and perform actions.
In this way, plugins are like the "body" of your AI app.</p>
</div>
</div>
<div class="sect2">
<h3 id="_narration_microservice">Narration Microservice</h3>
<div class="paragraph">
<p>Let&#8217;s create a new microservice that will use Semantic Kernel to narrate the fight between a superhero and a super villain.
New microservice, new project!</p>
</div>
<div class="paragraph">
<p>As before, the easiest way to create this new Quarkus project is to use the Quarkus Maven plugin (you can also go to <a href="https://code.quarkus.io" class="bare">https://code.quarkus.io</a> if you prefer).
Open a terminal and run the following command under the <code>quarkus-workshop-super-heroes/super-heroes</code> directory:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw io.quarkus:quarkus-maven-plugin:3.6.0:create \
    -DplatformVersion=3.6.0 \
    -DprojectGroupId=io.quarkus.workshop.super-heroes \
    -DprojectArtifactId=rest-narration \
    -DclassName=&quot;io.quarkus.workshop.superheroes.narration.NarrationResource&quot; \
    -Dpath=&quot;api/narration&quot; \
    -Dextensions=&quot;resteasy-reactive-jackson,quarkus-smallrye-openapi,quarkus-smallrye-fault-tolerance&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This microservice needs less dependencies than the previous ones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>resteasy-reactive-jackson</code> provides RESTEasy Reactive and the ability to map JSON objects,</p>
</li>
<li>
<p><code>quarkus-smallrye-openapi</code> provides the OpenAPI descriptor support and the Swagger UI in the dev console,</p>
</li>
<li>
<p><code>quarkus-smallrye-fault-tolerance</code> provides the MicroProfile Fault Tolerance dependency so we can fallback in case OpenAI/Azure OpenAI does not respond.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want your IDE to manage this new Maven project, you can declare it in the parent POM by adding this new module in the <code>&lt;modules&gt;</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;module&gt;</span>super-heroes/rest-narration<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_directory_structure_8">Directory Structure</h4>
<div class="paragraph">
<p>At the end of this chapter, you will end up with the following directory structure (notice the <code>NarrationSkill</code> directory under <code>src/main/resources</code>):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-8d5a4934150957500484b7319611febe.png" alt="Diagram" width="342" height="527">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_semantic_kernel_dependencies">Add the Semantic Kernel dependencies</h4>
<div class="paragraph">
<p>Once the project is created, you need to add the Semantic Kernel dependencies.
Semantic Kernel is available on <a href="https://central.sonatype.com/artifact/com.microsoft.semantic-kernel/semantickernel-bom">Maven Central</a>.
It has a BOM (Bill of Materials) that you can import in your project and then add the dependencies you need.
Add the following XML in the <code>rest-narration/pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;properties&gt;</span>
    <span class="comment">&lt;!-- ... --&gt;</span>
    <span class="tag">&lt;semantic-kernel.version&gt;</span>0.2.11-alpha<span class="tag">&lt;/semantic-kernel.version&gt;</span>
  <span class="tag">&lt;/properties&gt;</span>
  <span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
      <span class="comment">&lt;!-- ... --&gt;</span>
      <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>com.microsoft.semantic-kernel<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>semantickernel-bom<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${semantic-kernel.version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
        <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
      <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
  <span class="tag">&lt;/dependencyManagement&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
    <span class="comment">&lt;!-- ... --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>com.microsoft.semantic-kernel<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>semantickernel-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>com.microsoft.semantic-kernel<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>semantickernel-settings-loader<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>com.microsoft.semantic-kernel<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>semantickernel-connectors-ai-openai<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_fight_bean">The Fight bean</h4>
<div class="paragraph">
<p>Let&#8217;s start with the <code>Fight</code> class.
The fight is what is going to be narrated by the microservice and ultimately sent by the Fight microservice.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the <code>io.quarkus.workshop.superheroes.narration.Fight</code> class in the created project with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.narration</span>;

<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.media.Schema</span>;

<span class="annotation">@Schema</span>(description = <span class="string"><span class="delimiter">&quot;</span><span class="content">The fight that is narrated</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Fight</span> {

    <span class="directive">public</span> <span class="predefined-type">String</span> winnerName;
    <span class="directive">public</span> <span class="type">int</span> winnerLevel;
    <span class="directive">public</span> <span class="predefined-type">String</span> winnerPowers;
    <span class="directive">public</span> <span class="predefined-type">String</span> loserName;
    <span class="directive">public</span> <span class="type">int</span> loserLevel;
    <span class="directive">public</span> <span class="predefined-type">String</span> loserPowers;
    <span class="directive">public</span> <span class="predefined-type">String</span> winnerTeam;
    <span class="directive">public</span> <span class="predefined-type">String</span> loserTeam;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_narration_rest_resource">The Narration REST Resource</h4>
<div class="paragraph">
<p>The <code>NarrationResource</code> only has one HTTP POST method to create a new narration.
Given a fight, it will invoke the <code>NarrationService</code> to return a fight narration.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Open the generated <code>io.quarkus.workshop.superheroes.narration.NarrationResource</code> and update the content to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.narration</span>;

<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs</span>.*;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.Response</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.openapi.annotations.tags.Tag</span>;

<span class="comment">/**
 * JAX-RS API endpoints with &lt;code&gt;/api/narration&lt;/code&gt; as the base URI for all endpoints
 */</span>

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/narration</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN)
<span class="annotation">@Consumes</span>(MediaType.APPLICATION_JSON)
<span class="annotation">@Tag</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">narration</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">NarrationResource</span> {

    <span class="annotation">@Inject</span>
    NarrationService service;

    <span class="annotation">@POST</span>
    <span class="directive">public</span> Response narrate(Fight fight) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> narration = service.narrate(fight);
        <span class="keyword">return</span> Response.status(Response.Status.CREATED).entity(narration).build();
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> hello() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Narration Resource</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_semantic_kernel_narration_service">The Semantic Kernel Narration service</h4>
<div class="paragraph">
<p>Now it&#8217;s time to implement the <code>NarrationService</code> that will use the Semantic Kernel to generate the narration.
First of all, let&#8217;s create an interface that will be implemented by the <code>SemanticKernelNarrationService</code> but could also be implemented by other AI frameworks:
Create the <code>io.quarkus.workshop.superheroes.narration.NarrationService</code> interface in the created project with the following content:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Open the <code>NarrationResource</code> and update the content to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.narration</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">NarrationService</span> {
    <span class="predefined-type">String</span> narrate(Fight fight) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create the <code>io.quarkus.workshop.superheroes.narration.SemanticKernelNarrationService</code> that implements the <code>NarrationService</code> interface.
This class has the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>narrate</code>: the main method that will use the Semantic Kernel to generate the narration</p>
</li>
<li>
<p><code>fallbackNarrate</code>: the fallback method that will be invoked if the <code>narrate</code> method fails (due to a timeout for example)</p>
</li>
<li>
<p><code>getClient</code>: a method that returns the Semantic Kernel client configured by the <code>conf.properties</code> file</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.narration</span>;

<span class="keyword">import</span> <span class="include">com.azure.ai.openai.OpenAIAsyncClient</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.Kernel</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.SKBuilders</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.connectors.ai.openai.util.OpenAIClientProvider</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.exceptions.ConfigurationException</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.orchestration.SKContext</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.skilldefinition.ReadOnlyFunctionCollection</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.textcompletion.CompletionSKFunction</span>;
<span class="keyword">import</span> <span class="include">com.microsoft.semantickernel.textcompletion.TextCompletion</span>;
<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.faulttolerance.Fallback</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.faulttolerance.Timeout</span>;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>;

<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.io.InputStream</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SemanticKernelNarrationService</span> <span class="directive">implements</span> NarrationService {

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Logger</span> logger;

    <span class="annotation">@Override</span>
    <span class="annotation">@Fallback</span>(fallbackMethod = <span class="string"><span class="delimiter">&quot;</span><span class="content">fallbackNarrate</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Timeout</span>(<span class="integer">30</span>_000)
    <span class="directive">public</span> <span class="predefined-type">String</span> narrate(Fight fight) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// Creates an Azure OpenAI client</span>
        OpenAIAsyncClient client = getClient();

        <span class="comment">// Creates an instance of the TextCompletion service</span>
        TextCompletion textCompletion = SKBuilders.chatCompletion().withOpenAIClient(client).withModelId(<span class="string"><span class="delimiter">&quot;</span><span class="content">gpt35turbo</span><span class="delimiter">&quot;</span></span>).build();

        <span class="comment">// Instantiates the Kernel</span>
        <span class="predefined-type">Kernel</span> kernel = SKBuilders.kernel().withDefaultAIService(textCompletion).build();

        <span class="comment">// Registers skills</span>
        ReadOnlyFunctionCollection skill = kernel.importSkillFromResources(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">NarrationSkill</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">NarrateFight</span><span class="delimiter">&quot;</span></span>);
        CompletionSKFunction fightFunction = skill.getFunction(<span class="string"><span class="delimiter">&quot;</span><span class="content">NarrateFight</span><span class="delimiter">&quot;</span></span>, CompletionSKFunction.class);

        <span class="comment">// Ask to narrate a fight</span>
        SKContext fightContext = SKBuilders.context().build();
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">winner_team</span><span class="delimiter">&quot;</span></span>, fight.winnerTeam);
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">winner_name</span><span class="delimiter">&quot;</span></span>, fight.winnerName);
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">winner_powers</span><span class="delimiter">&quot;</span></span>, fight.winnerPowers);
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">winner_level</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.valueOf(fight.winnerLevel));
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">loser_team</span><span class="delimiter">&quot;</span></span>, fight.loserTeam);
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">loser_name</span><span class="delimiter">&quot;</span></span>, fight.loserName);
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">loser_powers</span><span class="delimiter">&quot;</span></span>, fight.loserPowers);
        fightContext.setVariable(<span class="string"><span class="delimiter">&quot;</span><span class="content">loser_level</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.valueOf(fight.loserLevel));
        Mono&lt;SKContext&gt; result = fightFunction.invokeAsync(fightContext);

        <span class="predefined-type">String</span> narration = result.block().getResult();
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">The narration for the fight is: </span><span class="delimiter">&quot;</span></span> + narration);

        <span class="keyword">return</span> narration;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> fallbackNarrate(Fight fight) {
        logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Falling back on Narration</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">
            High above a bustling city, a symbol of hope and justice soared through the sky, while chaos reigned below, with malevolent laughter echoing through the streets.
            With unwavering determination, the figure swiftly descended, effortlessly evading explosive attacks, closing the gap, and delivering a decisive blow that silenced the wicked laughter.

            In the end, the battle concluded with a clear victory for the forces of good, as their commitment to peace triumphed over the chaos and villainy that had threatened the city.
            The people knew that their protector had once again ensured their safety.
            </span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="directive">private</span> OpenAIAsyncClient getClient() <span class="directive">throws</span> <span class="exception">ConfigurationException</span> {
        <span class="predefined-type">String</span> propertiesFile = <span class="string"><span class="delimiter">&quot;</span><span class="content">conf.properties</span><span class="delimiter">&quot;</span></span>;

        <span class="keyword">try</span> (<span class="predefined-type">InputStream</span> is = <span class="local-variable">this</span>.getClass().getClassLoader().getResourceAsStream(propertiesFile)) {

            <span class="predefined-type">Properties</span> properties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
            properties.load(is);

            OpenAIClientProvider provider = <span class="keyword">new</span> OpenAIClientProvider((<span class="predefined-type">Map</span>) properties, <span class="predefined-constant">null</span>);

            <span class="keyword">return</span> provider.getAsyncClient();
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e);
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_narration_skill">The Narration skill</h4>
<div class="paragraph">
<p>With skills, you can encapsulate AI capabilities into a single unit of functionality.
Semantic Kernel skills implement the <a href="https://platform.openai.com/docs/plugins/getting-started/plugin-manifest">OpenAI Plugin specification</a> also known as "skills".
To narrate a fight, we need to create a <code>NarrateFight</code> function.
For that, you need to create a set of directories unders <code>rest-narration/src/main/resources/NarrationSkill/NarrateFight</code>.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Under the <code>NarrationSkill/NarrateFight</code> directory, create the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>skprompt.txt</code>: the prompt that will be sent to OpenAI/Azure OpenAI</p>
</li>
<li>
<p><code>config.json</code>: the configuration of the skill</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Under <code>src/main/resources/NarrationSkill/NarrateFight/</code>, create the <code>skprompt.txt</code> file with the following content.
Notice that the prompt uses expression language to get the fight data (e.g., <code>{{$winner_name}}</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">ACT LIKE YOU WERE A MARVEL COMICS WRITTER, EXPERT IN ALL SORTS OF SUPER HEROES AND SUPER VILLAINS.
NARRATE THE FIGHT BETWEEN A SUPER HERO AND A SUPER VILLAIN.
DURING THE NARRATION DON'T REPEAT &quot;super hero&quot; OR &quot;super villain&quot; WE KNOW WHO IS WHO.
WRITE 4 PARAGRAPHS MAXIMUM.

THE NARRATION MUST BE:
- G RATED
- WORKPLACE/FAMILY SAFE
NO SEXISM, RACISM OR OTHER BIAS/BIGOTRY

BE CREATIVE.

HERE IS THE DATA YOU WILL USE FOR THE WINNER:

+++++
name:   {{$winner_name}}
powers: {{$winner_powers}}
level:  {{$winner_level}}
+++++

HERE IS THE DATA YOU WILL USE FOR THE LOSER:

+++++
name:   {{$loser_name}}
powers: {{$loser_powers}}
level:  {{$loser_level}}
+++++

HERE IS THE DATA YOU WILL USE FOR THE FIGHT:

+++++
{{$winner_name}} WHO IS A {{$winner_team}} HAS WON THE FIGHT AGAINST {{$loser_name}} WHO IS A {{$loser_team}}.
+++++</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under <code>src/main/resources/NarrationSkill/NarrateFight/</code>, create the <code>config.json</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">schema</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Narrates the fight between a Super Hero and a Super Villain using a single prompt</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">completion</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">completion</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">max_tokens</span><span class="delimiter">&quot;</span></span>: <span class="integer">1000</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">temperature</span><span class="delimiter">&quot;</span></span>: <span class="float">0.9</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">top_p</span><span class="delimiter">&quot;</span></span>: <span class="float">0.0</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">presence_penalty</span><span class="delimiter">&quot;</span></span>: <span class="float">0.0</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">frequency_penalty</span><span class="delimiter">&quot;</span></span>: <span class="float">0.0</span>
    },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">input</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">parameters</span><span class="delimiter">&quot;</span></span>: [
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">winner_name</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The name of the winner</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Darth Vader</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">winner_powers</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The comma separated list of powers of the winner</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Accelerated Healing, Agility, Astral Projection, Cloaking, Danger Sense, Durability, Electrokinesis, Energy Blasts, Enhanced Hearing, Enhanced Senses, Force Fields, Hypnokinesis, Illusions, Intelligence, Jump, Light Control, Marksmanship, Precognition, Psionic Powers, Reflexes, Stealth, Super Speed, Telekinesis, Telepathy, The Force, Weapons Master</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">winner_level</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">A number representing the level of the winner</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">13</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">loser_name</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The name of the loser</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Chewbacca</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">loser_powers</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The comma separated list of powers of the loser</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Agility, Longevity, Marksmanship, Natural Weapons, Stealth, Super Strength, Weapons Master</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">loser_level</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">A number representing the level of the loser</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">winner_team</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The team winning. Can be either 'heroes' or 'villains'</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">villains</span><span class="delimiter">&quot;</span></span>
            },
            {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">loser_team</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The team winning. Can be either 'heroes' or 'villains'</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultValue</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">heroes</span><span class="delimiter">&quot;</span></span>
            }
        ]
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_openaiazure_openai_access">Configuring OpenAI/Azure OpenAI access</h4>
<div class="paragraph">
<p>Configuring the OpenAI/Azure OpenAI access is made thanks to the <code>conf.properties</code>.
Depending if you have previously chosen OpenAI or Azure OpenAI, you either need to use the <code>client.openai</code> or <code>client.azureopenai</code> configuration keys.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure that you have previously either created an Azure AI or OpenAI subscription.
If not, go back to <a href="#introduction-installing-ai">OpenAI or Azure OpenAI Subscriptions</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>If you use OpenAI, create the <code>rest-narration/src/main/resources/conf.properties</code> file and add the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">client.openai.key=
client.openai.organizationid=</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Azure OpenAI, use the following configuration in the <code>rest-narration/src/main/resources/conf.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">client.azureopenai.key=
client.azureopenai.endpoint=
client.azureopenai.deploymentname=</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also set the port of the Narration microservice to be 8086.
And to have a better view of what&#8217;s happening behind the scene with Semantic Kernel, we can increase the log level.
Just add the following configuration to the Quarkus <code>application.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">## HTTP configuration
quarkus.http.port=8086

## Custom banner file path
quarkus.banner.path=banner.txt

## CORS
quarkus.http.cors=true
quarkus.http.cors.origins=*
## Logging configuration
quarkus.log.category.&quot;com.microsoft.semantickernel&quot;.level=DEBUG</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_narration_microservice">Testing the Narration Microservice</h4>
<div class="paragraph">
<p>Time for some tests!
But before creating the test class, we need to add the Mockito dependency to the project.
That&#8217;s because we want to mock the Semantic Kernel client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>quarkus-junit5-mockito<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Open the <code>io.quarkus.workshop.superheroes.narration.NarrationResourceTest</code> class and copy the following content:</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.narration</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.InjectMock</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.test.junit.QuarkusTest</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.BeforeEach</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.mockito.Mockito</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.restassured.RestAssured.given</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.ACCEPT</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.HttpHeaders.CONTENT_TYPE</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.APPLICATION_JSON</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.TEXT_PLAIN</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.CREATED</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.Response.Status.OK</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.CoreMatchers.is</span>;

<span class="annotation">@QuarkusTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">NarrationResourceTest</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> HERO_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Baguette</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> HERO_LEVEL = <span class="integer">42</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> HERO_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">Eats baguette in less than a second</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> VILLAIN_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Super Chocolatine</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> VILLAIN_LEVEL = <span class="integer">43</span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> VILLAIN_POWERS = <span class="string"><span class="delimiter">&quot;</span><span class="content">Transforms chocolatine into pain au chocolat</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@InjectMock</span>
    NarrationService narrationService;

    <span class="directive">private</span> <span class="directive">static</span> Fight getFight() {
        Fight fight = <span class="keyword">new</span> Fight();
        fight.winnerName = VILLAIN_NAME;
        fight.winnerLevel = VILLAIN_LEVEL;
        fight.winnerPowers = VILLAIN_POWERS;
        fight.loserName = HERO_NAME;
        fight.loserLevel = HERO_LEVEL;
        fight.loserPowers = HERO_POWERS;
        fight.winnerTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">villains</span><span class="delimiter">&quot;</span></span>;
        fight.loserTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">heroes</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">return</span> fight;
    }

    <span class="annotation">@BeforeEach</span>
    <span class="directive">public</span> <span class="type">void</span> setup() <span class="directive">throws</span> <span class="exception">Exception</span> {
        Mockito.when(narrationService.narrate(getFight())).thenReturn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Lorem ipsum dolor sit amet</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldPingOpenAPI() {
        given()
            .header(ACCEPT, APPLICATION_JSON)
            .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/q/openapi</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(OK.getStatusCode());
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testHelloEndpoint() {
        given()
            .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/narration/hello</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(<span class="integer">200</span>)
            .body(is(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Narration Resource</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> shouldNarrateAFight() {
        given().log().all()
            .body(getFight())
            .header(CONTENT_TYPE, APPLICATION_JSON)
            .header(ACCEPT, TEXT_PLAIN)
            .when()
            .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/narration</span><span class="delimiter">&quot;</span></span>)
            .then()
            .statusCode(CREATED.getStatusCode());
<span class="comment">//            .body(startsWith(&quot;Lorem ipsum dolor sit amet&quot;));</span>
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Make sure the tests pass by executing the command <code>./mvnw test</code> (or from your IDE).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_narration_microservice">Running the Narration Microservice</h4>
<div class="paragraph">
<p>Now that the tests are green, we are ready to run our Narration microservice.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Use <code>./mvnw quarkus:dev</code> to start it.
Once the Narration microservice is started, create a new narration with the following cUrl command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl -X POST -d  '{&quot;winnerName&quot;:&quot;Super winner&quot;, &quot;winnerLevel&quot;:42, &quot;winnerPowers&quot;:&quot;jumping&quot;, &quot;loserName&quot;:&quot;Super loser&quot;, &quot;loserLevel&quot;:2, &quot;loserPowers&quot;:&quot;leaping&quot;, &quot;winnerTeam&quot;:&quot;heroes&quot;, &quot;loserTeam&quot;:&quot;villains&quot; }'  -H &quot;Content-Type: application/json&quot; http://localhost:8086/api/narration -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get something similar to the following response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">&lt; HTTP/1.1 201 Created
&lt; Content-Type: text/plain;charset=UTF-8

The battle between the towering Chewbacca and the dark and menacing Darth Vader was one for the ages. Chewbacca's incredible strength and agility were no match for Vader's mastery of the Force and his arsenal of weapons. The two clashed in a flurry of blows and energy blasts, each trying to gain the upper hand.

Despite Chewbacca's valiant efforts, it was clear that Vader was the superior fighter. His precognition and danger sense allowed him to anticipate every move Chewbacca made, and his energy blasts and electrokinesis were devastating. In the end, Vader emerged victorious, leaving Chewbacca battered and defeated.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The cUrl command returns the narration of the fight as <code>text/plain</code>.</p>
</div>
<div class="paragraph">
<p>Remember that you can also check Swagger UI by going to the dev console: <a href="http://localhost:8086/q/dev" class="bare">http://localhost:8086/q/dev</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invoking_the_narration_microservice_from_the_fight_microservice">Invoking the Narration Microservice from the Fight Microservice</h3>
<div class="paragraph">
<p>Now that we have a narration microservice up and running, we can invoke it from the fight microservice.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-bcc9a67d5e52ee470086718c8e13ab73.png" alt="Diagram" width="300" height="1968">
</div>
</div>
<div class="sect3">
<h4 id="_adding_narration_to_the_fight_microservice">Adding narration to the Fight Microservice</h4>
<div class="paragraph">
<p>We now need to add a new endpoint to the Fight microservice to invoke the Narration microservice.
Because it uses a remote call, we need to use the <code>@RegisterRestClient</code> annotation to register the <code>NarrationProxy</code> as a REST client.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Go back to the <code>io.quarkus.workshop.superheroes.fight.FightResource</code> class and add the new <code>narrateFight</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@POST</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/narrate</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Consumes</span>(APPLICATION_JSON)
<span class="annotation">@Produces</span>(TEXT_PLAIN)
<span class="directive">public</span> Response narrateFight(<span class="annotation">@Valid</span> Fight fight) {
    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Narrate the fight </span><span class="delimiter">&quot;</span></span> + fight);
    <span class="predefined-type">String</span> narration = service.narrateFight(fight);
    <span class="keyword">return</span> Response.status(Response.Status.CREATED).entity(narration).build();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>FightResource</code> invokes a new method of the <code>FightService</code>.
Add the following method to the <code>io.quarkus.workshop.superheroes.fight.FightService</code> class and make sure to inject the <code>NarrationProxy</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestClient</span>
NarrationProxy narrationProxy;

<span class="directive">public</span> <span class="predefined-type">String</span> narrateFight(Fight fight) {
    <span class="keyword">return</span> narrationProxy.narrate(fight);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under the <code>client</code> package, where all the other proxies are already located, create a new <code>NarrationProxy</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.Fight</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Consumes</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.POST</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Produces</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/narration</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN)
<span class="annotation">@Consumes</span>(MediaType.APPLICATION_JSON)
<span class="annotation">@RegisterRestClient</span>(configKey = <span class="string"><span class="delimiter">&quot;</span><span class="content">narration</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">NarrationProxy</span> {

    <span class="annotation">@POST</span>
    <span class="predefined-type">String</span> narrate(Fight fight);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To link both microservices, we need to add the following configuration to the <code>rest-fights/src/main/resources/application.properties</code> file of the fight microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.rest-client.narration.url=http://localhost:8086</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_test_and_mock_the_narration_microservice_invocation">Test and mock the Narration microservice invocation</h4>
<div class="paragraph">
<p>Like the other dependencies, the Narration microservice needs to be mocked so we can test the Fight microservice in isolation.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Add the following <code>shouldNarrate</code> test to the <code>io.quarkus.workshop.superheroes.fight.FightResourceTest</code> class.
And make sure you use the right imports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.time.Instant</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">jakarta.ws.rs.core.MediaType.TEXT_PLAIN</span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> shouldNarrate() {
    Fight fight = <span class="keyword">new</span> Fight();
    fight.fightDate = Instant.now();
    fight.winnerName = DEFAULT_WINNER_NAME;
    fight.winnerLevel = DEFAULT_WINNER_LEVEL;
    fight.winnerPowers = DEFAULT_WINNER_POWERS;
    fight.winnerPicture = DEFAULT_WINNER_PICTURE;
    fight.loserName = DEFAULT_LOSER_NAME;
    fight.loserLevel = DEFAULT_LOSER_LEVEL;
    fight.loserPowers = DEFAULT_LOSER_POWERS;
    fight.loserPicture = DEFAULT_LOSER_PICTURE;
    fight.winnerTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">villains</span><span class="delimiter">&quot;</span></span>;
    fight.loserTeam = <span class="string"><span class="delimiter">&quot;</span><span class="content">heroes</span><span class="delimiter">&quot;</span></span>;

    given().body(fight)
        .header(CONTENT_TYPE, APPLICATION_JSON)
        .header(ACCEPT, TEXT_PLAIN)
        .when()
        .post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/fights/narrate</span><span class="delimiter">&quot;</span></span>)
        .then()
        .statusCode(CREATED.getStatusCode())
        .body(startsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">Lorem ipsum dolor sit amet</span><span class="delimiter">&quot;</span></span>));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>io.quarkus.workshop.superheroes.fight.client.MockNarrationProxy</code> class and add the new <code>narrateFight</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.fight.client</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.test.Mock</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.fight.Fight</span>;
<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.rest.client.inject.RestClient</span>;

<span class="annotation">@Mock</span>
<span class="annotation">@ApplicationScoped</span>
<span class="annotation">@RestClient</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MockNarrationProxy</span> <span class="directive">implements</span> NarrationProxy {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> narrate(Fight fight) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
            Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
            Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
            </span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now execute <code>./mvnw test</code> and make sure that all the tests pass.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_testing_and_packaging_the_application_3">Running, Testing and Packaging the Application</h3>
<div class="paragraph">
<p>Time to run the entire application!
For that, start all the microservices (Heroes, Villains, Fight and Narration) as well as the frontend.
When all the microservices are started, access the frontend at <a href="http://localhost:8080" class="bare">http://localhost:8080</a> and click on the <code>Fight</code> button.
The result of the fight is displayed, and below, you have a "Narrate the fight" button.
Click on it, wait a few seconds (remember that the Narration microservice access a remote AI service that takes time) and the narration of the fight is displayed.
Being <em>Generative AI</em>, you can click several times on the button and you will get different narrations.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="../../images/react-ui-ai.png" alt="react ui ai">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="native">Building Native Executables</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>Let&#8217;s now produce native executables for our application.
Thanks to its GraalVM integration, Quarkus can easily generate native executables.
Just like Go, native executables don&#8217;t need a VM to run; they contain the whole application, like an <code>.exe</code> file on Windows.</p>
</div>
<div class="sect2">
<h3 id="_building_native_executables_with_quarkus">Building Native Executables with Quarkus</h3>
<div class="paragraph">
<p>Having native executables for our microservices improves their startup time and produces a minimal disk footprint.
This can be a big plus if your microservices run in a serverless environment where scaling from zero is important.
The produced binary has everything to run the application, including the needed parts of the "JVM" (shrunk to be just enough to run the application), and the application itself.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Choosing JVM execution vs. native executable execution depends on your application needs and environment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To be able to build native executables, you need GraalVM to be installed.
And make sure you have the <code>GRAALVM_HOME</code> environment variable defined and pointing to where you installed GraalVM.
Then, if you look at all the <code>pom.xml</code> files, you will find the following profile.
This allows you to build a native executable just by invoking <code>./mvnw package -Pnative</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;profile&gt;</span>
    <span class="tag">&lt;id&gt;</span>native<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;property&gt;</span>
            <span class="tag">&lt;name&gt;</span>native<span class="tag">&lt;/name&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
    <span class="tag">&lt;properties&gt;</span>
        <span class="tag">&lt;skipITs&gt;</span>false<span class="tag">&lt;/skipITs&gt;</span>
        <span class="tag">&lt;quarkus.package.type&gt;</span>native<span class="tag">&lt;/quarkus.package.type&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>
<span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_native_executables_for_our_microservices">Building Native Executables for our Microservices</h3>
<div class="paragraph">
<p>Let&#8217;s create native executables for all our microservices.
Well, maybe not all of them.
Let&#8217;s see.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>From the root <code>super-heroes</code> directory, run the following commands (to speed up the compilation you can also skip the tests by adding <code>-Dmaven.test.skip=true</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw --file rest-fights/pom.xml package -Pnative
./mvnw --file rest-heroes/pom.xml package -Pnative
./mvnw --file rest-villains/pom.xml package -Pnative
./mvnw --file ui-super-heroes/pom.xml package -Pnative</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Creating a native executable requires a lot of memory and CPU.
It also takes a few minutes, even for a simple application like the Villain microservice.
Most of the time is spent during the dead code elimination, as it traverses the whole (closed) world.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>During the compilation of each microservice, you see a lot of information about the native compilation.
Below is a summary of the output for that you will get.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">===========================================================================================
GraalVM Native Image: Generating 'rest-heroes-1.0.0-SNAPSHOT-runner' (executable)...
===========================================================================================
[1/8] Initializing...                                                      (24.3s @ 0.53GB)
[2/8] Performing analysis...
[3/8] Building universe...                                                  (6.9s @ 4.64GB)
[4/8] Parsing methods...      [***]                                         (5.1s @ 2.80GB)
[5/8] Inlining methods...     [***]                                         (2.1s @ 4.71GB)
[6/8] Compiling methods...    [********]                                  (67.6s @ 10.11GB)
[7/8] Layouting methods...    [***]                                         (9.4s @ 4.04GB)
[8/8] Creating image...       [***]                                         (9.1s @ 5.41GB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you try to execute <code>./mvnw package -Pnative</code> in the Narration microservice, the compilation will fail.
You will get something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">===========================================================================================
GraalVM Native Image: Generating 'rest-narration-1.0.0-SNAPSHOT-runner' (executable)...
===========================================================================================
[1/8] Initializing...                                                      (24.3s @ 0.53GB)
[2/8] Performing analysis...
ERROR [com.azu.cor.imp.jac.XmlMapperFactory] Failed to retrieve MethodHandles used to create XmlMapper. XML serialization won't be supported until 'com.fasterxml.jackson.dataformat:jackson-dataformat-xml'
ERROR [com.azu.cor.imp.jac.ObjectMapperShim] Package versions: jackson-core=2.15.2, jackson-databind=2.15.2, jackson-dataformat-xml=unknown, jackson-datatype-jsr310=2.15.2
Error: Classes that should be initialized at run time got initialized during image building</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s because the Narration microservice uses external libraries that are not easily compilable with GraaVM.
Not all libraries are compatible with GraalVM out of the box.
Therefore, we will keep on running the Narration microservice in JVM mode, not in native mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw --file rest-narration/pom.xml clean package</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_application_in_native_mode">Running the Application in Native mode</h3>
<div class="paragraph">
<p>The native compilation takes a while.
In addition to the regular files, the build also produces <code>target/xxx-yyy-1.0.0-SNAPSHOT-runner</code> files.
Notice that there is no <code>.jar</code> file extension.
It&#8217;s just a binary file that you can execute directly like any other binary.
Let&#8217;s execute the entire application in native mode.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Native mode is using the <code>prod</code> profile, meaning that the infrastructure needs to be up and running (<code>docker compose -f docker-compose.yaml up -d</code>).
Then, from the root <code>super-heroes</code> directory, run the following commands (to speed up the compilation you can also skip the tests by adding <code>-Dmaven.test.skip=true</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./rest-fights/target/rest-fights-1.0.0-SNAPSHOT-runner
./rest-heroes/target/rest-heroes-1.0.0-SNAPSHOT-runner
./rest-villains/target/rest-villains-1.0.0-SNAPSHOT-runner
./ui-super-heroes/target/ui-super-heroes-1.0.0-SNAPSHOT-runner
./rest-narration/target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> and start new fights.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="container">Building Containers</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>In this chapter we will build containers out of our Quarkus microservices and execute them locally thanks to Docker Compose.
Thanks to Quarkus Cloud Native capabilities, we will be able to build and execute containers easily.
We will also produce Linux 64 bits native executables and runs them in a container.
The native compilation uses the OS and architecture of the host system.</p>
</div>
<div class="sect2">
<h3 id="_building_containers_with_quarkus">Building Containers with Quarkus</h3>
<div class="paragraph">
<p>When we bootstrapped our microservices with the Maven Quarkus plugin, a set of <code>Dockerfiles</code> have been generated under <code>src/main/docker</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Dockerfile.jvm</code>: Dockerfile is used in order to build a container that runs the Quarkus application in JVM mode.</p>
</li>
<li>
<p><code>Dockerfile.legacy-jar</code>: Deprecated Dockerfile building a container in JVM mode.</p>
</li>
<li>
<p><code>Dockerfile.native</code>: Dockerfile is used in order to build a container that runs the Quarkus application in native (no JVM) mode.</p>
</li>
<li>
<p><code>Dockerfile.native-micro</code>: Same as above but it uses a micro base image, tuned for Quarkus native executables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quarkus is able to build a container image automatically.
It proposes multiple approaches to do so, but we recommend using <a href="https://github.com/GoogleContainerTools/jib">jib</a>.
As you have guessed by now, using jib is as simple as adding a Quarkus extension to each project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_containers_for_our_microservices_in_jvm_mode">Building Containers for our Microservices in JVM Mode</h3>
<div class="paragraph">
<p>The <code>Dockerfile.jvm</code> file is for running the application in JVM mode.
It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">FROM registry.access.redhat.com/ubi8/openjdk-17:1.18

ENV LANGUAGE='en_US:en'


# We make four distinct layers so if there are application changes the library layers can be re-used
COPY --chown=185 target/quarkus-app/lib/ /deployments/lib/
COPY --chown=185 target/quarkus-app/*.jar /deployments/
COPY --chown=185 target/quarkus-app/app/ /deployments/app/
COPY --chown=185 target/quarkus-app/quarkus/ /deployments/quarkus/

EXPOSE 8080
USER 185
ENV JAVA_OPTS_APPEND=&quot;-Dquarkus.http.host=0.0.0.0 -Djava.util.logging.manager=org.jboss.logmanager.LogManager&quot;
ENV JAVA_APP_JAR=&quot;/deployments/quarkus-run.jar&quot;

ENTRYPOINT [ &quot;/opt/jboss/container/java/run/run-java.sh&quot; ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>To start using it, we first need to install the jib extension in all our projects.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Add the <code>quarkus-container-image-jib</code> extension executing the following commands from the root <code>super-heroes</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw --file rest-fights/pom.xml quarkus:add-extension -Dextensions=&quot;jib&quot;
./mvnw --file rest-heroes/pom.xml quarkus:add-extension -Dextensions=&quot;jib&quot;
./mvnw --file rest-villains/pom.xml quarkus:add-extension -Dextensions=&quot;jib&quot;
./mvnw --file ui-super-heroes/pom.xml quarkus:add-extension -Dextensions=&quot;jib&quot;
./mvnw --file rest-narration/pom.xml quarkus:add-extension -Dextensions=&quot;jib&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It adds the following dependency to the <code>pom.xml</code> files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>quarkus-container-image-jib<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Then, from the root <code>super-heroes</code> directory, execute the following commands to build the applications and create the container image (add <code>-Dmaven.test.skip=true</code> if you want to skip the tests):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw --file rest-fights/pom.xml clean package -Dquarkus.container-image.build=true
./mvnw --file rest-heroes/pom.xml clean package -Dquarkus.container-image.build=true
./mvnw --file rest-villains/pom.xml clean package -Dquarkus.container-image.build=true
./mvnw --file ui-super-heroes/pom.xml clean package -Dquarkus.container-image.build=true
./mvnw --file rest-narration/pom.xml clean package -Dquarkus.container-image.build=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that you have all the Docker images installed locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker image ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">REPOSITORY                      TAG                  IMAGE ID       SIZE
&lt;org&gt;/rest-fights             1.0.0-SNAPSHOT       adb8a546a66b   419MB
&lt;org&gt;/rest-heroes             1.0.0-SNAPSHOT       d9e6ae6e3e23   402MB
&lt;org&gt;/rest-villains           1.0.0-SNAPSHOT       60a5c813f59a   402MB
&lt;org&gt;/ui-super-heroes         1.0.0-SNAPSHOT       82fce62c11a5   379MB
&lt;org&gt;/rest-narration          1.0.0-SNAPSHOT       fcfe334594f3   390MB</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_jvm_mode_containers_locally">Running JVM Mode Containers Locally</h3>
<div class="paragraph">
<p>Now that we have all our Docker images created, let&#8217;s execute them all to be sure that everything is working.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Under <code>super-heroes/infrastructure</code> you will find the <code>docker-compose-app-local.yaml</code> file.
It declares all the needed infrastructure (databases, Kafka) as well as our microservices.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the <code>docker-compose-app-local.yaml</code> file, you need to update the <code>image</code> property of each microservice to match the name of the image you just built.
For example, replace <code>quarkus/rest-villains</code> by <code>&lt;org&gt;/rest-villains</code> (&lt;`org`&gt; being your DockerHub / Quay.io username).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Execute it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose-app-local.yaml up</code></pre>
</div>
</div>
<div class="paragraph">
<p>To know that all your containers are started, you can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose-app-local.yaml ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get something similar to the following list.
Make sure all your containers are in <em>running</em> status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">NAME               IMAGE                                         STATUS         PORTS
ui-super-heroes    agoncal&lt;org/ui-super-heroes:1.0.0-SNAPSHOT    Up             0.0.0.0:8080-&gt;8080/tcp
rest-fights        agoncal&lt;org/rest-fights:1.0.0-SNAPSHOT        Up             0.0.0.0:8082-&gt;8082/tcp
rest-heroes        agoncal&lt;org/rest-heroes:1.0.0-SNAPSHOT        Up             0.0.0.0:8083-&gt;8083/tcp
rest-villains      agoncal&lt;org/rest-villains:1.0.0-SNAPSHOT      Up             0.0.0.0:8084-&gt;8084/tcp
rest-narration     agoncal&lt;org/rest-narration:1.0.0-SNAPSHOT     Up             0.0.0.0:8086-&gt;8086/tcp
super-database     postgres:14                                   Up (healthy)   0.0.0.0:5432-&gt;5432/tcp
super-kafka        quay.io/strimzi/kafka:0.28.0-kafka-3.1.0      Up             0.0.0.0:9092-&gt;9092/tcp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all the containers are started, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> to check the main UI</p>
</li>
<li>
<p>Go to <a href="http://localhost:8085" class="bare">http://localhost:8085</a> to check the statistics UI</p>
</li>
<li>
<p>curl <a href="http://localhost:8084/api/villains" class="bare">http://localhost:8084/api/villains</a> | jq</p>
</li>
<li>
<p>curl <a href="http://localhost:8083/api/heroes" class="bare">http://localhost:8083/api/heroes</a> | jq</p>
</li>
<li>
<p>curl <a href="http://localhost:8082/api/fights/randomfighters" class="bare">http://localhost:8082/api/fights/randomfighters</a> | jq</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, make sure you shut down the entire application with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose-app-local.yaml down</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_containers_for_our_microservices_in_native_mode">Building Containers for our Microservices in Native Mode</h3>
<div class="paragraph">
<p>And&#8230;&#8203; Linux Containers are &#8230;&#8203; <em>Linux</em>.
So before being able to build a container with our native executable, we need to produce compatible native executables.
If you are using a Linux 64 bits machine, you are good to go.
If not, Quarkus comes with a trick to produce these executable:</p>
</div>
<div class="paragraph">
<p>The <code>Dockerfile.native</code> file is for running the application in native mode.
It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">FROM registry.access.redhat.com/ubi8/ubi-minimal:8.9
WORKDIR /work/
RUN chown 1001 /work \
    &amp;&amp; chmod &quot;g+rwX&quot; /work \
    &amp;&amp; chown 1001:root /work
COPY --chown=1001:root target/*-runner /work/application

EXPOSE 8080
USER 1001

ENTRYPOINT [&quot;./application&quot;, &quot;-Dquarkus.http.host=0.0.0.0&quot;]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw clean package -Pnative -Dquarkus.native.container-build=true -DskipTests</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-Dquarkus.native.container-build=true</code> allows running the native compilation inside a container (provided by Quarkus).
The result is a Linux 64 bits executable.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Building a native executable takes time, CPU, and memory.
It&#8217;s even more accurate in the container.
So, first, be sure that your container system has enough memory to build the executable.
It requires at least 6Gb of memory, 8Gb is recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Execute the above command for all our microservices.
We also copy the UI into the fight service, to simplify the process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">cd rest-hero
./mvnw clean package -Pnative -Dquarkus.native.container-build=true -DskipTests
cd ..
cd rest-villains
./mvnw clean package -Pnative -Dquarkus.native.container-build=true -DskipTests
cd ..
cd rest-fight
cp -R ../ui-super-heroes/dist/* src/main/resources/META-INF/resources
./mvnw clean package -Pnative -Dquarkus.native.container-build=true -DskipTests
cd ..
cd event-statistics
./mvnw clean package -Pnative -Dquarkus.native.container-build=true -DskipTests
cd ..</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_native_containers">Building native containers</h3>
<div class="paragraph">
<p>Now that we have the native executables, we can build containers.
When you create projects, Quarkus generates two <code>Dockerfiles</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Dockerfile.jvm</code> - A <code>Dockerfile</code> for running the application in JVM mode</p>
</li>
<li>
<p><code>Dockerfile.native</code> - A <code>Dockerfile</code> for running the application in native mode</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We are interested in this second file.
Open one of these <code>Dockerfile.native</code> files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">FROM registry.access.redhat.com/ubi8/ubi-minimal
WORKDIR /work/
COPY target/*-runner /work/application
RUN chmod 775 /work
EXPOSE 8080
CMD [&quot;./application&quot;, &quot;-Dquarkus.http.host=0.0.0.0&quot;]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a pretty straightforward <code>Dockerfile</code> taking a minimal base image and copying the generated native executable.
It also exposes the port 8080.
Wait, our microservices are not configured to run on the port 8080.
We need to override this property as well as a few other such as the HTTP client endpoints, and database locations.</p>
</div>
<div class="paragraph">
<p>To build the containers, use the following scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">export ORG=xxxx
cd rest-hero
docker build -f src/main/docker/Dockerfile.native -t $ORG/quarkus-workshop-hero .
cd ..
cd rest-villains
docker build -f src/main/docker/Dockerfile.native -t $ORG/quarkus-workshop-villain .
cd ..
cd rest-fight
docker build -f src/main/docker/Dockerfile.native -t $ORG/quarkus-workshop-fight .
cd ..
cd event-statistics
docker build -f src/main/docker/Dockerfile.native -t $ORG/quarkus-workshop-stats .
cd ..</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Replace <code>ORG</code> with your DockerHub / Quay.io username.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_running_native_mode_containers_locally">Running Native Mode Containers Locally</h3>

</div>
<div class="sect2">
<h3 id="_building_a_container_running_a_native_executable">Building a container running a native executable</h3>
<div class="paragraph">
<p>We&#8217;ve just created a container that embeds the Java application and a JVM.
But you can also build and use the native executable.
To do this, runs the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw clean package -Dquarkus.container-image.build=true -Pnative -Dquarkus.native.container-build=true</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-Dquarkus.native.container-build=true</code> is indicating that we need a Linux 64bits executable.
This option is not required if you use Linux.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes">Deploying with Kubernetes</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>This chapter explores how you can deploy containerized Quarkus applications in Cloud platforms using Kubernetes.
There are many different approaches to achieve these deployments.
In this chapter, we are focusing on deploying our containers in Kubernetes.</p>
</div>
<div class="sect2">
<h3 id="_deploying_on_kubernetes">Deploying on Kubernetes</h3>
<div class="paragraph">
<p>This section is going to deploy our microservices on Kubernetes.
It is required to have access to a Kubernetes or OpenShift cluster.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To deploy your microservices, push the built container images to an image registry accessible by your cluster, such as Quay.io or DockerHub.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We recommend using a specific namespace to deploy your system.
In the following sections, we use the <code>quarkus-workshop</code> namespace.</p>
</div>
<div class="sect3">
<h4 id="_deploying_the_infrastructure">Deploying the infrastructure</h4>
<div class="paragraph">
<p>The first thing to deploy is the required infrastructure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>3 PostgreSQL instances</p>
</li>
<li>
<p>Kafka brokers (3 brokers with 3 Zookeeper to follow the recommended approach)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many ways to deploy this infrastructure.
Here, we are going to use two operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PostgreSQL Operator by Dev4Ddevs.com</p>
</li>
<li>
<p>Strimzi Apache Kafka Operator by Red Hat</p>
</li>
</ul>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>With these operators installed, you can create the required infrastructure with the following custom resource definition (CRD):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">postgresql.dev4devs.com/v1alpha1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Database</span></span>
<span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">heroes-database</span></span>
    <span class="key">namespace</span>: <span class="string"><span class="content">quarkus-workshop</span></span>
<span class="key">spec</span>:
    <span class="key">databaseCpu</span>: <span class="string"><span class="content">30m</span></span>
    <span class="key">databaseCpuLimit</span>: <span class="string"><span class="content">60m</span></span>
    <span class="key">databaseMemoryLimit</span>: <span class="string"><span class="content">512Mi</span></span>
    <span class="key">databaseMemoryRequest</span>: <span class="string"><span class="content">128Mi</span></span>
    <span class="key">databaseName</span>: <span class="string"><span class="content">heroes-database</span></span>
    <span class="key">databaseNameKeyEnvVar</span>: <span class="string"><span class="content">POSTGRESQL_DATABASE</span></span>
    <span class="key">databasePassword</span>: <span class="string"><span class="content">superman</span></span>
    <span class="key">databasePasswordKeyEnvVar</span>: <span class="string"><span class="content">POSTGRESQL_PASSWORD</span></span>
    <span class="key">databaseStorageRequest</span>: <span class="string"><span class="content">1Gi</span></span>
    <span class="key">databaseUser</span>: <span class="string"><span class="content">superman</span></span>
    <span class="key">databaseUserKeyEnvVar</span>: <span class="string"><span class="content">POSTGRESQL_USER</span></span>
    <span class="key">image</span>: <span class="string"><span class="content">centos/postgresql-96-centos7</span></span>
    <span class="key">size</span>: <span class="string"><span class="content">1</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>This CRD creates the database for the Hero microservice.
Duplicate this CRD for the fight and villain databases.</p>
</div>
<div class="paragraph">
<p>For the Kafka broker, create the following CRD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">kafka.strimzi.io/v1beta1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Kafka</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">my-kafka</span></span>
  <span class="key">namespace</span>: <span class="string"><span class="content">quarkus-workshop</span></span>
<span class="key">spec</span>:
  <span class="key">kafka</span>:
    <span class="key">version</span>: <span class="string"><span class="content">2.3.0</span></span>
    <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
    <span class="key">listeners</span>:
      <span class="key">plain</span>: <span class="string"><span class="content">{}</span></span>
      <span class="key">tls</span>: <span class="string"><span class="content">{}</span></span>
    <span class="key">config</span>:
      <span class="key">offsets.topic.replication.factor</span>: <span class="string"><span class="content">3</span></span>
      <span class="key">transaction.state.log.replication.factor</span>: <span class="string"><span class="content">3</span></span>
      <span class="key">transaction.state.log.min.isr</span>: <span class="string"><span class="content">2</span></span>
      <span class="key">log.message.format.version</span>: <span class="string"><span class="content">'2.3'</span></span>
    <span class="key">storage</span>:
      <span class="key">type</span>: <span class="string"><span class="content">ephemeral</span></span>
  <span class="key">zookeeper</span>:
    <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
    <span class="key">storage</span>:
      <span class="key">type</span>: <span class="string"><span class="content">ephemeral</span></span>
  <span class="key">entityOperator</span>:
    <span class="key">topicOperator</span>: <span class="string"><span class="content">{}</span></span>
    <span class="key">userOperator</span>: <span class="string"><span class="content">{}</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This CRD creates the brokers and the Zookeeper instances.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also recommended to create the topic.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For this, create the following CRD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">kafka.strimzi.io/v1beta1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">KafkaTopic</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">fights</span></span>
  <span class="key">labels</span>:
    <span class="key">strimzi.io/cluster</span>: <span class="string"><span class="content">my-kafka</span></span>
  <span class="key">namespace</span>: <span class="string"><span class="content">quarkus-workshop</span></span>
<span class="key">spec</span>:
  <span class="key">partitions</span>: <span class="string"><span class="content">1</span></span>
  <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
  <span class="key">config</span>:
    <span class="key">retention.ms</span>: <span class="string"><span class="content">604800000</span></span>
    <span class="key">segment.bytes</span>: <span class="string"><span class="content">1073741824</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once everything is created, you should have the following resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ kubectl get database
NAME                AGE
fights-database     16h
heroes-database     16h
villains-database   16h

$ kubectl get kafka
NAME       DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS
my-kafka   3</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploying_the_hero_villain_microservices">Deploying the Hero &amp; Villain microservices</h4>
<div class="paragraph">
<p>Now that the infrastructure is in place, we can deploy our microservices.
Let&#8217;s start with the hero and villain microservices.</p>
</div>
<div class="paragraph">
<p>For each, we need to override the port and data source URL.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create a config map with the following content:</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. config-hero.yaml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">data</span>:
    <span class="key">port</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8080</span><span class="delimiter">&quot;</span></span>
    <span class="key">database</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:postgresql://heroes-database:5432/heroes-database</span><span class="delimiter">&quot;</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">ConfigMap</span></span>
<span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">hero-config</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Do the same for the villain microservice.
Then, apply these resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ kubectl apply -f config-hero.yaml
$ kubectl apply -f config-villain.yaml</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the config maps are created, we can deploy the microservices.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create a <code>deployment-hero.yaml</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>
<span class="key">kind</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">List</span><span class="delimiter">&quot;</span></span>
<span class="key">items</span>:
    - <span class="string"><span class="content">apiVersion: &quot;v1&quot;</span></span>
      <span class="key">kind</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Service</span><span class="delimiter">&quot;</span></span>
      <span class="key">metadata</span>:
          <span class="key">labels</span>:
              <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
              <span class="key">version</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">01</span><span class="delimiter">&quot;</span></span>
              <span class="key">group</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">$ORG</span><span class="delimiter">&quot;</span></span>
          <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
      <span class="key">spec</span>:
          <span class="key">ports</span>:
              - <span class="string"><span class="content">name: &quot;http&quot;</span></span>
                <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
                <span class="key">targetPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">selector</span>:
              <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
              <span class="key">version</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">01</span><span class="delimiter">&quot;</span></span>
              <span class="key">group</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">$ORG</span><span class="delimiter">&quot;</span></span>
          <span class="key">type</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ClusterIP</span><span class="delimiter">&quot;</span></span>
    - <span class="string"><span class="content">apiVersion: &quot;apps/v1&quot;</span></span>
      <span class="key">kind</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Deployment</span><span class="delimiter">&quot;</span></span>
      <span class="key">metadata</span>:
          <span class="key">labels</span>:
              <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
              <span class="key">version</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">01</span><span class="delimiter">&quot;</span></span>
              <span class="key">group</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">$ORG</span><span class="delimiter">&quot;</span></span>
          <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
      <span class="key">spec</span>:
          <span class="key">replicas</span>: <span class="string"><span class="content">1</span></span>
          <span class="key">selector</span>:
              <span class="key">matchLabels</span>:
                  <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
                  <span class="key">version</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">01</span><span class="delimiter">&quot;</span></span>
                  <span class="key">group</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">$ORG</span><span class="delimiter">&quot;</span></span>
          <span class="key">template</span>:
              <span class="key">metadata</span>:
                  <span class="key">labels</span>:
                      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
                      <span class="key">version</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">01</span><span class="delimiter">&quot;</span></span>
                      <span class="key">group</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">$ORG</span><span class="delimiter">&quot;</span></span>
              <span class="key">spec</span>:
                  <span class="key">containers</span>:
                      - <span class="string"><span class="content">image: &quot;$ORG/quarkus-workshop-hero:latest&quot;</span></span>
                        <span class="key">imagePullPolicy</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">IfNotPresent</span><span class="delimiter">&quot;</span></span>
                        <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">quarkus-workshop-hero</span><span class="delimiter">&quot;</span></span>
                        <span class="key">ports</span>:
                            - <span class="string"><span class="content">containerPort: 8080</span></span>
                              <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span>
                              <span class="key">protocol</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">TCP</span><span class="delimiter">&quot;</span></span>
                        <span class="key">env</span>:
                            - <span class="string"><span class="content">name: &quot;KUBERNETES_NAMESPACE&quot;</span></span>
                              <span class="key">valueFrom</span>:
                                  <span class="key">fieldRef</span>:
                                      <span class="key">fieldPath</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">metadata.namespace</span><span class="delimiter">&quot;</span></span>

                            - <span class="string"><span class="content">name: QUARKUS_DATASOURCE_URL</span></span>
                              <span class="key">valueFrom</span>:
                                  <span class="key">configMapKeyRef</span>:
                                      <span class="key">name</span>: <span class="string"><span class="content">hero-config</span></span>
                                      <span class="key">key</span>: <span class="string"><span class="content">database</span></span>

                            - <span class="string"><span class="content">name: QUARKUS_HTTP_PORT</span></span>
                              <span class="key">valueFrom</span>:
                                  <span class="key">configMapKeyRef</span>:
                                      <span class="key">name</span>: <span class="string"><span class="content">hero-config</span></span>
                                      <span class="key">key</span>: <span class="string"><span class="content">port</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This descriptor declares:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A service to expose the HTTP endpoint</p>
</li>
<li>
<p>A deployment that instantiates the application</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The deployment declares one container using the container image we built earlier.
It also overrides the configuration for the HTTP port and database URL.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Don&#8217;t forget to create the equivalent files for the villain microservice.</p>
</div>
<div class="paragraph">
<p>Then, deploy the microservice with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ kubectl apply -f deployment-hero.yaml
$ kubectl apply -f deployment-villain.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploying_the_fight_microservice">Deploying the Fight microservice</h4>
<div class="paragraph">
<p>Follow the same approach for the fight microservice.
Note that there are more properties to configure from the config map:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The location of the hero and villain microservice</p>
</li>
<li>
<p>The location of the Kafka broker</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once everything is configured and deployed, your system is now running on Kubernetes.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_from_container_to_kubernetes">From Container to Kubernetes</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This section is optional and demonstrates how to ask Quarkus to create a container and deploy it to Kubernetes.
We will need a running Kubernetes.
We will use Rancher Desktop as indicated in the prerequisites.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that Docker Desktop (if installed) is turned off</p>
</li>
<li>
<p>Make sure Rancher Desktop is started. The container runtime must be <em>dockerd</em> (Preferences &#8594; Container Runtime &#8594; dockerd (moby)).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_to_kubernetes">Deploying to Kubernetes</h3>
<div class="paragraph">
<p>Quarkus can also run our application in Kubernetes and compute the Kubernetes descriptor.
In addition to allow customizing any part of the descriptor, it is possible to configure config maps, secrets&#8230;&#8203;</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As mentioned above, we will use Rancher Desktop.
Adapt the instructions for your Kubernetes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you are logged in</p>
</li>
<li>
<p>Make sure you use the correct namespace</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Edit the <code>src/main/resources/application.properties</code> to add the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.kubernetes.namespace=default # Added
quarkus.kubernetes.image-pull-policy=IfNotPresent # Added

%prod.quarkus.http.port=8080 # Added
%prod.quarkus.datasource.username=superbad
%prod.quarkus.datasource.password=superbad
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://my-villains-db-postgresql:5432/villains_database # Updated
%prod.quarkus.hibernate-orm.sql-load-script=import.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the <code>quarkus-kubernetes</code> extension using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:add-extension -Dextensions=&quot;kubernetes&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are behind a proxy, check the <a href="https://quarkus.io/guides/extension-registry-user#how-to-register-as-a-nexus-repository-proxy">Quarkus Registry</a> proxy documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, you can add the following dependency to the <code>pom.xml</code> file directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.quarkus<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>quarkus-kubernetes<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rancher Desktop authentication use elliptic algorithms not supported by default in Java.
So, we also need to add the following dependency to the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.bouncycastle<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>bcpkix-jdk18on<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.71<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before deploying our application, we need to deploy the database.
To achieve this, we are going to use <a href="https://helm.sh/">helm</a> (installed alongside Rancher Desktop) and the following <a href="https://artifacthub.io/packages/helm/bitnami/postgresql">postgresql package</a>.</p>
</div>
<div class="paragraph">
<p>Run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">helm repo add bitnami https://charts.bitnami.com/bitnami
helm install my-villains-db \
    --set auth.postgresPassword=superbad \
    --set auth.username=superbad \
    --set auth.password=superbad \
    --set auth.database=villains_database bitnami/postgresql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, deploy the application using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw clean package -Dquarkus.kubernetes.deploy=true -DskipTests</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the pods with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">kubectl get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">NAME                             READY   STATUS    RESTARTS   AGE
my-villains-db-postgresql-0      1/1     Running   0          28m
rest-villains-7c7479b959-7fn64   1/1     Running   0          12m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure you wait for the <code>rest-villains</code> pod to be ready (1/1).</p>
</div>
<div class="paragraph">
<p>Enable port-forwarding to port 8080 either from the rancher desktop UI (Preferences &#8594; Port Forwarding &#8594; default / rest-villains / http), or using the following command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">kubectl port-forward pods/rest-villains-7c7479b959-7fn64 8080:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can access the application from your browser using: <a href="http://localhost:8080/api/villains" class="bare">http://localhost:8080/api/villains</a></p>
</div>
</div>
<div class="sect2">
<h3 id="cloud-open-shift">Deploying to Open Shift</h3>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extension">Writing a Quarkus Extension</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>Most of the Quarkus magic happens inside extensions.
The goal of an extension is to compute <em>just enough bytecode</em> to start the services that the application requires and drop everything else.</p>
</div>
<div class="paragraph">
<p>So, when writing an extension, you need to distinguish the action that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can be done at build time - following the build time principle of Quarkus</p>
</li>
<li>
<p>Must be done at runtime</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because of this distinction, extensions are divided into two parts: a build time augmentation and a runtime.
The augmentation part is responsible for all the metadata processing, annotation scanning, XML parsing&#8230;&#8203;
The output of this augmentation is <strong>recorded bytecode</strong>, which, then, is executed at runtime to instantiate the relevant services.</p>
</div>
<div class="paragraph">
<p>In this chapter, you are going to implement a <em>version</em> extension.
It prints the version of the application in the log of the application when this application starts.
It is a straightforward application, but it highlights the distinction between build time and runtime.
Instead of extracting the version at runtime and printing it, we find the version at build time and record the print instruction to when the application starts it prints the version.</p>
</div>
<div class="sect2">
<h3 id="_the_extension_framework">The extension framework</h3>
<div class="paragraph">
<p>Quarkus&#8217;s mission is to transform your entire application, including the libraries it uses, into an artifact that uses significantly fewer resources than traditional approaches.
These can then be used to build JVM applications and native executables using the GraalVM <code>native-image</code> compiler.</p>
</div>
<div class="paragraph">
<p>To do this, you need to analyze and understand the application&#8217;s "closed world".
Without the full context, the best that can be achieved is partial and limited generic support.</p>
</div>
<div class="paragraph">
<p>To build an extension, Quarkus provides a framework to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the configuration from the <code>application.properties</code> file and map it to objects,</p>
</li>
<li>
<p>Read metadata from classes without having to load them; this includes classpath and annotation scanning,</p>
</li>
<li>
<p>Generate bytecode if needed (for proxies, for instance),</p>
</li>
<li>
<p>Pass sensible defaults to the application,</p>
</li>
<li>
<p>Make the application compatible with GraalVM (resources, reflection, substitutions),</p>
</li>
<li>
<p>Implement hot-reload</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_structure_of_an_extension">Structure of an extension</h3>
<div class="paragraph">
<p>As stated above, an extension is divided into two parts, called <code>deployment</code> (augmentation) and <code>runtime</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../images/diag-plantuml-md5-4e825d66545eadc52b91865807198517.png" alt="Diagram" width="2943" height="528">
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>From the directory <code>super-heroes</code> execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw io.quarkus.platform:quarkus-maven-plugin:3.6.0:create-extension -N \
    -DplatformVersion=3.6.0 \
    -DwithoutTests \
    -DextensionId=extension-version \
    -DgroupId=io.quarkus.workshop.super-heroes \
    -DpackageName=io.quarkus.workshop.superheroes.version</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This command creates the structure for the version extension:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One parent <code>pom.xml</code> importing the <code>quarkus-bom</code></p>
</li>
<li>
<p>A module for the runtime</p>
</li>
<li>
<p>A module for the deployment, with a dependency on the runtime artifact</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The final structure of the extension developed in this section is the following:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../images/diag-plantuml-md5-230c605b98a1015e5e299dd60751d48d.png" alt="Diagram" width="322" height="429">
</div>
</div>
<div class="paragraph">
<p>If you want your IDE to manage this new Maven project, you can declare it in the parent POM by adding this new module in the <code>&lt;modules&gt;</code> section</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;module&gt;</span>super-heroes/extension-version<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_version_extension">The version extension</h3>
<div class="paragraph">
<p>The goal of this chapter is to implement an extension that displays the application version on startup.
For this, what do we need:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A way to extract the version (we&#8217;re lucky, Quarkus provided it)</p>
</li>
<li>
<p>Some code that would print the version when the application starts; so some runtime code,</p>
</li>
<li>
<p>Some build steps that extracts the version and records the runtime invocations</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_the_runtime_module">The runtime module</h3>
<div class="paragraph">
<p>The <em>runtime</em> part of an extension contains only the classes and resources required at runtime.
For the version extension, it would be a single class that prints the version.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>In the runtime module, create the <code>src/main/java</code> directory, and, in this directory, the <code>io.quarkus.workshop.superheroes.version.runtime.VersionRecorder</code> class with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.version.runtime</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.runtime.annotations.Recorder</span>;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;

<span class="annotation">@Recorder</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VersionRecorder</span> {

    <span class="directive">public</span> <span class="type">void</span> printVersion(<span class="predefined-type">String</span> version) {
        <span class="predefined-type">Logger</span>.getLogger(VersionRecorder.class.getName()).infof(<span class="string"><span class="delimiter">&quot;</span><span class="content">Version: %s</span><span class="delimiter">&quot;</span></span>, version);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Simple right?
But how does it work?
Look at the <code>@Recorder</code> annotation.
It indicates that this class is a <em>recorder</em> used to record actions executed later at runtime.
Indeed, these actions are replayed at runtime.
We will see how this recorder is used from the <em>deployment</em> module.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_deployment_module">The deployment module</h3>
<div class="paragraph">
<p>This module contains <em>build steps</em>, i.e., methods called during the augmentation phase and computing just enough bytecode to serve the services the application requires.
The version extension consists of a single build step that extracts the version and uses the <code>VersionRecorder</code>.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, let&#8217;s create the configuration class that will allow users to dynamically configure whether the version should be printed:</p>
</div>
<div class="paragraph">
<p>Under the <code>deployment</code> module, create new class <code>io.quarkus.workshop.superheroes.version.deployment.VersionConfig</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.version.deployment</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.runtime.annotations.ConfigItem</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.runtime.annotations.ConfigRoot</span>;

<span class="annotation">@ConfigRoot</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VersionConfig</span> {

    <span class="comment">/**
     * Enables or disables the version printing at startup.
     */</span>
    <span class="annotation">@ConfigItem</span>(defaultValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>)
    <span class="type">boolean</span> enabled;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@ConfigRoot</code> annotation declares <code>VersionConfig</code> as a configuration class which configuration properties are prefixed with <code>quarkus.</code> prefix.</p>
</div>
<div class="paragraph">
<p>The <code>@ConfigItem</code> is used to declare individual configuration properties. By default, the name of the property is derived from the name of the field. In our case, the user-configured property will be <code>quarkus.version.enabled</code>.</p>
</div>
<div class="paragraph">
<p>Next, open the <code>ExtensionVersionProcessor</code> class, and update the content to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.quarkus.workshop.superheroes.version.deployment</span>;

<span class="keyword">import</span> <span class="include">io.quarkus.deployment.annotations.BuildStep</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.deployment.annotations.ExecutionTime</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.deployment.annotations.Record</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.deployment.builditem.ApplicationInfoBuildItem</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.deployment.builditem.FeatureBuildItem</span>;
<span class="keyword">import</span> <span class="include">io.quarkus.workshop.superheroes.version.runtime.VersionRecorder</span>;

<span class="type">class</span> <span class="class">ExtensionVersionProcessor</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> FEATURE = <span class="string"><span class="delimiter">&quot;</span><span class="content">extension-version</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@BuildStep</span>
    FeatureBuildItem feature() {
        <span class="keyword">return</span> <span class="keyword">new</span> FeatureBuildItem(FEATURE);
    }

    <span class="annotation">@BuildStep</span>
    <span class="annotation">@Record</span>(ExecutionTime.RUNTIME_INIT)
    <span class="type">void</span> recordVersion(ApplicationInfoBuildItem app, VersionConfig versionConfig, VersionRecorder recorder) {
        <span class="keyword">if</span> (versionConfig.enabled) {
            recorder.printVersion(app.getVersion());
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class is the core of the extension.
It contains a set of methods annotated with <code>@BuildStep</code>.</p>
</div>
<div class="paragraph">
<p>The command generated the first one we used to set up the project.
It just produces a <code>FeatureBuildItem</code>.
When the application starts, Quarkus lists the enabled features.
So, when this extension is present, <code>extension-version</code> will be printed.</p>
</div>
<div class="paragraph">
<p>The <code>recordVersion</code> method is responsible for recording the actions that will happen at runtime.
In addition to the <code>@BuildStep</code> annotation, it also has the <code>@Record</code> annotation allowing to receive a <em>recorder</em> object (<code>VersionRecorder</code>) and indicating when the recorded bytecode is replayed.
Here we are replaying during the runtime initialization, <em>i.e.,</em> equivalent to the <code>public static void main(String&#8230;&#8203; args)</code> method.</p>
</div>
<div class="paragraph">
<p>The method also receives the <code>ApplicationInfoBuildItem</code>.
Quarkus provides many <em>build items</em> which can be reused.
<code>ApplicationInfoBuildItem</code> contains the version.</p>
</div>
<div class="paragraph">
<p>The second parameter of the <code>recordVersion</code> method is the <code>VersionConfig</code> which provides access to the user configuration we created in the previous step.</p>
</div>
<div class="paragraph">
<p>The code is straightforward: if <code>enabled</code> is <code>true</code>, the code calls the recorder which prints the version.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Recorder at deployment time</div>
<div class="paragraph">
<p>At deployment time, proxies of recorders are injected into <code>@BuildStep</code> methods that have been annotated with <code>@Record</code>.
Any invocations made on these proxies will be recorded, and bytecode will be written out to be executed at runtime to make the same sequence of invocations with the same parameters on the actual recorder objects.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_packaging_the_extension">Packaging the extension</h3>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>From the root directory of the extension, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw clean install</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_extension">Using the extension</h3>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Go back to the <em>villain</em> microservice, and add the following dependency to the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.quarkus.workshop.super-heroes<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>extension-version<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If not yet started, start the microservice with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw quarkus:dev</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the version will be displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">10:16:58 INFO  [io.qu.wo.su.ve.ru.VersionRecorder] (Quarkus Main Thread) Version: 1.0.0-SNAPSHOT
...
10:17:00 INFO  [io.quarkus] (Quarkus Main Thread) Installed features: [agroal, cdi, extension-version, hibernate-orm, hibernate-orm-panache, hibernate-validator, jdbc-postgresql, narayana-jta, resteasy-reactive, resteasy-reactive-jackson, smallrye-context-propagation, smallrye-health, smallrye-openapi, swagger-ui, vertx]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this section, you have seen how to develop a simple extension for Quarkus.
Quarkus offers a complete toolbox to implement extensions, from configuration support, tests, bytecode generation&#8230;&#8203;
The mindset to implement an extension is crucial.
The distinction between build time and runtime is what makes Quarkus so efficient.
To go further, check <a href="https://quarkus.io/guides/extension-authors-guide" class="bare">https://quarkus.io/guides/extension-authors-guide</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>This is the end of the Super Hero workshop.
We hope you liked it, learnt a few things, and more importantly, will be able to take this knowledge back to your projects.</p>
</div>
<div class="paragraph">
<p>This workshop started making sure your development environment was ready to develop the entire application.
Then, there was some brief terminology to help you in understanding some concepts around Quarkus.
If you find it was too short and need more details on Quarkus, Microservices, MicroProfile, Cloud Native, or GraalVM, check the Quarkus website for more references.<sup class="footnote">[<a id="_footnoteref_21" class="footnote" href="#_footnotedef_21" title="View footnote.">21</a>]</sup></p>
</div>
<div class="paragraph">
<p>Then, we focused on developing several isolated microservices.
Some written in pure JAX-RS (such as the Villain) others with Reactive JAX-RS and Reactive Hibernate (such as the Hero).
These microservices return data in JSON, validate data thanks to Bean Validation, store and retrieve data from a relational database with the help of JPA, Panache and JTA.</p>
</div>
<div class="paragraph">
<p>You then installed an already coded React application on another instance of Quarkus.
At this stage, the React application couldn&#8217;t access the microservices because of CORS issues that we quickly fixed.</p>
</div>
<div class="paragraph">
<p>Then, we made the microservices communicate with each other in HTTP thanks to REST Client.
But HTTP-related technologies usually use synchronous communication and therefore need to deal with invocation failure.
With Fault Tolerance, it was just a matter of using a few annotations and we can get some fallback when the communication fails.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve also added some Artificial Intelligence.
Thanks to Semantic Kernel, with a few lines of code, we allowed our Narration microservice to narrate the fight between a Super Hero and a Super Villain.</p>
</div>
<div class="paragraph">
<p>Then, came production time.
With Quarkus it&#8217;s very easy to build executable JARs.
With a JVM installed you can execute these JARs which are optimal for production.
And if you need to turn your microservice into an executable binary (thanks to GraalVM), that&#8217;s easy too.
Quarkus supports GraalVM since the beginning and makes its integration smooth.
Same if you want to package microservices into Docker containers.
Quarkus supports Jib.
So with a simple Maven command you can turn your microservice into a container.</p>
</div>
<div class="paragraph">
<p>Remember that you can find all the code for this fascicle at <a href="https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes" class="bare">https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes</a>.
If some parts were not clear enough, or if you found something missing, a bug, or you just want to leave a note or suggestion, please use the GitHub issue tracker at <a href="https://github.com/quarkusio/quarkus-workshops/issues" class="bare">https://github.com/quarkusio/quarkus-workshops/issues</a>.</p>
</div>
<div class="sect2">
<h3 id="conclusion-references">References</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://quarkus.io/quarkus-workshops/super-heroes" class="bare">https://quarkus.io/quarkus-workshops/super-heroes</a></p>
</li>
<li>
<p><a href="https://github.com/cescoffier/quarkus-todo-app" class="bare">https://github.com/cescoffier/quarkus-todo-app</a></p>
</li>
<li>
<p><a href="https://github.com/agoncal/baking-microservice-pie" class="bare">https://github.com/agoncal/baking-microservice-pie</a></p>
</li>
<li>
<p><a href="https://forge.jboss.org/document/hands-on-lab" class="bare">https://forge.jboss.org/document/hands-on-lab</a></p>
</li>
<li>
<p><a href="https://bit.ly/forge-hol" class="bare">https://bit.ly/forge-hol</a></p>
</li>
<li>
<p><a href="https://quarkus.io" class="bare">https://quarkus.io</a></p>
</li>
<li>
<p><a href="https://code.quarkus.io" class="bare">https://code.quarkus.io</a></p>
</li>
<li>
<p><a href="https://quarkus.io/guides/all-config" class="bare">https://quarkus.io/guides/all-config</a></p>
</li>
<li>
<p><a href="https://azure.microsoft.com/services/container-apps">Azure Container Apps Overview</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/azure/container-apps">Azure Container Apps Documentation</a></p>
</li>
<li>
<p><a href="https://github.com/ozangunalp/managed-kafka-quarkus/tree/main/azure-event-hub">Managed Kafka Quarkus</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_extra_software">Appendix A: Installing extra software</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="appendix-installing-maven">Apache Maven 3.8.x</h3>
<div class="paragraph">
<p>All the examples of this workshop are built and tested using Maven.<sup class="footnote">[<a id="_footnoteref_22" class="footnote" href="#_footnotedef_22" title="View footnote.">22</a>]</sup>
Maven offers a building solution, shared libraries, and a plugin platform for your projects, allowing you to do quality control, documentation, teamwork, and so forth.
Based on the "convention over configuration" principle, Maven brings a standard project description and a number of conventions such as a standard directory structure.
With an extensible architecture based on plugins, Maven can offer many different services.</p>
</div>
<div class="sect3">
<h4 id="_installing_maven">Installing Maven</h4>
<div class="paragraph">
<p>The examples of this workshop have been developed with Apache Maven 3.8.x.
For this workshop, it is <strong>not</strong> necessary to install Maven.
You can just use the Maven wrapper in your working directory, <code>./mvnw</code>.
The wrapper is always at a suitable Maven version.</p>
</div>
<div class="paragraph">
<p>However, if you&#8217;d prefer to have a global installation of Maven (<code>mvn</code>), here&#8217;s how.
Once you have installed JDK 17, make sure the <code>JAVA_HOME</code> environment variable is set.
Then, download Maven from <a href="http://maven.apache.org/" class="bare">http://maven.apache.org/</a>, unzip the file on your hard drive and add the <code>apache-maven/bin</code> directory to your <code>PATH</code> variable.
More details about the installation process are available on <a href="https://maven.apache.org/install.html" class="bare">https://maven.apache.org/install.html</a>.</p>
</div>
<div class="paragraph">
<p>If you are on Mac OS X and use Homebrew, install Maven with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">brew install maven</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_checking_for_maven_installation">Checking for Maven Installation</h4>
<div class="paragraph">
<p>Once you&#8217;ve got Maven installed, open a command line and enter <code>mvn -version</code> to validate your installation.
Maven should print its version and the JDK version it uses (which is handy as you might have different JDK versions installed on the same machine).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ mvn -version
Apache Maven 3.8.4 (ea98e05a04480131370aa0c110b8c54cf726c06f)
Maven home: /usr/local/Cellar/maven/3.8.4/libexec
Java version: 11.0.15, vendor: AdoptOpenJDK, runtime: /Users/clement/.sdkman/candidates/java/11.0.15.hs-adpt
Default locale: en_FR, platform encoding: UTF-8
OS name: &quot;mac os x&quot;, version: &quot;11.5&quot;, arch: &quot;x86_64&quot;, family: &quot;mac&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be aware that Maven needs Internet access to download plugins and project dependencies from the Maven Central and other remote repositories.<sup class="footnote">[<a id="_footnoteref_23" class="footnote" href="#_footnotedef_23" title="View footnote.">23</a>]</sup></p>
</div>
</div>
<div class="sect3">
<h4 id="_some_maven_commands">Some Maven Commands</h4>
<div class="paragraph">
<p>Maven is a command-line utility where you can use several parameters and options to build, test, or package your code.
To get some help on the commands, you can type, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ mvn --help

usage: mvn [options] [&lt;goal(s)&gt;] [&lt;phase(s)&gt;]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some commands that you will be using to run the examples in the workshop.
Each invokes a different phase of the project life cycle (clean, compile, install, etc.) and use the <code>pom.xml</code> to download libraries, customize the compilation, or extend some behaviors with plugins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mvn clean</code>: Deletes all generated files (compiled classes, generated code, artifacts etc.).</p>
</li>
<li>
<p><code>mvn compile</code>: Compiles the main Java classes.</p>
</li>
<li>
<p><code>mvn test-compile</code>: Compiles the test classes.</p>
</li>
<li>
<p><code>mvn test</code>: Compiles the main Java classes as well as the test classes and executes the tests.</p>
</li>
<li>
<p><code>mvn package</code>: Compiles, executes the tests, and packages the code into an archive.</p>
</li>
<li>
<p><code>mvn install</code>: Builds and installs the artifacts in your local repository.</p>
</li>
<li>
<p><code>mvn clean install</code>: Cleans and installs (note that you can add several commands separated by a space, like <code>mvn clean compile test</code>).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="appendix-installing-curl">cURL</h3>
<div class="paragraph">
<p>To invoke the REST Web Services described in this workshop, we often use cURL.<sup class="footnote">[<a id="_footnoteref_24" class="footnote" href="#_footnotedef_24" title="View footnote.">24</a>]</sup>
cURL is a command-line tool and library to do reliable data transfers with various protocols, including HTTP.
It is free, open-source (available under the MIT Licence), and has been ported to several operating systems.
If your operating system does not already include cURL (most do), here is how to install it.</p>
</div>
<div class="sect3">
<h4 id="_installing_curl">Installing cURL</h4>
<div class="paragraph">
<p>If you are on Mac OS X and have installed Homebrew, then installing cURL is just a matter of a single command.<sup class="footnote">[<a id="_footnoteref_25" class="footnote" href="#_footnotedef_25" title="View footnote.">25</a>]</sup>
Open your terminal and install cURL with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">brew install curl</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Windows, download and install curl from <a href="https://curl.se/download.html" class="bare">https://curl.se/download.html</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_for_curl_installation">Checking for cURL Installation</h4>
<div class="paragraph">
<p>Once installed, check for cURL by running <code>curl --version</code> in the terminal.
It should display cURL version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ curl --version
curl 7.64.1 (x86_64-apple-darwin20.0) libcurl/7.64.1 (SecureTransport) LibreSSL/2.8.3 zlib/1.2.11 nghttp2/1.41.0
Release-Date: 2019-03-27
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtsp smb smbs smtp smtps telnet tftp
Features: AsynchDNS GSS-API HTTP2 HTTPS-proxy IPv6 Kerberos Largefile libz MultiSSL NTLM NTLM_WB SPNEGO SSL UnixSockets</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_some_curl_commands">Some cURL Commands</h4>
<div class="paragraph">
<p>cURL is a command-line utility where you can use several parameters and options to invoke URLs.
You invoke <code>curl</code> with zero, one, or several command-line options to accompany the URL (or set of URLs) you want the transfer to be about.
cURL supports over two hundred different options, and I would recommend reading the documentation for more help.<sup class="footnote">[<a id="_footnoteref_26" class="footnote" href="#_footnotedef_26" title="View footnote.">26</a>]</sup>
To get some help on the commands and options, you can type, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ curl --help

Usage: curl [options...] &lt;url&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also opt to use <code>curl --manual</code>, which will output the entire man page for cURL plus an appended tutorial for the most common use cases.</p>
</div>
<div class="paragraph">
<p>Here are some commands you will use to invoke the RESTful web service examples in this workshop.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>curl <a href="http://localhost:8083/api/heroes/hello" class="bare">http://localhost:8083/api/heroes/hello</a></code>: HTTP GET on a given URL.</p>
</li>
<li>
<p><code>curl -X GET <a href="http://localhost:8083/api/heroes/hello" class="bare">http://localhost:8083/api/heroes/hello</a></code>: Same effect as the previous command, an HTTP GET on a given URL.</p>
</li>
<li>
<p><code>curl -v <a href="http://localhost:8083/api/heroes/hello" class="bare">http://localhost:8083/api/heroes/hello</a></code>: HTTP GET on a given URL with verbose mode on.</p>
</li>
<li>
<p><code>curl -H 'Content-Type: application/json' <a href="http://localhost:8083/api/heroes/hello" class="bare">http://localhost:8083/api/heroes/hello</a></code>: HTTP GET on a given URL passing the JSON Content Type in the HTTP Header.</p>
</li>
<li>
<p><code>curl -X DELETE <a href="http://localhost:8083/api/heroes/1" class="bare">http://localhost:8083/api/heroes/1</a></code>: HTTP DELETE on a given URL.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="appendix-preparing-warming-caches">Warming the caches</h3>
<div class="paragraph">
<p>This workshop needs internet access to download all sorts of Maven artifacts, Docker images, and even pictures.
Some of these artifacts are large, and because we have to share internet connexions at the workshop, it is better to download them before the workshop.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re getting ready for a workshop, you might find it helpful to pre-download some Docker images.
This can save strain on shared bandwidth. If, however, you&#8217;re already attending a workshop, don&#8217;t
worry about warming anything up.</p>
</div>
<div class="sect3">
<h4 id="_warming_up_maven">Warming up Maven</h4>
<div class="sect4">
<h5 id="_download_the_workshop_scaffolding_2">Download the workshop scaffolding</h5>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, download the zip file  <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip" class="bare">https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip</a>, and unzip it wherever you want.
This zip file contains <em>some</em> of the code of the workshop, and you will need to complete it.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_download_the_maven_dependencies">Download the Maven dependencies</h5>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now that you have the initial structure in place, navigate to the root directory and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">./mvnw clean install</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By running this command, it downloads all the required dependencies.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-preparing-warming-docker">Warming up Docker images</h4>
<div class="paragraph">
<p>To warm up your Docker image repository, navigate to the <code>quarkus-workshop-super-heroes/super-heroes/infrastructure</code> directory.
Here, you will find a
<code>docker-compose.yaml</code>
 or
<code>docker-compose-linux.yaml</code>
file which defines all the needed Docker images.
Notice that there is a <code>db-init</code> directory with an <code>initialize-databases.sql</code> script which sets up our databases, and a <code>monitoring</code> directory (all that will be explained later).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Then execute the following command which will download all the Docker images and start the containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose.yaml up -d</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Linux Users beware</div>
<div class="paragraph">
<p>If you are on Linux, use <code>docker-compose-linux.yaml</code> instead of <code>docker-compose.yaml</code>. This Linux specific file will allow Prometheus to fetch metrics from the services running on the host machine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have an issue creating the roles for the database with the <code>initialize-databases.sql</code> file, you have to execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker exec -it --user postgres super-database psql -c &quot;CREATE ROLE superman LOGIN PASSWORD 'superman' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION&quot;
docker exec -it --user postgres super-database psql -c &quot;CREATE ROLE superbad LOGIN PASSWORD 'superbad' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION&quot;
docker exec -it --user postgres super-database psql -c &quot;CREATE ROLE superfight LOGIN PASSWORD 'superfight' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION&quot;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After this, verify the containers are running using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose.yaml ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should resemble something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">     Name                   Command               State           Ports
--------------------------------------------------------------------------------
kafka            sh -c bin/kafka-server-sta ...   Up      0.0.0.0:9092-&gt;9092/tcp
super-database   docker-entrypoint.sh postgres    Up      0.0.0.0:5432-&gt;5432/tcp
super-visor      /bin/prometheus --config.f ...   Up      0.0.0.0:9090-&gt;9090/tcp
zookeeper        sh -c bin/zookeeper-server ...   Up      0.0.0.0:2181-&gt;2181/tcp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all the containers are up and running, you can shut them down and remove their volumes with the commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">docker compose -f docker-compose.yaml down
docker compose -f docker-compose.yaml rm</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<div class="title">What&#8217;s this infra?</div>
<p>Any microservice system is going to rely on a set of technical services.
In our context, we are going to use PostgreSQL as the database, Prometheus as the monitoring tool, and Kafka as the event/message bus.
This infrastructure starts all these services, so you don&#8217;t have to worry about them.</p>
</div>
<div class="paragraph">
<p>This infra will only be used when we run our services in <em>prod</em> mode. In <em>dev</em> mode, Quarkus will start everything for us.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Java <a href="http://www.oracle.com/technetwork/java/javase" class="bare">http://www.oracle.com/technetwork/java/javase</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Visual VM <a href="https://visualvm.github.io" class="bare">https://visualvm.github.io</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. SDKMAN! <a href="https://sdkman.io" class="bare">https://sdkman.io</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. Docker commands <a href="https://docs.docker.com/engine/reference/commandline/cli" class="bare">https://docs.docker.com/engine/reference/commandline/cli</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. jq <a href="https://stedolan.github.io/jq" class="bare">https://stedolan.github.io/jq</a>
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. GraalVM <a href="https://www.graalvm.org" class="bare">https://www.graalvm.org</a>
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. RESTEasy Reactive support the reactive and imperative development models.
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. RestAssured <a href="http://rest-assured.io" class="bare">http://rest-assured.io</a>
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. Panache <a href="https://quarkus.io/guides/hibernate-orm-panache" class="bare">https://quarkus.io/guides/hibernate-orm-panache</a>
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. ArC <a href="https://github.com/quarkusio/quarkus/tree/master/independent-projects/arc" class="bare">https://github.com/quarkusio/quarkus/tree/master/independent-projects/arc</a>
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. Quarkus - Contexts and Dependency Injection <a href="https://quarkus.io/guides/cdi-reference.html" class="bare">https://quarkus.io/guides/cdi-reference.html</a>
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. Agroal <a href="https://agroal.github.io" class="bare">https://agroal.github.io</a>
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. Microprofile Config <a href="https://microprofile.io/project/eclipse/microprofile-config" class="bare">https://microprofile.io/project/eclipse/microprofile-config</a>
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. MicroProfile OpenAPI <a href="https://github.com/eclipse/microprofile-open-api" class="bare">https://github.com/eclipse/microprofile-open-api</a>
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. Also called Ahead-of-Time Compilation <a href="https://www.graalvm.org/docs/reference-manual/native-image" class="bare">https://www.graalvm.org/docs/reference-manual/native-image</a>
</div>
<div class="footnote" id="_footnotedef_16">
<a href="#_footnoteref_16">16</a>. There is another structure <code>Multi</code> to represent asynchronous streams of items. We will see <code>Multi</code> examples later
</div>
<div class="footnote" id="_footnotedef_17">
<a href="#_footnoteref_17">17</a>. CORS <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" class="bare">https://en.wikipedia.org/wiki/Cross-origin_resource_sharing</a>
</div>
<div class="footnote" id="_footnotedef_18">
<a href="#_footnoteref_18">18</a>. MicroProfile REST Client <a href="https://github.com/eclipse/microprofile-rest-client" class="bare">https://github.com/eclipse/microprofile-rest-client</a>
</div>
<div class="footnote" id="_footnotedef_19">
<a href="#_footnoteref_19">19</a>. Alternatives <a href="https://docs.jboss.org/weld/reference/latest/en-US/html/specialization.html#_using_alternative_stereotypes" class="bare">https://docs.jboss.org/weld/reference/latest/en-US/html/specialization.html#_using_alternative_stereotypes</a>
</div>
<div class="footnote" id="_footnotedef_20">
<a href="#_footnoteref_20">20</a>. MicroProfile Fault Tolerance <a href="https://github.com/eclipse/microprofile-fault-tolerance" class="bare">https://github.com/eclipse/microprofile-fault-tolerance</a>
</div>
<div class="footnote" id="_footnotedef_21">
<a href="#_footnoteref_21">21</a>. Quarkus <a href="https://quarkus.io" class="bare">https://quarkus.io</a>
</div>
<div class="footnote" id="_footnotedef_22">
<a href="#_footnoteref_22">22</a>. Maven <a href="https://maven.apache.org" class="bare">https://maven.apache.org</a>
</div>
<div class="footnote" id="_footnotedef_23">
<a href="#_footnoteref_23">23</a>. Maven Central <a href="https://search.maven.org" class="bare">https://search.maven.org</a>
</div>
<div class="footnote" id="_footnotedef_24">
<a href="#_footnoteref_24">24</a>. cURL <a href="https://curl.haxx.se" class="bare">https://curl.haxx.se</a>
</div>
<div class="footnote" id="_footnotedef_25">
<a href="#_footnoteref_25">25</a>. Homebrew <a href="https://brew.sh" class="bare">https://brew.sh</a>
</div>
<div class="footnote" id="_footnotedef_26">
<a href="#_footnoteref_26">26</a>. cURL commands <a href="https://ec.haxx.se/cmdline.html" class="bare">https://ec.haxx.se/cmdline.html</a>
</div>
</div>
<footer>
    <div>Last updated 2024-07-17</div>
    <div><i class="far fa-comments"></i>Need help? Join the <a
        href="https://quarkusio.zulipchat.com/#narrow/stream/402952-workshops">
        Zulip workshop chat</a>
    </div>
</footer>
</body>
</html>